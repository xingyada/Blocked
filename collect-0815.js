//中国区
window._pt_lt = new Date().getTime();
window._pt_sp_2 = [];
_pt_sp_2.push('setAccount,3c8a67ba');
_pt_sp_2.push('setDomain,xingyada.github.io,adamking8.github.io,gitee.io,http://111.com');
_pt_sp_2.push('setTrackEvent,,,0708-Tag-a,0,false,^https:\\/\\/xingyada\\.github\\.io/Blocked/1cn\\.html$,%23sqsy,1562570504157319,');
_pt_sp_2.push('setTrackEvent,,,0708,0,false,^https?:\\/\\/(?:[^\\.]+\\.)*?github\\.io(?:/|\\?|$).*$,%23sqsy%20%3E%20p%3Anth-child(2),1562569864289678,');
_pt_sp_2.push('setTrackEvent,,,0619B手动改库中文,0,false,^https?:\\/\\/(?:[^\\.]+\\.)*?github\\.io(?:/|\\?|$).*$,%23uaInfo,1560916509956012,');
_pt_sp_2.push('setTrackEvent,,,0619A%E4%B8%AD%E6%96%87,0,false,^https?:\\/\\/(?:[^\\.]+\\.)*?github\\.io(?:/|\\?|$).*$,%23uaInfo,1560916491661985,');
_pt_sp_2.push('setTrackEvent,,,0619-%E8%BF%99%E6%98%AF%E4%B8%AA%E9%82%AE%E4%BB%B6,0,false,^https?:\\/\\/(?:[^\\.]+\\.)*?github\\.io(?:/|\\?|$).*$,%23mail,1560912658901817,');
_pt_sp_2.push('setTrackEvent,,,这是个图片,0,false,^https?:\\/\\/(?:[^\\.]+\\.)*?github\\.io(?:/|\\?|$).*$,body%20%3E%20img%3Anth-child(1),1560852695346703,');
_pt_sp_2.push('setTrackEvent,,,%E8%BF%99%E6%98%AF%E5%9B%BE%E7%89%87,0,false,^https:\\/\\/xingyada\\.github\\.io/Blocked/1cn\\.html$,body%20%3E%20a%3Anth-child(3)%20%3E%20img%3Anth-child(1),1560852450114971,');
_pt_sp_2.push('setTrackEvent,,,0617test,0,false,^https:\\/\\/xingyada\\.github\\.io/Blocked/1cn\\.html\\?utm_source=facebook&utm_medium=cpc&utm_campaign=fb&ut%20m_term=test3_text1_image8$,body%20%3E%20a%3Anth-child(3)%20%3E%20img%3Anth-child(1),1560737042007501,');
_pt_sp_2.push('setTrackEvent,,,AllSite,0,false,^https?:\\/\\/(?:[^\\.]+\\.)*?github\\.io(?:/|\\?|$).*$,%23selected%20%3E%20a%3Anth-child(1),1560249683165160,');
_pt_sp_2.push('setTrackEvent,,,sameclass333333,0,false,^https:\\/\\/xingyada\\.github\\.io/Blocked/1cn\\.html$,body%20%3E%20ul%3Anth-child(5)%20%3E%20li%3Anth-child(1)%20.sameclass,1559636841106286,');
_pt_sp_2.push('setTrackEvent,,,sameClass,0,false,^https:\\/\\/xingyada\\.github\\.io/Blocked/1cn\\.html$,body%20%3E%20ul%3Anth-child(5)%20%3E%20li%3Anth-child(1)%20%3E%20a%3Anth-child(1),1559635910454427,');
_pt_sp_2.push('setTrackEvent,,,%E5%90%8C%E4%B8%80%E9%93%BE%E6%8E%A5,0,false,^https:\\/\\/xingyada\\.github\\.io/Blocked/1cn\\.html$,body%20%3E%20a%3Anth-child(3),1559634125703149,');
_pt_sp_2.push('setTrackEvent,,,%E5%85%A8%E9%A1%B5%E9%9D%A2%E5%8C%B9%E9%85%8D,0,false,^https:\\/\\/xingyada\\.github\\.io/Blocked/1cn\\.html$,img,1559633905364419,');
_pt_sp_2.push('setTrackEvent,,,SameTag,0,false,^https:\\/\\/xingyada\\.github\\.io/Blocked/1cn\\.html$,body%20%3E%20a%3Anth-child(3)%20%3E%20img%3Anth-child(1),1559633568724514,');
_pt_sp_2.push('setTrackEvent,,,name3,0,false,^https:\\/\\/xingyada\\.github\\.io/Blocked$,%23content%20%3E%20div%3Anth-child(1)%20%3E%20div%3Anth-child(1),1553338278827460,');
_pt_sp_2.push('setTrackEvent,,,name2,0,false,^https:\\/\\/xingyada\\.github\\.io/Blocked$,%23control-selected,1553338265259052,');
_pt_sp_2.push('setTrackEvent,,,name1,0,false,^https:\\/\\/xingyada\\.github\\.io/Blocked$,%23content%20%3E%20div%3Anth-child(1)%20%3E%20div%3Anth-child(1),1553338253406356,');
_pt_sp_2.push('setTrackEvent,,,nav,0,false,^https?:\\/\\/(?:[^\\.]+\\.)*?github\\.io(?:/|\\?|$).*$,body%20%3E%20div%3Anth-child(4)%20%3E%20nav%3Anth-child(3),1542859163956742,');
_pt_sp_2.push('setTrackEvent,,,Vision,0,false,^https:\\/\\/xingyada\\.github\\.io/Blocked/about-us\\.html$,%23content-with-menu%20%3E%20ul%3Anth-child(2)%20%3E%20li%3Anth-child(3),1536833037319718,');
_pt_sp_2.push('setTrackEvent,,,readMore,0,false,^https:\\/\\/xingyada\\.github\\.io/Blocked$,%23content-more%20%3E%20article%3Anth-child(2)%20%3E%20footer%3Anth-child(3)%20%3E%20a%3Anth-child(2),1536832903682931,');
_pt_sp_2.push('setTrackEvent,,,SERVICE,0,false,^https:\\/\\/xingyada\\.github\\.io/Blocked/portfolio\\.html$,%23header%20%3E%20nav%3Anth-child(2)%20%3E%20ul%3Anth-child(1)%20%3E%20li%3Anth-child(4)%20%3E%20a%3Anth-child(1),1536832205429435,');
_pt_sp_2.push('setTrackEvent,,,BLOG,0,false,^https:\\/\\/xingyada\\.github\\.io/Blocked$,body%20%3E%20div%3Anth-child(4)%20%3E%20nav%3Anth-child(3)%20%3E%20ul%3Anth-child(1)%20%3E%20li%3Anth-child(5)%20%3E%20a%3Anth-child(1),1536832061918364,');
_pt_sp_2.push('setTrackEvent,,,about-us-PORTFOLIO,0,false,^https:\\/\\/xingyada\\.github\\.io/Blocked/about-us\\.html$,%23header%20%3E%20nav%3Anth-child(2)%20%3E%20ul%3Anth-child(1)%20%3E%20li%3Anth-child(3)%20%3E%20a%3Anth-child(1),1536831539321938,');
_pt_sp_2.push('setTrackEvent,,,BLOG,0,false,^https:\\/\\/xingyada\\.github\\.io/Blocked$,body%20%3E%20div%3Anth-child(4)%20%3E%20nav%3Anth-child(3)%20%3E%20ul%3Anth-child(1)%20%3E%20li%3Anth-child(5)%20%3E%20a%3Anth-child(1),1536831262654506,');
_pt_sp_2.push('setTrackEvent,,,pttest2,0,false,^https:\\/\\/xingyada\\.github\\.io/Blocked$,%23banner%20%3E%20div%3Anth-child(6)%20%3E%20div%3Anth-child(1)%20%3E%20h2%3Anth-child(3)%20%3E%20a%3Anth-child(1),1536831238220812,');
_pt_sp_2.push('setTrackEvent,,,BLOG,0,false,^https:\\/\\/xingyada\\.github\\.io/Blocked$,body%20%3E%20div%3Anth-child(4)%20%3E%20nav%3Anth-child(3)%20%3E%20ul%3Anth-child(1)%20%3E%20li%3Anth-child(5)%20%3E%20a%3Anth-child(1),1536830421584617,');
_pt_sp_2.push('setTrackEvent,,,PROTFOLIO,0,false,^https:\\/\\/xingyada\\.github\\.io/Blocked$,body%20%3E%20div%3Anth-child(4)%20%3E%20nav%3Anth-child(3)%20%3E%20ul%3Anth-child(1)%20%3E%20li%3Anth-child(3)%20%3E%20a%3Anth-child(1),1536824867234702,');
_pt_sp_2.push('setTrackEvent,,,FEATURES,0,false,^https:\\/\\/xingyada\\.github\\.io/Blocked$,body%20%3E%20div%3Anth-child(4)%20%3E%20nav%3Anth-child(3)%20%3E%20ul%3Anth-child(1)%20%3E%20li%3Anth-child(2)%20%3E%20a%3Anth-child(1),1536824844801859,');
_pt_sp_2.push('setTrackEvent,,,%E6%90%9C%E7%B4%A2%E6%A1%86,0,false,^https:\\/\\/xingyada\\.github\\.io/Blocked$,body%20%3E%20div%3Anth-child(2)%20%3E%20input%3Anth-child(3),1524797611842593,');
_pt_sp_2.push('setTrackEvent,,,%E5%A4%A7div,0,false,^https:\\/\\/xingyada\\.github\\.io/Blocked$,body%20%3E%20div%3Anth-child(2),1524795574203263,');
_pt_sp_2.push('setTrackEvent,,,%E5%85%8D%E8%B4%B9%E9%80%9A%E8%AF%9D,0,false,^https:\\/\\/xingyada\\.github\\.io/Blocked$,body%20%3E%20div%3Anth-child(2)%20%3E%20input%3Anth-child(1),1524794610319893,');
_pt_sp_2.push('setTrackEvent,,,%E7%94%B5%E8%AF%9D%E6%8C%89%E9%92%AE,0,false,^https:\\/\\/xingyada\\.github\\.io/Blocked$,%23phone,1517307587736681,');
_pt_sp_2.push('setTrackEvent,,,%E6%8C%89%E9%92%AEhome,0,false,^https?:\\/\\/(?:[^\\.]+\\.)*?github\\.io(?:/|\\?|$).*$,%23selected%20%3E%20a%3Anth-child(1),1515057044664476,8cf04a9734132302f96da8e113e80ce5');
_pt_sp_2.push('setCamParam,utm_name,utm_ref,utm_source');
_pt_sp_2.push('setServer,0');
_pt_sp_2.push('setEventReport,true');/*event open*/ 
_pt_sp_2.push('setEngageEnabled,1');

(function(undefined) {
    if (!window["edc7uo"]) {    // 热图开启状态，-1：全开启；[]：数组内页面开启；
        window["edc7uo"] = -1;
    }
	

    var version ='v1.64.9';     // 跟随当前sprint
    //判断DNT标识
    
    if (navigator.doNotTrack && navigator.doNotTrack == 1) {
        return ;
    }
    

    // 报文传输用URL设定
    // var serverList = ["cjtest.ptmind.cn", "cjtest.ptmind.cn"];
    //var serverList = ["testcollect.ptengine.jp", "testcollect.ptengine.jp"];
    // var userURL = "engagebindtest.ptmind.cn/account_bind";
    //线上环境配置
    var userURL = "engagebind.ptengine.jp/account_bind";
    var serverList = ["collect.ptengine.jp", "collect01.ptengine.jp"];
    //staging 环境配置
    // var userURL = "stagingengagebind.ptmind.com/account_bind";
    // var serverList = ["stagingcollect.ptmind.com", "stagingcollect.ptmind.com"];
    var serverNum = 0;  // 报文传输URL索引，默认使用第一个地址
    var protocol = ("https:" == location.protocol) ? "https://" : "http://",    // 协议类型
        toURL = protocol + serverList[serverNum],
        pnURL = toURL + "/pn", // 处理页面新访问的URL
        pvURL = toURL + "/pv", // 处理页面非新访问的URL
        ocURL = toURL + "/oc", // 处理点击事件的URL
        osURL = toURL + "/os", // 处理滚动事件的URL
        hbURL = toURL + "/hb", // 处理心跳事件的URL
        teURL = toURL + "/te", // 处理用户自定义事件
        ecURL = toURL + "/ec"; //电子商务发送地址
        userURL = protocol + userURL;
    // cookies操作用
    var domainName = "", expiresDay = 1000;     // cookie中的域名及过期时间
    // 静态值
    //COOKIELENGTH = 3800;迁移到了createCookiesValue函数中，因为只有那一个函数用到
    var NVTIMES = 1000 * 60 * 3, // 距离最近的站点活动时间的最长时限为180秒，超过180秒便为新访次
        NATIVEDAYS = 1000 * 60 * 60 * 24, // 一天（暂未使用）
        HBTIMES = 1000 * 30, // 心跳时间
        SILENTTIMES = 1000 * 60 * 5, // 静默时间，超过该时间则访次结束
        CLICKINTERVAL = 3000, // 点击间隔时间
        SCROLLINTERVAL = 1000, // 滚动间隔时间
        DEFAULTSTAYTIMES = 1000, // 激活后的默认时间
        REFRESHTIMES = 1000 * 60 * 1, // 刷新默认时间
		
		
		/**
		//事件名称最大长度，目前
			中国区60(双字节字符如中日文，一个按两个计算)
			日本区40(按长度)
		*/
        EVENTNAME_MAX_LENGTH = 40; //事件名称最大长度
		
    // 布码参数
    var company = "",       // 公司名称
        enableOutIframe = false,
        enableEngage = false,
        PageViewVar=null,//pv 自定义变量
        ECCache = [],//缓存用户电商数据
        UserCache = [],//用户信息
        CustomVarCache=[],//自定义变量数据
        URLTrimFlag = true, //保存真实URL，true去掉URL后面的斜杠"/",false不去掉URL后面的斜杠"/"
        crossDomainLink = false, //跨域手动标识，allManual为全手动，halfManual为半手动，false为自动
        funnelPage = false, //CV漏斗页面
        funnelRef = "", // CV漏斗ref值
        domainSet = [], // 多域名集
        multiDomainFlag = false, // 是否设置了多域监测
        urlMark = "", // url特殊标志
        vUrl = "", // 虚拟URL
        vTitle = "", // 虚拟title
        adParamFlag = false, //cellant广告参数专用的标志
        adParamStr = "", //cellant广告参数专用的字符串
        adParamAry = [], // cellant广告参数
        camParamAry = [],//广告参数，通用功能的，没有跟过去的cellant的混合在一起
        ignoreCampaign = false,//是否忽略广告(utm)参数
        PT_trackEvent = false;//是否开启自定义事件
    // 自定义参数分析
    var sid = "", // 网站账号名
        uid = "", // 唯一用户ID
        useHttpCookie = true,   // 是否使用页面cookie
        customVarList = [],//自定义变量列表
        autoEventList = {},//智能事件开关
        iframeValue = [0, 0, ""],	//iframe的相关值数组，iframe元素的left，top和cssPath
        gParam = window["_pt_sp_2"] ? "_pt_sp_2" : "_pt_pe";    // 布码变量，这里主要是兼容旧版本的变量名

    //事件开个标签,判定 url 中是否含有这个字符串,标记打开设置事件功能
    var openEventLabel = "ptengine-event-explore=open";
    var engagePreviewTokenKey = 'preview_token';
    var formElementTriggerEventType='focus';//form 元素触发event的条件。默认是focus。在windows下的ie是click
    //异步自定义事件列表
    var asyncEventList = [];
    var testSID = { // 测试sid
        "39a47d27": "31aee115", // test
        "1568e5d4": "4d304c7a",
        "1a8c08b0": "31aee115", // test
        "6f1b18fd": "4d304c7a"
    };

      //  json2.js
      (function () {
        "use strict";

        if (typeof JSON !== "object") {
            JSON = {};
        } else {
            return;
        }

        var rx_one = /^[\],:{}\s]*$/;
        var rx_two = /\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g;
        var rx_three = /"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g;
        var rx_four = /(?:^|:|,)(?:\s*\[)+/g;
        var rx_escapable = /[\\"\u0000-\u001f\u007f-\u009f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g;
        var rx_dangerous = /[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g;

        function f(n) {
            // Format integers to have at least two digits.
            return (n < 10) ? "0" + n : n;
        }

        function this_value() {
            return this.valueOf();
        }

        if (typeof Date.prototype.toJSON !== "function") {

            Date.prototype.toJSON = function () {

                return isFinite(this.valueOf()) ?
                    (
                        this.getUTCFullYear() +
                        "-" +
                        f(this.getUTCMonth() + 1) +
                        "-" +
                        f(this.getUTCDate()) +
                        "T" +
                        f(this.getUTCHours()) +
                        ":" +
                        f(this.getUTCMinutes()) +
                        ":" +
                        f(this.getUTCSeconds()) +
                        "Z") :
                    null;
            };

            Boolean.prototype.toJSON = this_value;
            Number.prototype.toJSON = this_value;
            String.prototype.toJSON = this_value;
        }

        var gap;
        var indent;
        var meta;
        var rep;

        function quote(string) {

            // If the string contains no control characters, no quote characters, and no
            // backslash characters, then we can safely slap some quotes around it.
            // Otherwise we must also replace the offending characters with safe escape
            // sequences.

            rx_escapable.lastIndex = 0;
            return rx_escapable.test(string) ?
                "\"" + string.replace(rx_escapable, function (a) {
                    var c = meta[a];
                    return typeof c === "string" ?
                        c :
                        "\\u" + ("0000" + a.charCodeAt(0).toString(16)).slice(-4);
                }) + "\"" : "\"" + string + "\"";
        }

        function str(key, holder) {

            // Produce a string from holder[key].

            var i; // The loop counter.
            var k; // The member key.
            var v; // The member value.
            var length;
            var mind = gap;
            var partial;
            var value = holder[key];

            // If the value has a toJSON method, call it to obtain a replacement value.

            if (
                value &&
                typeof value === "object" &&
                typeof value.toJSON === "function") {
                value = value.toJSON(key);
            }

            // If we were called with a replacer function, then call the replacer to
            // obtain a replacement value.

            if (typeof rep === "function") {
                value = rep.call(holder, key, value);
            }

            // What happens next depends on the value's type.

            switch (typeof value) {
                case "string":
                    return quote(value);

                case "number":

                    // JSON numbers must be finite. Encode non-finite numbers as null.

                    return (isFinite(value)) ? String(value) : "null";

                case "boolean":
                case "null":

                    // If the value is a boolean or null, convert it to a string. Note:
                    // typeof null does not produce "null". The case is included here in
                    // the remote chance that this gets fixed someday.

                    return String(value);

                    // If the type is "object", we might be dealing with an object or an array or
                    // null.

                case "object":

                    // Due to a specification blunder in ECMAScript, typeof null is "object",
                    // so watch out for that case.

                    if (!value) {
                        return "null";
                    }

                    // Make an array to hold the partial results of stringifying this object value.

                    gap += indent;
                    partial = [];

                    // Is the value an array?

                    if (Object.prototype.toString.apply(value) === "[object Array]") {

                        // The value is an array. Stringify every element. Use null as a placeholder
                        // for non-JSON values.

                        length = value.length;
                        for (i = 0; i < length; i += 1) {
                            partial[i] = str(i, value) || "null";
                        }

                        // Join all of the elements together, separated with commas, and wrap them in
                        // brackets.

                        v = partial.length === 0 ?
                            "[]" :
                            gap ?
                            (
                                "[\n" +
                                gap +
                                partial.join(",\n" + gap) +
                                "\n" +
                                mind +
                                "]") :
                            "[" + partial.join(",") + "]";
                        gap = mind;
                        return v;
                    }

                    // If the replacer is an array, use it to select the members to be stringified.

                    if (rep && typeof rep === "object") {
                        length = rep.length;
                        for (i = 0; i < length; i += 1) {
                            if (typeof rep[i] === "string") {
                                k = rep[i];
                                v = str(k, value);
                                if (v) {
                                    partial.push(quote(k) + ((gap) ? ": " : ":") + v);
                                }
                            }
                        }
                    } else {

                        // Otherwise, iterate through all of the keys in the object.

                        for (k in value) {
                            if (Object.prototype.hasOwnProperty.call(value, k)) {
                                v = str(k, value);
                                if (v) {
                                    partial.push(quote(k) + ((gap) ? ": " : ":") + v);
                                }
                            }
                        }
                    }

                    // Join all of the member texts together, separated with commas,
                    // and wrap them in braces.

                    v = partial.length === 0 ?
                        "{}" :
                        gap ?
                        "{\n" + gap + partial.join(",\n" + gap) + "\n" + mind + "}" :
                        "{" + partial.join(",") + "}";
                    gap = mind;
                    return v;
            }
        }

        // If the JSON object does not yet have a stringify method, give it one.

        if (typeof JSON.stringify !== "function") {
            meta = { // table of character substitutions
                "\b": "\\b",
                "\t": "\\t",
                "\n": "\\n",
                "\f": "\\f",
                "\r": "\\r",
                "\"": "\\\"",
                "\\": "\\\\"
            };
            JSON.stringify = function (value, replacer, space) {

                // The stringify method takes a value and an optional replacer, and an optional
                // space parameter, and returns a JSON text. The replacer can be a function
                // that can replace values, or an array of strings that will select the keys.
                // A default replacer method can be provided. Use of the space parameter can
                // produce text that is more easily readable.

                var i;
                gap = "";
                indent = "";

                // If the space parameter is a number, make an indent string containing that
                // many spaces.

                if (typeof space === "number") {
                    for (i = 0; i < space; i += 1) {
                        indent += " ";
                    }

                    // If the space parameter is a string, it will be used as the indent string.

                } else if (typeof space === "string") {
                    indent = space;
                }

                // If there is a replacer, it must be a function or an array.
                // Otherwise, throw an error.

                rep = replacer;
                if (replacer && typeof replacer !== "function" && (
                        typeof replacer !== "object" ||
                        typeof replacer.length !== "number")) {
                    throw new Error("JSON.stringify");
                }

                // Make a fake root object containing our value under the key of "".
                // Return the result of stringifying the value.

                return str("", {
                    "": value
                });
            };
        }

    }());
	
 
    if (!window[gParam] || (window[gParam].join("").indexOf("setAccount") < 0 && window[gParam].join("").indexOf("setSID") < 0) || window[gParam].join("").indexOf("setDomain") < 0) {
        //console.log("ptmind_debug:  "+"Custom parameter is incorrect");
        return; // 自定义参数不正确，不进行采集
    } else {
        // 修正初始布码的setPVTag为setVPV
        for(var i = 0; i < window[gParam].length; i++){
            if(/setpvtag/i.test(window[gParam][i])){
                window[gParam][i] = window[gParam][i].replace(/setpvtag/i, "setVPV");
            }
        }
        if (!definePrc(window[gParam])) { //如果自定义参数解析失败，则不进行采集
            //console.log("ptmind_debug:  "+"Failed to parse custom parameters");
            return;
        }
    }

       /*变量定义*/
    // 类对象定义
    var ptq = "", // 参数串
        na =enableOutIframe ? window.top.navigator : navigator,
        doc =enableOutIframe ? window.top.document : document,
        win =enableOutIframe ? window.top : window,
        loc =enableOutIframe ? window.top.location : location,
        objBrowserInfo = new CLSBrowserInfo, // 浏览器信息类对象
        objCommon = new CLSCommon, // 通用类对象
        cookieOfPt = new CookieOfPt,// cookie相关
        objHttpCookies = new CLSCookies, // http cookies类对象
        objPt = new CLSPt, // Pt专用类对象
        //系统信息
        ref = objBrowserInfo.getRef(), // 获取页面ref
        initialScale = objBrowserInfo.getInitialScale(),    // 获取页面初始缩放值
        terminalType = objBrowserInfo.getTerminalType() + '', // 判断终端类型 0:不可识别 1:手机 2:PC 3:PC模拟的手机 4:平板
        rotationFlag = ((win.orientation == undefined || win.orientation == 0) ? 1 : -1), // 横屏标志 (竖直:0 左斜:90 右斜:-90) 竖屏时为1，横屏时为-1
        // 访次相关信息
        isNV = "0", // 新访次
        visitID = "", // 访次事件ID
        visitNum = 0, // 访次顺序
        pvNum = 0, // pv的顺序
        profileID = sid + "_/", // profileID
        date = new Date(),
        visitTimeDate = date.getTime() + "-" + date.getDate(), // 访问时间和日期
        visitRef = "", // 访次ref信息，创建pn时写入到cookie里，pv从cookie里读取，跨域时需要带过去
        // 用户信息
        isNID = "0", // 是否新用户
        // 页面相关信息
        page = "",  //当前页面URL
        initPage = "",//page的初始值，默认情况下等同于page，但是由于加了vpv功能，page会被重写，所以保留一个初始的page的值，用来记录
        pageID = "",    //页面ID
        title = objBrowserInfo.getTitle(), // 页面标题
        pvEventID = "", // 页面访问事件ID
        pageList = "", // 访次访问的页面列表
        // cookie相关信息
        hasHttpCookies = objHttpCookies.isEnabled(), // http cookies是否可用
        sessionCookiesValue = "", // session cookies值
        // 浏览事件
        mouseCoo = "", // 点击坐标
        srcElement = "", // 点击元素
        srcElementAbsLeft = 0, // 元素坐标
        srcElementAbsTop = 0, // 元素坐标
        yMax = objBrowserInfo.getYMax(), // 取得阅读线的绝对值
        yMaxP = (rotationFlag == 1) ? yMax : 0, //竖屏时阅读线位置
        yMaxM = (rotationFlag != 1) ? yMax : 0, //横屏时阅读线位置
        hbCount = 0, // 心跳包计数
        // 更新时间
        visitTime = date.getTime(), // 访问时间
        pageAccessTime, // 页面访问开始时间
        siteActionTime, // 全站最近操作时间
        pageActionTime, // 本页最近操作时间
        clickActionTime, // 记录点击的时间
        // 标志位
        multiLinkTag = "", // 跨域标志
        touchmoveFlag = false, // 拖动标志
        //是否开启抽样率
        sampleRate = "", // 开启后的抽样率 --dennis
        //mousemoveFlag = false, // 鼠标移动激活标志（仅适用于PC)，只有心跳包能触发它
        sessionCookieFlag = 0, // session标志位（0：关闭浏览器，1：存在，-1：http cookies不可用）
        activeFlag = true, // 页面活动标志
        toFlag = 0, // 静默超时
        heatmapFlag = false, // 是否开启热图功能的标志位
        op = "",	//AB测试参数保存
        optFlag = false,	//AB测试标志
        optType = 'Optimizely',	// AB测试类型Optimizely | OptimizelyX | GoogleOptimize | AdobeTarget | Adhoc
        openIframe = false;		//iframe布码标识

        enableOutIframe && (window.top[gParam] =  window[gParam]);//在事件设置的时候，需要拿到window对象中的_pt_sp_2 属性


    //自定义事件的冷却锁
    var trackEventToken = {
        lastTime:(new Date()).getTime()-10000,
        AddTime:function(){
            var tempNow = (new Date()).getTime();
            if(this.lastTime+1000 > tempNow){
                return false;
            }else if(tempNow - this.lastTime>10000){
                this.lastTime = tempNow-9000;
                return true;
            }else{
                this.lastTime+=1000;
                return true;
            }
        }
    };

    function getPtengineValue(){
        var reg = new RegExp("(^|#)ptengine=([^&]*)(&|$)", "i");
        var input = loc.hash.substr(1);
        
        var ret = input.match(reg);
        if(ret != null){
            return decodeURIComponent(ret[2]);
        }
        return null;
    }

    //判断是否开启弹出热图功能 在浮层热图中是search 中，在分享热图中是在hash中，排除掉hash
    if (loc.search.indexOf("ptengine=") > -1 || (getPtengineValue() && getPtengineValue().length!=32)) {
        var pro = loc.href.split("ptengine=");
        /**
         * 当前网站 的host type
         *  '0':旧版日本(新版不会生成)
         *  '1':新版日本
         *  '2':旧版海外(新版不会生成)
         *  '3':新版海外
         *  '4':日本demo(新版不会生成)
         *  '5':海外demo
         *  '6':新版日本测试
         *  '7':新版海外测试
         *  '8':新版日本预上线
         *  '9':新版海外预上线
         *  'A':新版日本开发
         *  'B':新版海外开发
         *  'a':新版中国线上
         *  'b':新版中国预上线
         *  'c':新版中国测试
         *  'd':新版中国开发
         * @private
         */
        var uArray = {
            "0": "https://report.ptengine.jp/js/popup/ptpopupheatmap.js",
            "1": "https://reportv3.ptengine.jp/components/pagescene/overlay/overlay.js",
            "2": "https://report.ptengine.com/js/popup/ptpopupheatmap.js",
            "3": "https://reportv3.ptengine.com/components/pagescene/overlay/overlay.js",
            "4": "https://demo.ptengine.jp/components/pagescene/heatmap/js/popup/ptpopupheatmap_jp.js",
            "5": "https://demo.ptengine.com/components/pagescene/heatmap/js/popup/ptpopupheatmap_en.js",
            "6": "https://devjpreport.ptmind.com/components/pagescene/overlay/overlay.js",
            "7": "https://devenreport.ptmind.com/components/pagescene/overlay/overlay.js",
            "8": "https://stagingjpreport.ptmind.com/components/pagescene/overlay/overlay.js",
            "9": "https://stagingenreport.ptmind.com/components/pagescene/overlay/overlay.js",
            "A": "http://localhost:3100/components/pagescene/overlay/overlay.js",
            "B": "http://localhost:3000/components/pagescene/overlay/overlay.js",
            "a": "https://report.ptengine.cn/components/pagescene/overlay/overlay.js",
            "b": "https://stagingcnreport.ptmind.com/components/pagescene/overlay/overlay.js",
            "c": "https://devcnreport.ptmind.com/components/pagescene/overlay/overlay.js",
            "d": "http://localhost:3200/components/pagescene/overlay/overlay.js"
        };
        var urlHead = uArray[pro[1].substring(0,1)];
        if (!urlHead) return;
        var jumpScript = doc.createElement("script");
        jumpScript.type="text/javascript";
        jumpScript.async=!0;
        jumpScript.charset = "utf-8";
        jumpScript.src = urlHead;
        doc.body.appendChild(jumpScript);
        return;
    }

    //加载previewjs
    ;(function loadEngagePreviewJs(){
        try {
            if(loc.href.indexOf(engagePreviewTokenKey) > -1){
                var protocol = ("https:" == loc.protocol) ? "https://" : "http://" 
                var script = doc.createElement('script');
                script.type = 'text/javascript';
                script.async = true;
                script.charset = 'UTF-8';
                script.src = protocol + 'pteengagejs.ptengine.jp/preview.js?v='+version;
                doc.body.appendChild(script);//插入到body的最后。不然会影响元素选择器的生成
            }
        } catch (error) {
            
        }
        
    })();

    //拉取事件文件
    (function () {
        //eventJSPath 有值 拉取
        try {
            var referrer = doc.referrer || win.name || "",
                ptDomain = localStorage["ptengineDomain"];

            //url 含有开启事件的标签 referrer 是来自 ptengine,开启事件
            if (loc.href.indexOf(openEventLabel) > -1 && /^https?:\/\/(.*\.ptengine.(com|cn|jp)|localhost).*/gim.test(referrer)) {
                //储存 domain
                localStorage["ptengineDomain"] = ptDomain = referrer.match(/https?:\/\/([^\/]+)/i)[0];
                //加载 js
                _loadJS();
            } else if (opener && ptDomain) {
                //如果 是被父页面打开的,并且有localStorage 里面有储存我们的domain, 拉取 js
                _loadJS();
            }
        }
        catch(ex){}
       

        /**
         * 加载 js
         * @private
         */
        function _loadJS(){

            //根据当前页面转换 https 或者 http
            ptDomain = ptDomain.replace(/^https?:/, loc.protocol);

            //拉取event js
            var script = doc.createElement('script');
            script.type = 'text/javascript';
            script.async = true;
			script.charset = 'UTF-8';
            script.src = ptDomain + "/components/event/foreign/dest/event.js";
            doc.body.appendChild(script);//插入到body的最后。不然会影响元素选择器的生成
        }
    })();

    if(domainName==""){ // 域名为空，不进行采集
        return;
    }
    /* cookie保存名称*/
    var COOKIESNAME = "pt_" + sid,
        SESSIONCOOKIESNAME = "pt_s_" + sid,
        CLICKCOOKIESNAME = "pt_t_" + sid,       //记录点击事件
        TECOOKIESNAME = "pt_e_" + sid,          //记录自定义事件
        VIDCOOKIESNAME = "pt_v_" + sid,         //记录用户的sid
        SOURCECOOKIESNAME = "pt_sc_" + sid;     //记录用户登录ptmind官网的来源
   
    // sid特殊对应
    switch (sid) {
        case "23279dc3":
            _pt_sp_2.push('setCustomVar,def15,svid,value,' + loc.href.split("?")[0] + ',0');
            break;
        case "19fca91d":
        case "5648a0b7":
        case "2345678":
            company = "oisix";
            break;
        case "2ab0afd3":
            company = "oisix_gochimaru";
            break;
        case "34c69a28":
            company = "oisix_hk";
            break;
        default:
            break;
    }

    //验证此终端的createID方法是否和极大多数浏览器兼容，如果不兼容，则生成的所有id都是错的（目前主要有老版本的山寨机）
    if(objCommon.createID("ptmind")!="VjjxITmt45nXMldop676zQ"){return;}
	
	// 事件级自定义变量
	function EventObject() {
		this.eventName = '';
		this.eventType = 0; //手动事件
		this.elementType = 0; //默认是非活动元素
		this.properties = [];
		
		this.errors = [	 // 不符合要求的提示信息
			/*{
				errorType: 'key',
				errorValue: 'username',
				msg: 'key username 长度过长'
			}, {
				errorType: 'key',
				errorValue: 'username',
				msg: 'fdsafasd'
			}
			*/
		];
		this.rules = {
			eventName: {	// 事件名称
				lengthLimit: function(v) {
					return v > 60;
				}
			},
			key: {			// 自定义属性
				lengthLimit: 64,
				regex: /^[a-zA-Z\d_]*$/ // 字母数字下划线
			},
			value: {
				lengthLimit: 256 // value的长度为encodeURIComponent之后的长度
			}
		};
		
	}
	EventObject.prototype = {
		constructor: EventObject,
		addProperty: function (property) {
			
			var propertyValue = function() {
                var v = property.value;
                return encodeURIComponent(typeof v == 'function' ? v.call() : v);
            }();
			
			this.properties.push({
				key: encodeURIComponent(property.key),
				type: property.type,
				value: propertyValue
			});
			
			if(this.rules.key.lengthLimit && property.key.length > this.rules.key.lengthLimit) {
				this.errors.push({
					errorType: 'key',
					errorValue:  property.key,
					msg: 'key[' +  property.key + ']length is too long'
				});
			}
			
			if(this.rules.key.regex && !this.rules.key.regex.test(property.key)) {
				this.errors.push({
					errorType: 'key',
					errorValue:  property.key,
					msg: 'value[' +  property.key + '] must match ^[a-zA-Z\d_]*$'
				});
			}
			
			if(typeof property.value == 'string') {
				
				if(this.rules.value.lengthLimit && propertyValue.length > this.rules.value.lengthLimit) {
					this.errors.push({
						errorType: 'value',
						errorValue:  property.value,
						msg: 'value[' +  decodeURIComponent(property.value) + ']length is too long'
					});
				}
				
				if(this.rules.value.regex && !this.rules.value.regex.test(property.value)) {
					this.errors.push({
						errorType: 'value',
						errorValue:  property.value,
						msg: 'value[' +  property.value + '] must match ^[a-zA-Z\d_]*$'
					});
				}
			} else if(typeof property.value == 'number') {
				
				if(property.value > 4294967294 || property.value < -4294967296) {
					this.errors.push({
						errorType: 'value',
						errorValue:  property.value,
						msg: 'value[' +  property.value + '] does not match, the type float should between -4294967296 and 4294967294, and the type int should bewteen -2147483648 and 2147483647'
					});
				}
				
				
				if(property.type == 'int' && (property.value > 2147483647 || property.value < -2147483648)) {
					this.errors.push({
						errorType: 'value',
						errorValue:  property.value,
						msg: 'value[' +  property.value + '] is [' + property.type + ']type, it should between -2147483648 and 2147483647'
					});
				}
			}
		},
		getErrorMsg: function() {
			var arr = [];
			for(var i = 0, errors = this.errors, len = errors.length; i < len; i ++) {
				arr.push(errors[i].msg);
			}
			return arr.join('\n');
		},
		getType: function() { // 获取类型
			//var floatRegex	= /^-?\d+\.\d+$/; 	// 如；12.3
			//var intRegex 	= /^-?\d+$/; 			// 如：123
			var dateRegex = /^\d{4}\-\d{2}\-\d{2}(?:\x20\d{2}:\d{2}:\d{2})?$/; // 如；2000-01-01或2000-01-01 00:00:00

			return function (v) {
				if (v === undefined) {
					if(typeof console != 'undefined') {
						console.warn('getType paramer is required!');
					}
				}
				
				if (typeof v == 'function') {
					return arguments.callee.call(this, v.call());
				}
				
				if (typeof v == 'number') {
					return v % 1 == 0 ? 'int' : 'float';
				} else if (typeof v == 'string') {
					return dateRegex.test(v) ? 'date' : 'string';
				} else if (typeof v == 'object' && v instanceof Date) {
					return 'date';
				} else {
					if(typeof console != 'undefined') {
						console.warn('unsupported type, only support 4 types:[int, float, string, date]');
					}
				}
			};
		}(),
		getCustomVarEid: function () {
			var arr = [this.eventName + ':' + this.eventType + ':' + this.elementType];
			for (var i = 0, props = this.properties, len = props.length; i < len; i++) {
				var prop = props[i];
				arr.push(prop.key + ':' + prop.type + ':' + prop.value);
			}
			return arr.join('|');
		},
		getDateFormat: function() {
			
			function getFullNum(num) {
				if((num + '').length == 1) {
					return '0' + num;
				}
				return num + '';
			}
			
			return function(date) {
				if(date instanceof Date) {
					return date.getFullYear() + '-' + getFullNum(date.getMonth() + 1) + '-' + getFullNum(date.getDate()) + ' ' + getFullNum(date.getHours()) + ':' + getFullNum(date.getMinutes()) + ':' + getFullNum(date.getSeconds());
				}
			}
		}()
	}
    
    var CustomEventsManager = function (events) {
        this.events = [];
        for (var i = 0; i < events.length; i++) {
            this.events.push(new CustomEvent(events[i]));
        }
    };
    CustomEventsManager.prototype = {
        constructor: CustomEventsManager,

        getAllErrors: function () {
            var allErrors = [];
            for (var i = 0; i < this.events.length; i++) {
                Array.prototype.push.apply(allErrors, this.events[i].getEventErrors());
            }
            return allErrors;
        },
        getCustomEventEid:function(){
            // 事件名称 + 事件类型（手动） + 元素类型（非活动元素）
            var event = this.events[0];
            var arr = [];
            if(event){
                var allErrors = this.getAllErrors();
                if (allErrors.length) {
                    for(var i = 0, len = allErrors.length; i < len; i ++) {
                        arr.push(allErrors[i].msg);
                    }
                    return arr.join('\n');
                    
                }
                var eventName = encodeURIComponent(event.eventName);
                var arr = [eventName + ':0:0'];
                for (var k in event) {
                    if(k!='eventName' && k!='pt_event_id' && event.hasOwnProperty(k) ){
                        var v = event[k],
                        type = event.getType(v),
                        value = v instanceof Date ? event.getDateFormat(v) : v;
                        if(type!=undefined){
                            arr.push(encodeURIComponent(k) + ':' + type + ':' + encodeURIComponent(value));
                        }else{
                            if(typeof console != 'undefined') {
								console.warn('unsupported type, only support 4 types:[int, float, string, date]');
							}
							return;
                        }
                       
                    }
                }
                return arr.join('|');
            } 
            
        },

        /**
        	有参数时，表示url超长，只保留错误信息，
        	参数urlLength表示实际url的长度
        */
        getStr: function (urlLength) {
            var resultArr = [];
            urlLength === undefined && Array.prototype.push.apply(resultArr, this.events);
            var allErrors = this.getAllErrors();

            if (urlLength !== undefined) {
                allErrors.push({
                    errorCode: '109',
                    errorType: 'lengthLimit',
                    errorValue: urlLength,
                    //errorEventName: '',
                    msg: 'the url length ' + urlLength + ' is too long'
                });
            }
            if (allErrors.length) {
                resultArr.push({
                    pt_error: allErrors
                });
            }
            return resultArr;
            // return JSON.stringify(resultArr);
        }
    };



    var CustomEvent = function (eOpt) {

        this.pt_event_id = this.getEventId();

        for (var k in eOpt) {
            if (eOpt.hasOwnProperty(k)) {
                var v = eOpt[k];
                v = v instanceof Date ? this.getDateFormat(v) : v;
                this[k] = v;
            }
        }
    };

    CustomEvent.prototype = {
        constructor: CustomEvent,
        rules: {
            eventName: { // 事件名称
                maxLength: 60 // 长度限制(一个汉字算两个) 101
            },
            key: { // 自定义属性
                maxLength: 64, // 长度限制 103
                regex: /^[a-zA-Z\d_]*$/ // 字母数字下划线 104
            },
            value: {
                string: {
                    maxLength: 256 // value的长度为encodeURIComponent之后的长度 105
                },
                date: { // date类型

                },
                float: { // float类型时 107
                    min: -4294967296,
                    max: 4294967294
                },
                int: { // int类型时 108
                    min: -2147483648,
                    max: 2147483647
                }
            }
        },

        getEventId: function () {

            var x = "0123456789qwertyuioplkjhgfdsazxcvbnm";
            var str = "";
            for (var i = 0; i < 32; i++) {
                str += x.charAt(Math.ceil(Math.random() * 36));
            }
            return str;
        },

        getPropsCount: function () {
            var count = 0;
            for (var k in this) { // 电商模块中是事件名属性是pt_category，非电商eventName
                if (this.hasOwnProperty(k) && k != 'eventName' && k != 'pt_category') {
                    count++;
                }
            }
            return count;
        },

        getEventErrors: function () {
            var eventErrors = [];
            for (var k in this) {
                if (this.hasOwnProperty(k)) {
                    Array.prototype.push.apply(eventErrors, this.valid(k, this[k]));
                }
            }

            var propsCount = this.getPropsCount();
            if (propsCount > 10 && !this.hasOwnProperty('pt_category')) {
                eventErrors.push({
                    errorCode: '501',
                    //errorType: '',
                    errorValue: propsCount,
                    errorEventName: this.eventName || this.pt_category, // 所属事件名
                    msg: 'The custom properties count must not more than 10'
                });
            }

            return eventErrors;
        },

        // 检测是否合法
        valid: function (key, value) {
            var propertyErrors = [];
            value = typeof value == 'function' ? value.call() : value;
            var propertyValue = encodeURIComponent(value);

            var type = this.getType(value);

            // 101 eventName超长,　非单字节字符按两个计算
            if ((key == 'eventName' || key == 'pt_category') && this.rules.eventName.maxLength && value.replace(/[^\x00-\xff]+/g, 'aa').length > this.rules.eventName.maxLength) {
                propertyErrors.push({
                    errorCode: '101',
                    errorType: 'eventName',
                    errorValue: value,
                    errorEventName: this.eventName || this.pt_category, // 所属事件名
                    msg: 'eventName[' + value + ']length is too long'
                });
            }

            // 103 key超长
            if (this.rules.key.maxLength && key.length > this.rules.key.maxLength) {
                propertyErrors.push({
                    errorCode: '103',
                    errorType: 'key',
                    errorValue: key,
                    errorEventName: this.eventName || this.pt_category, // 所属事件名
                    msg: 'key[' + key + ']length is too long'
                });
            }

            // 104 key类型不合法
            if (this.rules.key.regex && !this.rules.key.regex.test(key)) {
                propertyErrors.push({
                    errorType: 'key',
                    errorCode: '103',
                    errorValue: key,
                    errorEventName: this.eventName || this.pt_category, // 所属事件名
                    msg: 'key[' + key + '] must match ^[a-zA-Z\d_]*$'
                });
            }

            var typeValid = {
                string: function () {
                    // 105 value超长
                    if (this.rules.value.string.maxLength && propertyValue.length > this.rules.value.string.maxLength) {
                        propertyErrors.push({
                            errorType: 'value',
                            errorValue: value,
                            errorCode: '105',
                            errorEventName: this.eventName || this.pt_category, // 所属事件名
                            msg: 'value[' + decodeURIComponent(value) + ']length is too long'
                        });
                    }
                },
                int: function () {
                    // 108 int超过范围
                    if (value > this.rules.value.int.max || value < this.rules.value.int.min) {
                        propertyErrors.push({
                            errorType: 'value',
                            errorValue: value,
                            errorCode: '108',
                            errorEventName: this.eventName || this.pt_category, // 所属事件名
                            msg: 'value[' + value + '] is [' + type + ']type, it should between -2147483648 and 2147483647'
                        });
                    }
                },
                float: function () {
                    // 107 float超过范围
                    if (value > this.rules.value.float.max || value < this.rules.value.float.min) {
                        propertyErrors.push({
                            errorType: 'value',
                            errorValue: value,
                            errorCode: '107',
                            errorEventName: this.eventName || this.pt_category, // 所属事件名
                            msg: 'value[' + value + '] does not match, the type float should between -4294967296 and 4294967294, and the type int should bewteen -2147483648 and 2147483647'
                        });
                    }
                }
            }

            typeValid[type] && typeValid[type].call(this);

            return propertyErrors;
        },
        getType: function () { // 获取类型
            //var floatRegex	= /^-?\d+\.\d+$/; 	// 如；12.3
            //var intRegex 	= /^-?\d+$/; 			// 如：123
            var dateRegex = /^\d{4}\-\d{2}\-\d{2}(?:\x20\d{2}:\d{2}:\d{2})?$/; // 如；2000-01-01或2000-01-01 00:00:00

            return function (v) {
                if (v === undefined) {
                    if (typeof console != 'undefined') {
                        //console.warn('getType paramer is required!');
                    }
                }

                if (typeof v == 'function') {
                    return arguments.callee.call(this, v.call());
                }

                if (typeof v == 'number') {
                    return v % 1 == 0 ? 'int' : 'float';
                } else if (typeof v == 'string') {
                    return dateRegex.test(v) ? 'date' : 'string';
                } else if (typeof v == 'object' && v instanceof Date) {
                    return 'date';
                } else {
                    if (typeof console != 'undefined') {
                        //console.warn('unsupported type, only support 4 types:[int, float, string, date]');
                    }
                }
            };
        }(),
        getDateFormat: function () {

            function getFullNum(num) {
                if ((num + '').length == 1) {
                    return '0' + num;
                }
                return num + '';
            }

            return function (date) {
                if (date instanceof Date) {
                    return date.getFullYear() + '-' + getFullNum(date.getMonth() + 1) + '-' + getFullNum(date.getDate()) + ' ' + getFullNum(date.getHours()) + ':' + getFullNum(date.getMinutes()) + ':' + getFullNum(date.getSeconds());
                }
            }
        }()

    };
    
    function BaseStruct(sid,uid,vid,pid,peid){
        this.sid = sid;
        this.uid=uid;
        this.vid=vid;
        this.pid=pid;
        this.peid=peid;
        this.v = version;
        this.ts =  (new Date()).getTime();
    }

    BaseStruct.prototype.addPropery = function(prop,value){
        this[prop] = value;
    }

    BaseStruct.prototype.getJSONRet = function(){
        return JSON.stringify(this);
    }
    //重写了js原生的方法，把定时去拉的策略，改为了实时推的策略，因为te包需要在a标签点击的时候，进行触发，根本等不到100毫秒以后。
    window[gParam].push = function (str,config) {
        var tmpParam = str.split(",");
        switch (tmpParam[0]) {
            case "setPVTag":    // 虚拟PV
                try {
                    if (tmpParam[2] == "replace") {
                        page = tmpParam[1];
                    } else {
                        var vPVMark = tmpParam[1] ? tmpParam[1] : "";
                        page = initPage + "#" +vPVMark; // 页面
                    }
                    pageID = objCommon.createID(page); // 页面ID
                    revisitPrc("vpv",page,pageID);
                } catch (ex) {
                }
                break;
            case "setCustomEvent":// 新版手动事件
                try {
                    var eventName = config['eventName']?config['eventName']:'';
                    eventName= objCommon.trim(eventName);
                    if (PT_trackEvent == false || !eventName) {
                        return;
                    }
					
                    var eventName = encodeURIComponent(eventName.substr(0, EVENTNAME_MAX_LENGTH));
                    //var eventName = encodeURIComponent(objCommon.substringByByte(eventName, EVENTNAME_MAX_LENGTH));
                    var eventType ='0';//手动事件
                    var elementType = config['isActiveElement']?config['isActiveElement']:0;//默认是非活动元素
                    pvNum = +pvNum + 1;
                    var teData = new BaseStruct(sid,uid,visitID,pageID,pvEventID);
                    teData.addPropery("eid",eventName + ':' + eventType + ':' + elementType);
                    teData.addPropery("ptif",terminalType + '');
                    teData.addPropery("pvn",pvNum);
                    if(!objPt.sendPost(teURL,teData.getJSONRet())){
                        var sentData = "?id=" + sid + "." + uid + "." + visitID + "." + pageID + "." + pvEventID +
                        "&eid=" + eventName + ':' + eventType + ':' + elementType +
                        "&ptif=" + terminalType +
                        "&pvn=" + pvNum;
                        //发送te包
                        objPt.sendMsgByScript(teURL + sentData);
                    }
                } catch(ex){

                }
                break;
            case "setTrackEvent":   // 自定义事件
                try{
                    if(PT_trackEvent==false){
                        return;
                    }
                    if(typeof(tmpParam[6])=="string"){//判断当前页面是否符合事件设置
                        if (sid == "39073cb0" && loc.href.match(new RegExp(tmpParam[6].replace(/^\//,"").replace(/\/$/,"")))) {
                            //FB-156问题，特殊对应
                        } else if(!loc.href.replace(/\/$/,"").match(new RegExp(tmpParam[6].replace(/^\//,"").replace(/\/$/,"")))){
                            return;
                        }
                    }
                    if(typeof(tmpParam[3])=="undefined"){tmpParam[3]="";}
                    if(typeof(tmpParam[4])=="undefined"){tmpParam[4]="0";}
                    tmpParam[4] = tmpParam[4].replace(/\./g,"e"); // 因为.是采集包的分隔符，所以此处要转换成字符e
                    //对几个字段进行解码
                    for(var i=1;i<5;i++){
                        tmpParam[i] = objCommon.decode(tmpParam[i]);
                    }
                    //长度限制
                    tmpParam[1] = tmpParam[1].substr(0,200);
                    tmpParam[2] = tmpParam[2].substr(0,200);
                    tmpParam[3] = tmpParam[3].substr(0,500);
                    tmpParam[4] = tmpParam[4].substr(0,10);
                    //对几个字段进行编码
                    for(var i=1;i<5;i++){
                        tmpParam[i] = objCommon.encode(tmpParam[i]).replace(/\./g,"%2E");
                        //http://jira.ptmind.com/browse/FB-589，增加判断字段中存在（.），则进行二次替换————zhaopengjun 2015-03-24
                        if (tmpParam[i].indexOf(".") > -1) {
                            var tmpAry = tmpParam[i].split(".");
                            tmpParam[i] = tmpAry.join("%2E");
                        }
                    }
                    if(typeof(tmpParam[7])=="string"){
                        // 将通过事件界面设置的事件的元素放入事件数组里，等待元素被操作时触发
                        asyncEventList.push(tmpParam);
                    }else{
                        if(uid==""||visitID==""||pageID==""||pvEventID==""){
                            // 如果必要的字段没有的话，就返回
                            return;
                        }
                        if(!trackEventToken.AddTime()){
                            // 如果还没冷却，就不采集事件
                            return;
                        }
                        pvNum = +pvNum + 1;
                        cookieOfPt.writeCookies();
                        var teData = new BaseStruct(sid,uid,visitID,pageID,pvEventID);
                        teData.addPropery("stat",tmpParam.slice(1, 5).join("."));
                        teData.addPropery("ptif",terminalType +'');
                        teData.addPropery("pvn",pvNum);

                        if(!objPt.sendPost(teURL,teData.getJSONRet())){
                            var sentData = "?id=" + sid + "." + uid + "." + visitID + "." + pageID + "." + pvEventID +
                            "&stat=" + tmpParam.slice(1, 5).join(".") +
                            "&ptif=" + terminalType +
                            "&pvn=" + pvNum;
                            //发送te包
                            objPt.sendMsgByScript(teURL + sentData);
                        }
                        
                    }
                }catch(ex){
                }
                break;
            case "setCustomVar":	//自定义变量的解析，从原来的解决入口移到这里，从而达到实时发送数据的目的
                (function(){
                    var type = tmpParam[3];
                    var customVar;
                    if (type == "cookie"){
                        customVar = tmpParam[4];
                    } else if (type == "globalVar"){
                        customVar = window[tmpParam[4]];
                    } else if (type == "domId"){
                        if (doc.getElementById(tmpParam[4])) {
                            customVar = doc.getElementById(tmpParam[4]).innerHTML;
                        }
                    } else if (type == "value"){
                        customVar = tmpParam[4];
                    }
                    if (customVar){
                        if (tmpParam[2] == "ptselfSource") {
                            customVarList.push(['def01',objHttpCookies.getValue(SOURCECOOKIESNAME),tmpParam[3]]);
                            //customVar += "|" + objHttpCookies.getValue(SOURCECOOKIESNAME);
                        }
                        customVarList.push([tmpParam[1],customVar,tmpParam[3]]) ;
                    }
                    if (tmpParam[2] == "ptself" || tmpParam[2] == "ptselfSource") {	//ptmind 内部使用标识
                        revisitPrc("vpv");
                        if (tmpParam[2] == "ptselfSource") {
                            customVarList.pop();
                        }
                        customVarList.pop();		//虚拟pv发出后，删除自定义变量列表中手动添加的值，保证在下次执行时，不会存在重复值
                        if (tmpParam[2] == "ptselfSource") {
                            objHttpCookies.setValue(SOURCECOOKIESNAME, "", {
                                expires: ""
                            });
                        }
                    }
                })();
                break;
			
			// 事件级自定义变量的解析, 使用配置(非槽位)
            case 'setCustomVarV2':{
                try{
                    if (PT_trackEvent == false) {
                        return;
                    }
                    var eventsOpt = function () {
                        if (typeof config == 'object') {
                            if (typeof config.length == 'number') { // 数组
                                return config;
                            } else { // 对象
                                return [config];
                            }
                        }
                    }();

                    if(!eventsOpt) return;

                    var cm = new CustomEventsManager(eventsOpt);
                    pvNum = +pvNum + 1;
                    var teData = new BaseStruct(sid,uid,visitID,pageID,pvEventID);
                    teData.addPropery("eid",cm.getCustomEventEid());
                    teData.addPropery("ptif",terminalType + '');
                    teData.addPropery("pvn",pvNum);
                    if(!objPt.sendPost(teURL,teData.getJSONRet())){
                        var sentData = "?id=" + sid + "." + uid + "." + visitID + "." + pageID + "." + pvEventID
                        + "&eid=" + cm.getCustomEventEid()
                        + "&ptif=" + terminalType
                        + "&pvn=" + pvNum;
                        //发送te包
                        objPt.sendMsgByScript(teURL + sentData);
                    }
                    
                }catch(ex){
                    // console.log(ex);
                }
            }
            break;
            case 'setEC':
                try {
                    var eventsOpt = function () {
                        if (typeof config == 'object') {
                            if (typeof config.length == 'number') { // 数组
                                return config;
                            } else { // 对象
                                return [config];
                            }
                        }
                    }();

                    var cm = new CustomEventsManager(eventsOpt);

                    if(!eventsOpt) return;
                    if (PT_trackEvent == false) {
                        return;
                    }

                    pvNum = +pvNum + 1;
                    var jsonData = cm.getStr();
                    var startSegment = "?id=" + sid + "." + uid + "." + visitID + "." + pageID + "." + pvEventID,
                        endSegment = "&ptif=" + terminalType + "&pvn=" + pvNum;

                    function createEidSegment(json) {
                        return "&eid=" + encodeURIComponent(json);
                    }

                    var ecData = new BaseStruct(sid,uid,visitID,pageID,pvEventID);
                    ecData.addPropery("ptif",terminalType + '');
                    ecData.addPropery("pvn",pvNum);
                    ecData.addPropery("v",version);
                    ecData.addPropery("ts",(new Date()).getTime());
                    ecData.addPropery("data",jsonData);

                    var sentData = startSegment + endSegment;
                    if (!objPt.sendPost(ecURL, ecData.getJSONRet())) {
                        //如果不支持cors，降级使用image/script get 请求

                        sentData = startSegment + createEidSegment(JSON.stringify(jsonData)) + endSegment;
                        var url = ecURL + sentData + "&v=" + version + "&ts=" + (new Date()).getTime();

                        // 拼接后判断是否超长，如果超长，重新组织eid
                        if (url.length > objBrowserInfo.urlLengthLimit) {
                            sentData = startSegment + createEidSegment(cm.getStr(url.length)) + endSegment;
                        }
                        //发送te包
                        objPt.sendMsgByScript(ecURL + sentData);

                    }

                } catch (ex) {}
                break;
            case "setUser":
                if(typeof config== 'object'){
                    if(config.accountid){
                        var data = {
                            uid:uid,
                            sid:sid,
                            accountid:config.accountid,
                            properties:config.props || []
                        };
                        // for(k in config) {
                        //     if(Object.prototype.hasOwnProperty.call(config,k) && k !='accountid'){
                        //         data.properties = data.properties || {};
                        //         data.properties[k] = config[k]
                        //     }
                        // }

                        objPt.sendPost(userURL,JSON.stringify(data));

                    }else{
                        throw new Error("accountid can not be empty.");
                    }
                }
                break;
            case "setFunnelStep":   // 设置漏斗转化
                try {
                    funnelPage = tmpParam[1] == "true";
                    funnelRef = tmpParam.length == 3 ? tmpParam[2] : "";
                } catch(ex) {
                }
                break;
            case "useURLTrim":      // 保留URL末尾斜杠
                try {
                    URLTrimFlag = tmpParam[1] == "false" ? "tmpUrlAPI" : true;
                } catch(ex) {
                }
                break;
            case "setCrossDomainLink":      // 设置跨域链接
                try {
                    crossDomainLink = tmpParam[1] == "allManual" ? "allManual" : tmpParam[1] == "halfManual" ? "halfManual" : false;
                } catch(ex) {
                }
                break;

            case "setIframe":       //页面嵌入iframe设置
                openIframe = tmpParam[1] == "true";
                break;
            case "RecordSource":    //记录用户来源，写入cookie，使用_pt_sp_2.push('RecordSource');调用
                var vidCookieValue = objHttpCookies.getValue(VIDCOOKIESNAME);
                if (vidCookieValue == visitID) {
                    return;
                }
                var tmpVref;
                if (loc.search.indexOf('utm_') > -1) {
                    tmpVref = loc.href;
                } else {
                    tmpVref = visitRef ? visitRef.split('://')[1].split('/')[0] : "";
                }
                var sourceData = objCommon.encode(tmpVref, false) || "no referrer";
                var cookiesData = objHttpCookies.getValue(SOURCECOOKIESNAME);
                sourceData = cookiesData ? (cookiesData + "," + sourceData) : sourceData;
                objHttpCookies.setValue(SOURCECOOKIESNAME, sourceData, {
                    expires: expiresDay
                });
                objHttpCookies.setValue(VIDCOOKIESNAME, visitID, {
                    expires: expiresDay
                });
                break;
            case "ClearSource":     // 清除用户来源
                objHttpCookies.setValue(SOURCECOOKIESNAME, "", {
                    expires: ""
                });
                break;

            case "setSampleRate":    // 抽样率 --dennis
                try {
                    sampleRate = tmpParam[1];
                } catch (ex) {
                }
                break;
            case "setOptimizely":       // 设置A/B测试
                try {
                    optFlag = tmpParam[1] == "true";
                    optType = "Optimizely";
                } catch (ex) {
                }
                break;
            case "setOptimizelyX":       // 设置A/B测试
                try {
                    optFlag = tmpParam[1] == "true";
                    optType = "OptimizelyX";
                } catch (ex) {
                }
                break;
            default:
                break;
        }
    };
    if (window[gParam].length > 0) {    // 加载PT接口，采集文件顶部，通过push设置的接口。
        var window_gParam = window[gParam];
        for (var i = 0; i < window_gParam.length; i++) {
            /*
             * 1. 此时的push并不是向数组中插入值
             * 2. 预设值没有被处理的在此处理
             * 3. 将预设值和后设值都存在的情况进行了统一处理
             */
			if(window_gParam[i]) {
				window[gParam].push(window_gParam[i]);
			}
        }
    }
    if(sid=="308fd851" || sid=="633fdbe6"){//308fd851和633fdbe6网站心跳改为60秒
        HBTIMES=1000*60;
    }
    var messageClient;
    //ITP 处理Safari浏览器
    cookieOfPt.readCookies();
    if (isSafariAndAppliedITP()) {
        var tracking_frame = document.createElement('iframe');
        var protocol = ("https:" == loc.protocol) ? "https://" : "http://" 
        tracking_frame.src = protocol + 'js.ptengine.jp/tracking.html';
        tracking_frame.setAttribute('style', 'width:0;height:0;border:0;border:none');
        document.body.appendChild(tracking_frame);
        //如果load 事件1000毫秒后未触发，则不等待load 事件
        var trackingFrameLoadEventFired = false;
        var loadTimeoutId = setTimeout(function () {
            console.log('timeout timer fired ,load event got exception');
            //1000 毫秒还未触发 
            if (!trackingFrameLoadEventFired) {
                trackingFrameLoadEventFired = true;
            }
            callBack();
        }, 1000)
        tracking_frame.addEventListener('load', function (e) {
            console.log('tracking html load event fired !')
            if (!trackingFrameLoadEventFired) {
                trackingFrameLoadEventFired = true;
                //如果load 事件触发，则干掉定时器
                clearTimeout(loadTimeoutId);

                messageClient = new MessageClient(tracking_frame.contentWindow, '*');

                //cookie 如果不存在，则获取，存在则不用获取
                if (!cookieOfPt.cookiesValue) {
                    messageClient.get(keyForITP(), function (result) {

                        if (result) {
                            var dataFromOuterStorage = JSON.parse(result);
                            //从外部localstorage 初始化 并更新cookie
                            uid = dataFromOuterStorage.uid,
                                isNID = dataFromOuterStorage.nid,
                                visitID = dataFromOuterStorage.vid,
                                visitNum = dataFromOuterStorage.vn,
                                pvNum = dataFromOuterStorage.pvn,
                                siteActionTime = dataFromOuterStorage.sact,
                                toFlag = dataFromOuterStorage.to_flag,
                                // cookieNum = dataFromOuterStorage.cn,
                                pageList = dataFromOuterStorage.pl

                            uid && cookieOfPt.writeCookies();
                        }
                        callBack();
                    })
                } else {
                    callBack();
                }
            }


        });



        function MessageClient(currentWin, targetDomain) {
            //标志函数唯一性
            var indentity = 0;
            var scope = {};

            function getCallbackFuncName(callback) {
                var funcName = 'callback_' + (indentity++);
                //挂载到scope上等待调用
                scope[funcName] = function () {
                    callback.apply(currentWin, arguments);
                };

                return funcName;
            }

            window.addEventListener('message', function (e) {
                console.log(e.origin,e);
                //只有信任域名下的内容才会触发回调
                // 中国区   js.ptengine.cn
                // 日本区   js.ptengine.jp
                // 测试区   jstest.ptmind.cn
                if(/js(test)?\.pt(engine|mind)\.(cn|jp)/.test(e.origin)){
                    var ret = JSON.parse(e.data);
                    var funcName = ret.fn;
                    if (funcName && scope[funcName] && typeof scope[funcName] == 'function') {
                        scope[funcName](ret.result);
                        delete scope[funcName];
                    }
                }
            })

            this.set = function (key, message, callback) {
                currentWin.postMessage(JSON.stringify({
                    key: key,
                    data: message,
                    fn: getCallbackFuncName(callback)
                }), targetDomain);
            }

            this.get = function (key, callback) {
                currentWin.postMessage(JSON.stringify({
                    key: key,
                    fn: getCallbackFuncName(callback)
                }), targetDomain)
            }

        }
    }

    else { callBack(); }
    function keyForITP(){
        return domainName + ':' + sid;
    }

    function isSafariAndAppliedITP() {
        return objBrowserInfo.browerType == 'Safari';
    }
    // 所有程序都放在callBack()里
    function callBack() {
        /*
         * 直接返回(不发包情况)
         * 1. 不以http://或者https://开头，带了特定字符的为非法URL
         * 2. miapex|ptengine|ptmind.com|jp|cn域名除了datatest外
         * 3. URL地址包含ptengine=(弹出式热图)
         * 4. URL地址或者refer中包含ptengine-event-explore=open(事件编辑)
         */
        // URL规则不正确
        if (!loc.href.match(/^https?:\/\/.*/) || (loc.href.indexOf("#_pt_capture") > -1)) {//console.log("ptmind_debug:  "+"url not begin with http or https");
            return false;
        }
        // 如果不是产品布码页面，且位于产品(包括测试环境)热图的iframe中，或者从系统跳出来的，则不发报文
        var prodSid = [
            '2dfd029f',//日本线上 PTEFB-2722
            '323b0b0c',//新版中国report.ptengine.cn
            '14311cf1',
            '4ea10743',
            '4d304c7a',
            '46635348',
            '31aee115',
            '39a47d27',
            '1568e5d4',
            '1a8c08b0',
            '6f1b18fd',
            '566d12f9',
            '51add8fa',
            '15d58c7b', // 日本帮助站
            '223c998c', // 海外帮助站
            '17d1d4aa', // 占位
            '308c8fdc', // 占位
            '5102c629', // 占位
            '5b85c19b', // 占位
            '4e8daed1',	// 占位
            '7201105c',//https://www.ptengine.jp/gmoc18/  张宇让添加
            '645474fb',//https://www.ptengine.jp/linka18/     张宇让添加
            '4e63000f'//https://www.ptengine.jp/A81812/     张宇让添加
        ];
        if (prodSid.join(',').indexOf(sid)<0) {
            // 测试站点（datatest开头，需要正常发包） && 产品测试站（屏蔽发包）
            var excludeDomainReg = /^http[s]?:\/\/((?!datatest).)+\.(miapex|ptengine|ptmind)\.(com|jp|cn)/;
            if(excludeDomainReg.test(loc.href) || excludeDomainReg.test(doc.referrer)) {
                return false;
            }
        }
        // 弹出热图不发包
        if(loc.href.indexOf("ptengine=") > -1){
            return false;
        }
        // 事件编辑不发包
        if(loc.href.indexOf(openEventLabel) > -1 || (doc.referrer && doc.referrer.indexOf(openEventLabel) > -1)){
            return false;
        }


        /*
         * 获取必要页面信息,并对一些情况进行特殊处理
         */
        // 判断该url是否开启了热图功能
        if (objPt.valFunction("heatmap", window["edc7uo"])) {
            heatmapFlag = true;
        }
        // 根据访问终端的类型来调整页面静默时间(如果是pc或者模拟器，调整为30分钟)
        switch (terminalType) {
            case 2:
            case 3:
                SILENTTIMES = 1000 * 60 * 30;
                break;
            default:
                break;
        }
        // 如果是cellant的sid的话，不采集非移动终端的数据
        if (company == "cellant") {
            if (terminalType == 2 || terminalType == 3) {
                return false;
            }
        }
        page = objBrowserInfo.getPage(); // 页面URL
        initPage = page;    //页面URL备份
        pageID = objCommon.createID(page); // 页面ID
        objHttpCookies.clearOtherCookie();//临时添加的方法
        cookieOfPt.readCookies();
        funnelPage = (cookieOfPt.cookiesValue && funnelPage) ? true : false;
        if (funnelPage) {
            //zpj:CV流程监测 特殊对应
            NVTIMES = 1000 * 60 * 60 * 24;
            ref = objBrowserInfo.getRef();
            preVID = cookieOfPt.getValueFromCookies("vid");
        }


        /*
         * cookie迁移到新的地方,全部删除过去的cookie(cookie的name带有pt_sid_path的全部删除)
         */
        (function(){
            function deleteCookie(name){
                function deleteCookieTemp(name,domain,path){
                    var date = new Date();
                    date.setTime(date.getTime() - 10000);
                    doc.cookie = name+"='';expires="+date.toGMTString()+";domain="+domain+";path="+path+";"
                    doc.cookie = name+"='';expires="+date.toGMTString()+";domain="+domain+";path="+path+"/;"
                }
                deleteCookieTemp(name,"","");
                var tempDomain = loc.hostname.split(".");
                var tempPath   = loc.pathname.split("/");
                for(var i=0;i<tempDomain.length;i++){
                    for(var j=0;j<tempPath.length;j++){
                        deleteCookieTemp(name,tempDomain.slice(i).join("."),tempPath.slice(0,parseInt(j)+1).join("/"))
                    }
                }
            }
            // 获取所有cookie
            var allCookie=doc.cookie.split(";");
            for(var i=0;i<allCookie.length;i++){
                allCookie[i] = allCookie[i].split("=");
                if(allCookie[i][0].indexOf(COOKIESNAME)>-1){    // 包含pt_[sid]
                    cookieOfPt.cookiesValue = allCookie[i].slice(1).join("=");  // 去除前置空格
                    deleteCookie(allCookie[i][0]);//将过去旧的cookie位置删除，3.5需求中把过去的cookie全部删除，并且把cookie位置，迁移到主域的根目录
                }else if(allCookie[i][0].indexOf(SESSIONCOOKIESNAME)>-1){   // 包含 pt_s_[sid]
                    var sessionValueTemp = SESSIONCOOKIESNAME+"="+allCookie[i].slice(1).join("=")+";domain="+domainName+";path=/;";
                    deleteCookie(allCookie[i][0]);//将过去旧的cookie位置删除，3.5需求中把过去的cookie全部删除，并且把cookie位置，迁移到主域的根目录
                }
            }
            if(sessionValueTemp){
                doc.cookie = sessionValueTemp;
            }
        })();


        /**************cookies处理开始**************************************/
        /*合并成URL传参时用的信息串*/
        function isHasSearchInUrl(list){//如果包含特殊参数，则切断访次
            //用户设置了忽略广告参数时,不切断访次
            if(ignoreCampaign){
                return false;
            }
            if(loc.href.match(/(utm_campaign|utm_source|utm_medium|utm_term|utm_content)/)){
                return true;
            }
            for(var i=0;i<list.length;i++){
                if(loc.search.match(new RegExp("[?/&]("+list[i]+")="))){
                    return true;
                }
            }
            return false;
        }
        function isFromSearchEngine(){  // 搜索引擎
            var all = ["(wap|www|m|m5).baidu.com",
                "www.baidu.jp",
                "(hao|so).360.cn",
                "www.360(soso|sou).com",
                "(www|m).so.com",
                "www.google.",
                "(blogsearch|books|images|news|scholar).google.com",
                "bing.com",
                "(search|tw.search).yahoo.com",
                "www.yahoo.cn",
                "search.yahoo.co.jp",
                //日本特有，中国是否要保留
                "(www|jp).ask.com",
                "(cn|jp).indeed.com",
                "search.biglobe.ne.jp",
                "search.(goo|smt.docomo).ne.jp",
                "search.nifty.com",
                "websearch.rakuten.co.jp",
                "www.so-net.ne.jp"];
            for(var i=0;i<all.length;i++){
                if(doc.referrer.match(new RegExp(all[i]))){
                    return true;
                }
            }
            return false;
        }
        if (objCommon.isNull(cookieOfPt.cookiesValue) || !cookieOfPt.checkCookiesValue()) {
            objHttpCookies.setValue(SESSIONCOOKIESNAME, visitTime, {
                expires: ""
            });
            // 如cookie没有，或者cookies不完整，则生成指纹
            cookieOfPt.cookiesValue = ""; // 对应cookies不完整的情况
            /*************指纹采集结束****************************************/
            uid = objCommon.createID(objBrowserInfo.getUidStr());
            if (!uid) { // 判断uid是否为空，如果为空，通过时间和随机数重新创建uid
                uid = objCommon.createID((new Date()).getTime()+""+Math.random());
            }
            isNID = "1"; // 新访客
            visitNum = 0; // 访次重新计数
            if (multiLinkTag) {
                // 如果是多域访问过来的
                var tmpLinkTagAry = multiLinkTag.split(".");
                uid = tmpLinkTagAry[0];
                isNID = tmpLinkTagAry[1];
                visitID = tmpLinkTagAry[2];
                siteActionTime = tmpLinkTagAry[3];
                visitNum = tmpLinkTagAry[4];
                pvNum = tmpLinkTagAry[5];
                visitRef = tmpLinkTagAry[6].replace(/\*\_\*/g, ".").replace(/\*\_wh\_\*/g, "?");
                isNV = "0"; // 不计为新访次
            } else {
                isNV = "1"; // 计为新访次
                visitRef = ref["referrer"];
            }
        }else if(isHasSearchInUrl(camParamAry) || isFromSearchEngine()) {
            if (multiLinkTag) {
                // 如果是多域访问过来的
                var tmpLinkTagAry = multiLinkTag.split(".");
                uid = tmpLinkTagAry[0];
                isNID = tmpLinkTagAry[1];
                visitID = tmpLinkTagAry[2];
                siteActionTime = tmpLinkTagAry[3];
                visitNum = tmpLinkTagAry[4];
                pvNum = tmpLinkTagAry[5];
                visitRef = tmpLinkTagAry[6].replace(/\*\_\*/g, ".").replace(/\*\_wh\_\*/g, "?");
                isNV = "0"; // 不计为新访次
            } else {
                // 如果不是新用户，且不是多域过来的，则获得uid，visitNum，NID，NV
                uid = cookieOfPt.getValueFromCookies("uid");
                if (!uid) {     // 判断uid是否为空，如果为空，通过时间和随机数重新创建uid
                    uid = objCommon.createID((new Date()).getTime()+""+Math.random());
                }
                isNID = cookieOfPt.getIsNID();
                visitNum = cookieOfPt.getValueFromCookies("vn");
                isNV = "1"; // 计为新访次
                visitRef = ref["referrer"];
            }
        }else {
            // 获取sessionCookie
            sessionCookiesValue = objHttpCookies.getValue(SESSIONCOOKIESNAME);
            if(hasHttpCookies){
                if(sessionCookiesValue){
                    sessionCookieFlag = 1;
                }else{
                    sessionCookieFlag = 0;
                }
            }else{
                sessionCookieFlag = -1;
            }
            //if (multiLinkTag && (sessionCookieFlag == 0)) {
            if (multiLinkTag) {
                // 如果是多域访问过来的，且没有sessionCookie，（如果有sessionCookie的则说明是刷新了）:uid，isNID，visitID，siteActionTime进行统一
                tmpLinkTagAry = multiLinkTag.split(".");
                uid = tmpLinkTagAry[0];
                isNID = tmpLinkTagAry[1];
                visitID = tmpLinkTagAry[2];
                siteActionTime = tmpLinkTagAry[3];
                visitNum = tmpLinkTagAry[4];
                pvNum = tmpLinkTagAry[5];
                visitRef = tmpLinkTagAry[6].replace(/\*\_\*/g, ".").replace(/\*\_wh\_\*/g, "?");
                pageList = "";
                isNV = "0"; // 不计为新访次
                // 多域过来的也需要设置session
                objHttpCookies.setValue(SESSIONCOOKIESNAME, visitTime, {
                    expires: ""
                });
            } else {
                // 如果不是新用户，且不是多域过来的，则获得uid，visitNum，NID，NV
                uid = cookieOfPt.getValueFromCookies("uid");
                if (!uid) {     // 判断uid是否为空，如果为空，通过时间和随机数重新创建uid
                    uid = objCommon.createID((new Date()).getTime()+""+Math.random());
                }
                isNID = cookieOfPt.getIsNID();
                if (cookieOfPt.getIsRefresh(visitTime) == 1) {
                    // 如果是刷新的话，则不进行更新ref
                    ref = {
                        "flag": 0,
                        "referrer": ""
                    };
                }
                isNV = (ref["flag"] == 1) ? "1" : cookieOfPt.getIsNV(visitTime);
                if (company == "cellant" && adParamFlag) {
                    // 如果是cellant系统，而且广告参数存在，则判定为新访次
                    isNV = "1";
                }
                if (company == "cellant" && sessionCookieFlag && !adParamStr) {
                    adParamStr = sessionCookiesValue.split("cad" + "=")[1];
                    if (adParamStr) {
                        adParamStr = adParamStr.split("&")[0]
                    }
                }
                visitNum = cookieOfPt.getValueFromCookies("vn");
                var tmpPvNum = cookieOfPt.getValueFromCookies("pvn");
                pvNum = (isNV == "1") ? 0 : (tmpPvNum ? tmpPvNum : 1);
                pageList = (isNV == "1") ? "" : cookieOfPt.getValueFromCookies("pl");
                //visitRef = (isNV == "1") ? ref["referrer"] : cookieOfPt.getValueFromCookies("vr");
                visitRef = (isNV == "1") ? ref["referrer"] : ( (win.localStorage && (typeof(win.localStorage.removeItem)=="function")) ? win.localStorage.getItem(profileID) : "");
                if (isNV == "1") {
                    // 如果此时为新访次
                    objHttpCookies.setValue(SESSIONCOOKIESNAME, visitTime, {
                        expires: ""
                    });
                }
            }
        }


        /*
         * 抽样采集
         */
        if (sampleRate) {//开启抽样率API--dennis
            //抽样率必须是数字
            if(/^\d+$/.test(sampleRate)){
                var base64EncodeChars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-/";
                //从uid中取出8个base64的字符
                var shortUid= uid.substr(1,2)
                    +uid.substr(5,1)+uid.substr(8,1)+
                    uid.substr(10,1)+ uid.substr(13,1)+ uid.substr(15,1)+uid.substr(19,1);
                var index = 0;
                var number = 0;
                //将8个base64的字符转换为数字
                while (index < 8) {
                    var c = shortUid.charAt(7 - index);
                    var n = base64EncodeChars.indexOf(c);
                    number += n*Math.pow(64,index);
                    index++;
                }
                if(number % sampleRate != 0) return;
            }
        }


        // 各状态变量的赋值
        pageAccessTime = visitTime; // 页面初访时间（pat)
        siteActionTime = (multiLinkTag) ? siteActionTime : visitTime; // 登录网站最近操作时间（包括此次的加载代码）(sact)，多域访问的话，则继承
        pageActionTime = visitTime; // 本页最近操作时间
        visitID = (multiLinkTag) ? visitID : ((isNV == "1") ? objCommon.createID(uid + page + siteActionTime + "v") : cookieOfPt.getValueFromCookies("vid")); // 访次事件ID
        if (funnelPage && preVID) {
            //zpj:CV流程监测 特殊对应
            if (visitID != preVID) {
                visitID = preVID;
            }
        }
        visitNum = (isNV == "1") ? +visitNum + 1 : ((+visitNum == 0) ? 1 : +visitNum); // 如果是新访的话，
        pvNum = +pvNum + 1;
        pvEventID = objCommon.createID(uid + visitID + page + pageAccessTime + "v"); // 页面访问ID
        pageList = cookieOfPt.plPrc(pageID); // 登录当前页面
        // 更新cookies
        cookieOfPt.writeCookies();
        //=======================对当前的iframe传递进入hash值========================
        (function(){
            if(openIframe || sid == "7f21ceb9"){
                var allIframe = doc.getElementsByTagName("iframe");
                for (var i=0; i<allIframe.length; i++) {
                    allIframe[i].onload = (function(i) {
                        return function(objEvent_){
                            this.contentWindow.document.onclick = function(objEvent_) {
                                var currentOffset = objBrowserInfo.getOffset(allIframe[i]);
                                iframeValue[0] = currentOffset.left;
                                iframeValue[1] = currentOffset.top;
                                var iFrameCssString ="";
                                try{
                                    iFrameCssString=objPt.getCssPath(allIframe[i]);
                                }catch (err){}
                                iframeValue[2] = encodeURIComponent(iFrameCssString);

                                // 取得点击的相对坐标
                                mouseCoo = objBrowserInfo.getMouseRC1(objEvent_);
                                // 超出页面内容范围，不计统计
                                if(objBrowserInfo.getPageHeight()>0){
                                    if (mouseCoo.x <= 0 || mouseCoo.y <= 0 || mouseCoo.x > +objBrowserInfo.getPageWidth() || mouseCoo.y > +objBrowserInfo.getPageHeight())
                                        return;
                                }
                                // 获取触发事件的dom元素对象
                                srcElement = objBrowserInfo.getSrcElement(objEvent_);
                                clickPrc();
                            };
                        }
                    })(i);
                }
            }
        })();
        // 网站ID+用户ID+页面+访次ID+页面访问ID
        var loadTime = ((window["_pt_lt"] != -1) ? (new Date().getTime() - window["_pt_lt"]) : 0);
        if(loadTime<0){
            loadTime = 0;
        }
        var pnvData = new BaseStruct(sid,uid,visitID,pageID,pvEventID);
        pnvData.addPropery("stat",((isNV == "1") ? visitNum : pvNum) + "." + ((rotationFlag == 1) ? objBrowserInfo.getScrollY() : ((objBrowserInfo.getScrollY() + 1) * rotationFlag)) +
        "." + yMax * rotationFlag + "." + objBrowserInfo.getViewHeight() + "." + loadTime +
        "." + ((isNV == "1") ? ref["flag"] : objBrowserInfo.getRefType(visitRef)) +
        ((isNV == "1") ? "" : ("." + visitNum)));
        pnvData.addPropery("ref",objCommon.encode(ref["referrer"].replace(/&/g, "*&*").replace(/\+/g, "*+*"), false));
        isNV != "1" && pnvData.addPropery("vref",objCommon.encode(visitRef, false));

        pnvData.addPropery("p",objCommon.encode(page.replace(/&/g, "*&*"), false));
        pnvData.addPropery("tl",title);
        adParamStr && pnvData.addPropery("cad",adParamStr) ;//广告参数
        pnvData.addPropery("ptif",terminalType + objBrowserInfo.getSysInfo());

        getABTestString(true) && pnvData.addPropery("op",getABTestString(true));
        // console.log('before pt_id+sid setting');
        
        localStorage.setItem("PT_ID_"+sid,sid + "." + uid + "." + visitID + "." + pageID + "." + pvEventID);

        /**
         * @fixme 直接拉取js
         * 需要开启标识识别
         */
        (loc.href.indexOf(engagePreviewTokenKey)==-1) && enableEngage && (function(){
            var protocol = ("https:" == loc.protocol) ? "https://" : "http://" 
            var script = doc.createElement('script');
            script.type = 'text/javascript';
            script.async = true;
            script.charset = 'UTF-8';
            // script.src = protocol+"pteengagejs.ptengine.jp/engage_" + sid + '.js?ts='  + (new Date()).getTime() ;
            //测试环境
            // script.src = protocol+'jstest.ptmind.cn/engage.js?v=' + version ;
            //线上环境
            script.src = protocol+'pteengagejs.ptengine.jp/engage.js?v=' + version ;
            //staging环境
            // script.src = protocol+'stagingpteengagejs.ptmind.com/engage.js?v=' + version ;

            try{
                localStorage.setItem('PTSID',sid);
                doc.body.appendChild(script); //插入到body的最后。不然会影响元素选择器的生成
                
            }catch (ex){
                doc.getElementsByTagName('head')[0].appendChild(script);
            }

        })();

        ptq = "?id=" + sid + "." + uid + "." + visitID + "." + pageID + "." + pvEventID
            + "&stat=" + ((isNV == "1") ? visitNum : pvNum) + "." + ((rotationFlag == 1) ? objBrowserInfo.getScrollY() : ((objBrowserInfo.getScrollY() + 1) * rotationFlag))
            + "." + yMax * rotationFlag + "." + objBrowserInfo.getViewHeight() + "." + loadTime
            + "." + ((isNV == "1") ? ref["flag"] : objBrowserInfo.getRefType(visitRef))
            + ((isNV == "1") ? "" : ("." + visitNum))
            + "&ref=" + objCommon.encode(ref["referrer"].replace(/&/g, "*&*").replace(/\+/g, "*+*"), false)
            + ((isNV != "1") ? ("&vref=" + objCommon.encode(visitRef, false)) : "")
            + "&p=" + objCommon.encode(page.replace(/&/g, "*&*"), false) + "&tl=" + title
            + (adParamStr ? ("&cad=" + adParamStr) : "")
            + "&ptif=" + terminalType;
        ptq += objBrowserInfo.getSysInfo();
        ptq += getABTestString();
        for(var i=0;i<customVarList.length;i++){//增加用户自定义变量
            if(customVarList[i][2]=="cookie"){
                var cookieOfCustomVar = objHttpCookies.getValue(customVarList[i][1]);
                if(cookieOfCustomVar){
                    ptq += "&"+customVarList[i][0]+"="+objCommon.encode(cookieOfCustomVar,false);
                    pnvData.addPropery(customVarList[i][0],objCommon.encode(cookieOfCustomVar, false));
                }
            }else{
                ptq += "&"+customVarList[i][0]+"="+objCommon.encode(customVarList[i][1],false);
                pnvData.addPropery(customVarList[i][0],objCommon.encode(customVarList[i][1], false));
            }
        }

        if(PageViewVar) {
            ptq += '&pvid=' + encodeURIComponent(PageViewVar);
            pnvData.addPropery("pvid",encodeURIComponent(PageViewVar));
        }

        if(isNV == "1"){
            function compareHrefToRef(href, ref) {	//http://jira.ptmind.com/browse/FB-679|比较两个链接是否在不同域名下，是：返回1，否：返回0[zhaopengjun 2015-05-04]
                for (var i=0; i<domainSet.length; i++) {
                    if (href.indexOf(domainSet[i]) > -1 && ref["referrer"].indexOf(domainSet[i]) > -1) {
                        return 0;
                    }
                }
                return 1;
            }
            if (multiDomainFlag && crossDomainLink != "allManual" && ref["referrer"] != "" && compareHrefToRef(loc.href, ref) && objBrowserInfo.getRefType(ref["referrer"]) == 0 && !loc.href.match(/[\#|\?|\&]_pt_link=[^#|^&]*/)) { 	//http://jira.ptmind.com/browse/FB-601|增加sid=4feafb6a的跨域处理[zhaopengjun 2015-03-26]
                //跨域失败后，手动发送pn包
                pageID = objCommon.createID(ref["referrer"]);
                pvEventID = objCommon.createID(uid + visitID + ref["referrer"] + pageAccessTime + "v");

                pnvData = new BaseStruct(sid,uid,visitID,pageID,pvEventID);
                pnvData.addPropery("stat",((isNV == "1") ? visitNum : pvNum) + "." + ((rotationFlag == 1) ? objBrowserInfo.getScrollY() : ((objBrowserInfo.getScrollY() + 1) * rotationFlag)) +
                "." + yMax * rotationFlag + "." + objBrowserInfo.getViewHeight() + "." + loadTime +
                ".0");

                pnvData.addPropery("ref","");
                pnvData.addPropery("p",objCommon.encode(ref["referrer"].replace(/&/g, "*&*"), false));
                pnvData.addPropery("tl",title);
                adParamStr && pnvData.addPropery("cad",adParamStr);
                pnvData.addPropery("ptif",terminalType + objBrowserInfo.getSysInfo());

                PageViewVar && pnvData.addPropery("pvid",encodeURIComponent(PageViewVar));

                if(!objPt.sendPost(pnURL,pnvData.getJSONRet())){
                    ptq = "?id=" + sid + "." + uid + "." + visitID + "." + pageID + "." + pvEventID +
                    "&stat=" + ((isNV == "1") ? visitNum : pvNum) + "." + ((rotationFlag == 1) ? objBrowserInfo.getScrollY() : ((objBrowserInfo.getScrollY() + 1) * rotationFlag)) +
                    "." + yMax * rotationFlag + "." + objBrowserInfo.getViewHeight() + "." + loadTime +
                    ".0" +
                    "&ref=" +
                    "&p=" + objCommon.encode(ref["referrer"].replace(/&/g, "*&*"), false) + "&tl=" + title +
                    (adParamStr ? ("&cad=" + adParamStr) : "") +
                    "&ptif=" + terminalType;
                    ptq += objBrowserInfo.getSysInfo();
                    PageViewVar && (ptq += '&pvid=' + encodeURIComponent(PageViewVar));
                    objPt.sendMsg(pnURL + ptq);
                }

                (function() {
                    //跨域失败后，手动发送pv包
                    pageID = objCommon.createID(page);
                    pvEventID = objCommon.createID(uid + visitID + page + pageAccessTime + "v");
                    pvNum = +pvNum + 1;

                    pnvData = new BaseStruct(sid,uid,visitID,pageID,pvEventID);

                    pnvData.addPropery("stat",pvNum + "." + ((rotationFlag == 1) ? objBrowserInfo.getScrollY() : ((objBrowserInfo.getScrollY() + 1) * rotationFlag)) +
                    "." + yMax * rotationFlag + "." + objBrowserInfo.getViewHeight() + "." + loadTime +
                    "." + objBrowserInfo.getRefType(visitRef) +
                    ("." + visitNum));

                    pnvData.addPropery("ref",objCommon.encode(ref["referrer"].replace(/&/g, "*&*").replace(/\+/g, "*+*"), false));
                    pnvData.addPropery("vref","");
                    pnvData.addPropery("p",objCommon.encode(page.replace(/&/g, "*&*"), false));
                    pnvData.addPropery("tl",title);
                    adParamStr && pnvData.addPropery("cad",adParamStr);
                    pnvData.addPropery("ptif",terminalType + objBrowserInfo.getSysInfo());
                    PageViewVar && (ptq += '&pvid=' + encodeURIComponent(PageViewVar));

                    if(!objPt.sendPost(pvURL,pnvData.getJSONRet())){
                        ptq = "?id=" + sid + "." + uid + "." + visitID + "." + pageID + "." + pvEventID +
                        "&stat=" + pvNum + "." + ((rotationFlag == 1) ? objBrowserInfo.getScrollY() : ((objBrowserInfo.getScrollY() + 1) * rotationFlag)) +
                        "." + yMax * rotationFlag + "." + objBrowserInfo.getViewHeight() + "." + loadTime +
                        "." + objBrowserInfo.getRefType(visitRef) +
                        ("." + visitNum) +
                        "&ref=" + objCommon.encode(ref["referrer"].replace(/&/g, "*&*").replace(/\+/g, "*+*"), false) +
                        "&vref=" +
                        "&p=" + objCommon.encode(page.replace(/&/g, "*&*"), false) + "&tl=" + title +
                        (adParamStr ? ("&cad=" + adParamStr) : "") +
                        "&ptif=" + terminalType;
                        ptq += objBrowserInfo.getSysInfo();
                        PageViewVar && (ptq += '&pvid=' + encodeURIComponent(PageViewVar));
                        objPt.sendMsg(pvURL + ptq);
                    }
                    
                })();
            } else {
                if(!objPt.sendPost(pnURL,pnvData.getJSONRet())){
                    objPt.sendMsg(pnURL + ptq);
                }
            }
        }else{
            if(!objPt.sendPost(pvURL,pnvData.getJSONRet())){
                objPt.sendMsg(pvURL + ptq);
            }
        }
        // 将访次的信息放在session cookie里
        var sessionMsg = "vt=" + visitTime + "&cad=" + adParamStr;
        objHttpCookies.setValue(SESSIONCOOKIESNAME, sessionMsg, {
            expires: ""
        });
        // 如果是新访，将访次的vref放在localstorage里
        if ((isNV == "1") && win.localStorage && (typeof(win.localStorage.removeItem)=="function")){
            win.localStorage.removeItem(profileID);
            win.localStorage.setItem(profileID,visitRef);
        }
        // 多域处理
        if (multiDomainFlag) {	//http://jira.ptmind.com/browse/FB-601|增加sid=4feafb6a的跨域处理[zhaopengjun 2015-03-26]
            if (doc.readyState == "complete") {
                whandler();
            } else {
                var oldWindowHandler = win.onload;
                win.onload = function() {
                    if (!!oldWindowHandler) {
                        oldWindowHandler();
                    }
                    whandler();
                };
            }
        }

        /*
         * 添加事件
         * target: 组件
         * type: 事件类型-前头不带'on'
         * func: 函数-函数名或者整个匿名函数
         */
        function addEvent(target, type, func) {
            if (target.addEventListener) {
                target.addEventListener(type, func, true);
            } else if (target.attachEvent) {
                target.attachEvent("on" + type, func);
            }
            //else target["on" + type] = func; // 防止覆盖原有设定
        }
		
		
		/**
         * 开始对 "input","textarea","select", "embed" 四种类型的元素进行绑定focus 事件
         */
        var bindFocus = function() {
			// 建一队列用于记录历史focus
			var lastFocusDomQueue = [null, null];
			
			// 此举是为解决chrome下焦点由一个元素切换到window再转移到另一个元素时，会再次触发第一个元素的focus事件的问题
			var isFireFocus = function(el, lastFocusDomQueue) {
				// chrome下的特殊处理
				if(objBrowserInfo.browerType != 'Chrome') {
					return true;
				}
				
				if(lastFocusDomQueue[0] == el && lastFocusDomQueue[1] == win) {
					//console.log(lastFocusDomQueue, '不发');
					return false;
				}
				
				if(lastFocusDomQueue[0] == win && lastFocusDomQueue[1] == win) {
					//console.log(lastFocusDomQueue, '不发');
					return false;
				}
				
				//console.log(lastFocusDomQueue, '发包' + el.id);
				return true;
			}
			
			addEvent(win, 'focus', function(e) {
				//console.log('win focus')
				
				if(lastFocusDomQueue[1] == this) {
					return;
				}
				
				lastFocusDomQueue.push(this);
				lastFocusDomQueue.shift();
			});
			
			addEvent(win, 'click', function(e) {
				//console.log('win click')
				
				if(lastFocusDomQueue[1] == this) {
					return;
				}
				
				var dom = e.target || e.srcElement;
				lastFocusDomQueue.push(dom);
				lastFocusDomQueue.shift();
			});
			
			return function() {
				
				// iphone手机走click
				if (/windows|win32/i.test(na.userAgent) && /msie|trident|edge/i.test(na.userAgent) || /(iPhone|iPad|iPod|iOS)/.test(na.userAgent)) {
					formElementTriggerEventType = 'click'; //
				} else {
					for (var j = 0; j < allFocusType.length; j++) {
						var allFormInput = doc.getElementsByTagName(allFocusType[j]);
						for (var i = 0; i < allFormInput.length; i++) {

							addEvent(allFormInput[i], "focus", function (objEvent_) {
								if (isFireFocus(this, lastFocusDomQueue)) {

									srcElement = objBrowserInfo.getSrcElement(objEvent_);
									//当前元素能够触发的事件
									var customEventContainer = checkEventList(srcElement);
									var customEventObj = buildCustomEventObj(customEventContainer);

                                    if (customEventObj) { //合并的te包
                                        var teData = new BaseStruct(sid,uid,visitID,pageID,pvEventID);

                                        var id = sid + "." + uid + "." + visitID + "." + pageID + "." + pvEventID;
                                        var ptif = terminalType +'';
                                        var tmpMsg = "?id=" + id;
                                        if (customEventObj.stat) { //旧版事件
                                            tmpMsg += ("&stat=" + customEventObj.stat);
                                            teData.addPropery("stat",customEventObj.stat);
                                        }
                                        if (customEventObj.eid) { //新版事件
                                            tmpMsg += ("&eid=" + customEventObj.eid);
                                            teData.addPropery("eid",customEventObj.eid);
                                        }
                                        pvNum = +pvNum + 1;

                                        teData.addPropery("pvn",pvNum);
                                        teData.addPropery("ptif",ptif);

                                        tmpMsg += ("&pvn=" + pvNum);
                                        tmpMsg += ("&ptif=" + ptif);

                                        if(!objPt.sendPost(teURL,teData.getJSONRet())){
                                            objPt.sendMsgByScript(teURL + tmpMsg);
                                        }

									}
								}

								lastFocusDomQueue.push(allFormInput[i]);
								lastFocusDomQueue.shift();
							});
						}
					}
				}
			}
        }();
		
		
		
		
        /*********************可输入框的焦点触发事件设置开始**********************************/
        var allFocusType=["input","textarea","select", "embed"];//所有会触发focus的对象
        //先判断页面当前状态,loading 完毕之后可以开始绑定 focus 事件了
        if(doc.readyState.toLowerCase() === "interactive" || doc.readyState.toLowerCase() === "complete"){
            //页面元素已经加载完毕, 直接进行绑定事件
            bindFocus();
        } else {
            //如果仍然在 loading 状态, 等状态变更后再绑定
            doc.onreadystatechange = function(){
                if(doc.readyState.toLowerCase() === "complete" ){
                    bindFocus();
                }
            }
        }

        /**
         * 检查当前srcElement 是否有在事件列表中,如果存在事件 则发送te包
         * (在"input","textarea","select", "embed"的focus,其它的元素的click,touchend事件中调用)
         */
        function checkEventList(targetElement,parentAOfThisDom) {
            //旧版事件,点击的元素向上冒泡到其上级为a的的元素,用a元素作为事件元素
            var oldEventElement = targetElement;
            if(typeof(parentAOfThisDom)=="object"){
                oldEventElement= parentAOfThisDom;
            }
            //获取当前点击元素的选择器(旧版选择器,为旧版事件判断元素用)
            var oldJqueryCssString = "";
            try{
                oldJqueryCssString = objPt.getCssPathOld(oldEventElement);
            }catch(err){}

            var newEventTriggerList =[];//新版事件 触发列表。点击一个元素后,其上级/祖先级元素上的事件合并到一个te包
            var oldEventTrigger;//旧版事件 触发列表。点击一个元素后,其上级/祖先级元素上的事件合并到一个te包

            if (asyncEventList.length > 0) {
                //循环用户定义的事件列表
                for (var i = 0; i < asyncEventList.length; i++) {
                    try{
                        var asyncEventItem = asyncEventList[i];
                        //新版事件
                        if (asyncEventItem.length >= 10) {
                            //获取选择器元素 asyncEventItem[9] 是用户设定的 text, 只有text 符合这个值的元素才会发送事件
                            //有可能用户设置的选择器能够匹配多个元素
                            var elems = _queryElements(asyncEventItem[7], asyncEventItem[9]);
                            var isTriggerEvent =false;//当前循环的事件是否已经触发
                            //循环用户设置的选择器匹配的元素,只要有一个和当前点击的元素相同,则发送te包,并停止循环(后面的元素不需要再比较了)
                            for (var j = 0, tempLength = elems.length; j < tempLength; j++) {
                                isTriggerEvent=checkEvent(targetElement,elems[j]);
                                if(isTriggerEvent){//如果触发了,则不在继续查看剩余的元素
                                    //'事件名称:是否时自动事件:是否时活动元素'
                                    // newEventTriggerList.push(asyncEventItem[3]+':1'+':'+(asyncEventItem[5]=='false'?'1':'0'));
                                    //newEventTriggerList.push(asyncEventItem[3]+':1'+':0');
                                    //test 自定义变量
                                    newEventTriggerList.push(asyncEventItem[3]+':1'+':0');
                                    break;
                                }
                            }

                        }
                        //旧版事件(先用jquery选择元素来比较。如果目标网页没有用jquery,则用选择器比较)
                        else if ((typeof(jQuery) == "function" && jQuery(asyncEventItem[7])[0] == oldEventElement) || (typeof(jQuery) != "function" && asyncEventItem[7] == oldJqueryCssString)) {
                            var tempEventStr = asyncEventItem;
                            oldEventTrigger=tempEventStr.slice(1, 5);
                            // _pt_sp_2.push('setTrackEvent,' + tempEventStr.slice(1, 5).join(","));
                        }
                    }catch (err){//异常选择器后跳过该事件的获取 

                    }
                }
            }
            return {
                newEventTriggerList:newEventTriggerList,
                oldEventTrigger:oldEventTrigger
            }
        }

        /**
         * 新版事件 对某个元素 检查其是否在某个事件中,并一直冒泡到body
         * @param targetElement:目标元素
         * @param elem:事件中设置的元素
         * @returns {*} 是否触发了事件
         */
        function checkEvent(targetElement,elem) {
            //如果点击的元素和但前传入的elem一直 在发送te包,并返回 true(标示发送了te包)
            if (targetElement === elem) {
                //发送事件  asyncEventItem[8] = eid
                // _pt_sp_2.push("setTrackEvent," + asyncEventItem.slice(1, 5).join(",") + "," + asyncEventItem[8]);
                return true;
            }
            //如果但前传入的elem 和点击的元素不同,则向上冒泡 判断 点击元素 的父级元素是否相同,一直冒泡到body
            else if(targetElement.nodeName.toLowerCase()!=='body'){
                return checkEvent(targetElement.parentNode,elem);
            }
            //如果冒泡到body 也没有匹配的元素,则返回false(说明传入的elem 和点击的元素 以及其父级,祖先级元素都不匹配)
            return false;
        }

        /**
         * 将触发的新／旧自动事件打包，为发送te包提供数据
         * @param customEventContainer 触发的新/旧列表
         * @returns {eid:新事件,stat:旧版事件}
         */
        function buildCustomEventObj(customEventContainer) {
            if(!customEventContainer){
                return false;
            }
            var eid,stat;
            if(customEventContainer.newEventTriggerList && customEventContainer.newEventTriggerList.length){
                eid = customEventContainer.newEventTriggerList.join(',');
            }
            if(customEventContainer.oldEventTrigger){
                stat = customEventContainer.oldEventTrigger.join('.')
            }
            if(!eid && !stat){
                return false;
            }else{
                return {eid:eid?eid:'',stat:stat?stat:''}
            }
        }

        
        /*********************可输入框的焦点触发事件设置结束**********************************/
        /*********************鼠标移动触发事件设置开始**********************************/
        //addEvent(win, "mousemove", mousemovePrc);
        /*
        function mousemovePrc(objEvent_) {
            if (!activeFlag) {
                // 当页面处于非激活状态
                // 判断当前访次是否超时(用to_flag和sact一起判断）
                var recentTime = new Date().getTime();
                cookieOfPt.readCookies();
                // 根据to_flag标志位以及操作时间判断之前的访次是否已经结束
                if (cookieOfPt.getValueFromCookies("to_flag") == 1 || (+recentTime - +cookieOfPt.getValueFromCookies("sact") > +SILENTTIMES)) {
                    // 已经结束
                    revisitPrc("pn");
                    return;
                } else if (cookieOfPt.isNewVisit(visitID, recentTime)) {
                    // 如果当前已经开始一个新的访次
                    revisitPrc("pv");
                    return;
                } else {
                    // 仍然在当前访次，而且访次还没有结束
                    // 更新访次及页面活动时间及pvn
                    pageActionTime = recentTime;
                    siteActionTime = recentTime;
                    pvNum = cookieOfPt.getValueFromCookies("pvn");
                    // 激活当前页面
                    pageList = cookieOfPt.plPrc(pageID); // 更新当前页面
                    // 更新cookies
                    cookieOfPt.writeCookies();
                    // 激活当页的心跳
                    clearInterval(window["_pt_hb_interval"]);
                    window["_pt_hb_interval"] = setInterval(function() {
                        heartBeatPrc();
                    }, HBTIMES);
                    // 置页面激活标志位
                    activeFlag = true;
                }
            } else if (mousemoveFlag) {
                // 页面处于激活状态，也就是一直保持在该页面，并且此时鼠标移动事件属于激活状态，此时只更新页面活动时间
                pageActionTime = new Date().getTime();
                mousemoveFlag = false;
            }
        }
        */
        /*********************鼠标移动触发事件设置结束**********************************/
        /*********************横屏触发事件设置开始**********************************/
        addEvent(win, "onorientationchange", function(objEvent_){
            rotationFlag = ((win.orientation == undefined || win.orientation == 0) ? 1 : -1);
        });
        /*********************横屏触发事件设置结束**********************************/

        /*********************拖动触发事件设置开始**********************************/
        // 设置拖动标志
        addEvent(doc, "touchmove", function(objEvent_){
            touchmoveFlag = true;
        });
        /*********************拖动触发事件设置结束**********************************/
        /*********************点击开始触发事件设置开始**********************************/
        // 在点击开始后获取点击坐标
        addEvent(doc, "touchstart", function(objEvent_){
            // IE的event是全局变量，但w3c标准里需要由触发事件的对象来调用event
            objEvent_ = objEvent_ || win.event;
            srcElement = objBrowserInfo.getSrcElement(objEvent_);
            // 取得点击的相对坐标
            //mouseCoo = (osID == 0) ? objBrowserInfo.getMouseRC(objEvent_) : objBrowserInfo.getMouseAC(objEvent_);
            mouseCoo = objBrowserInfo.getMouseRC(objEvent_);
        });

        /*********************点击开始触发事件设置结束**********************************/
        /*********************点击事件设置开始*********************************/
        function clickPrc(){
            if(srcElement==null){return false;}
            var domNodeName = srcElement.nodeName.toLowerCase();
            if(domNodeName == 'html'){
                return false;
            }
            var tmpStayTime = 0;// 定义页面停留时间
            //父节点是A的元素(如果本身是A标签,那就是自己)
            var parentAOfThisDom = objPt.parentA(srcElement);
            // if(typeof(parentAOfThisDom)=="object"){
            //     // 如果父节点里有A，则把点击记在A节点上
            //     srcElement = parentAOfThisDom;
            // }

            //获取元素的绝对坐标
            var currentOffset = objBrowserInfo.getOffset(srcElement);
            srcElementAbsLeft = currentOffset.left;
            srcElementAbsTop = currentOffset.top;
            //获取css 选择器路径
            var jqueryCssString = "";
            try{
                jqueryCssString = objPt.getCssPath(srcElement);
            }catch (err){}
            // 如果没过点击冷却时间，则不计该次点击
            var recentTime = new Date().getTime();
            if ((recentTime - clickActionTime) < CLICKINTERVAL && domNodeName != "a") {
                return false;
            }
            if(typeof(parentAOfThisDom)=="object"){
                // 通过onclick方法部署的pt高级监测代码如果被覆盖了，则在点击时触发原来的方法
                var domOnclickContent = parentAOfThisDom.getAttribute("onclick");
                // 节点里有onclick属性且onclick的静态代码里有pt的监测方法且被其他js动态覆盖
                if (domOnclickContent && domOnclickContent.indexOf("_pt_sp_2") > -1 && parentAOfThisDom.onclick && parentAOfThisDom.onclick.toString().indexOf("_pt_sp_2") == -1) {
                    var onclickAry = domOnclickContent.split(";");
                    for(var i = 0; i < onclickAry.length; i++){
                        // 处理setPVTag方法
                        if(onclickAry[i].indexOf("setPVTag") > -1){
                            // 需要注意第一个参数前面会带着_pt_sp_2.push('，第三个参数末尾会带着')符号
                            _pt_sp_2.push(onclickAry[i].replace("_pt_sp_2.push('","").replace('_pt_sp_2.push("','').replace("')","").replace('")',''));
                        }
                        if(onclickAry[i].indexOf("setTrackEvent") > -1){
                            var onclickEventAry = onclickAry[i].split(",");
                            if(onclickEventAry.length == 8){
                                onclickEventAry.pop();
                            }
                            // 需要注意第一个参数前面会带着_pt_sp_2.push('，第三个参数末尾会带着')符号
                            _pt_sp_2.push(onclickEventAry.join("").replace("_pt_sp_2.push('","").replace('_pt_sp_2.push("','').replace("')","").replace('")',''));
                        }
                    }
                }

				//智能事件 - 开始，检测三种特殊的点击
				var setAutoEventString = function () {

					var resultString = "";
					
					// 对svg中的a的href进行处理
					var href = typeof parentAOfThisDom.href == 'object' ? parentAOfThisDom.href.animVal : parentAOfThisDom.href;

					var sendHref = objCommon.encode(href, false).replace(/\(/g, "%28").replace(/\)/g, "%29").replace(/\./g, "%2E");

					if (href == "") {
						//href为空，或者PT_trackEvent没有打开的话不走智能事件
					} else if (href.match(/mailto:/)) {
						if (autoEventList["mailSendings"] == "true") {
							resultString = "Mail,Mailto," + sendHref.toLowerCase() + ",0";
						}
					} else if (href.toLowerCase().match(/\.(msi|pdf|apk|ipa|jar|umd|jad|epub|mobi|iso|tar|zip|rar|gzip|gz|dmg|doc|docx|xls|xlsx|csv|ppt|pptx|exe|txt|pdf|key|numbers|pages)/)) {
						if (autoEventList["fileDownloads"] == "true") {
							var fileType = href.toLowerCase().match(/\.(msi|pdf|apk|ipa|jar|umd|jad|epub|mobi|iso|tar|zip|rar|gzip|gz|dmg|doc|docx|xls|xlsx|csv|ppt|pptx|exe|txt|pdf|key|numbers|pages)/)[1];
							sendHref = sendHref.replace(/(^https?:\/\/)([^/]+)/i, function (word) {
								return word.toLowerCase();
							});
							resultString = "Downloads," + fileType + "," + sendHref + ",0";
						}
					} else if (href.toLowerCase().indexOf("http") == 0) {
						if (autoEventList["outboundLinks"] == "true") {
							var isOutBoundLink = true;
							for (var i = 0; i < domainSet.length; i++) {
								if (href.toLowerCase().indexOf(domainSet[i]) > 0) {
									isOutBoundLink = false;
									break;
								}
							}
							if (isOutBoundLink) {
								sendHref = sendHref.replace(/(^https?:\/\/)([^/]+)/i, function (word) {
									return word.toLowerCase();
								});
								resultString = "Outbound%20Links,Exit," + sendHref + ",0";
							}
						}
					}
					return resultString;
				}();
				
                if(setAutoEventString!="" && PT_trackEvent){
                    // 在生成事件包的内容后，将其放入setTrackEvent的API里发送出去
                    _pt_sp_2.push('setTrackEvent,'+setAutoEventString+',false');
                }
                //智能事件 - 结束
            }

            var customEventContainer;//当前元素能够触发的事件
            // 自定义事件处理 - 开始
            (function(){
                //如果form元素触发event 的方式是focus,需要检测当前点击元素是否是form元素
                if(formElementTriggerEventType=='focus'){
                    for(var j=0;j<allFocusType.length;j++){
                        if(allFocusType[j]==domNodeName){
                            return;
                        }
                    }
                }
                //检查srcElement是否定义事件
                customEventContainer= checkEventList(srcElement,parentAOfThisDom);
            })();
            // 自定义事件处理 - 结束
            var oneOrTwoForSent = 0; // 该变量是用来标识交互元素-1、子节点-2、其他类型节点-0
            if (domNodeName == "a" || domNodeName == "input" || domNodeName == "select" || domNodeName == "embed" || domNodeName == "object" || domNodeName == "textarea" || domNodeName == "button") {
                oneOrTwoForSent=1;
            }
            else if(srcElement.onclick){
                oneOrTwoForSent=1;
            }
            else if((srcElement.childNodes.length==0)||(srcElement.childNodes.length==1 && srcElement.childNodes[0].nodeType!=1 )){
                oneOrTwoForSent=2;
            }
            else {
                oneOrTwoForSent=0;
            }
            var nodeId = oneOrTwoForSent + iframeValue[2] + objCommon.encode(jqueryCssString, false).replace(/\(/g, "%28").replace(/\)/g, "%29").replace(/\./g, "%2E");
            // 重新读取cookies，因为可能被其他的页面更新
            cookieOfPt.readCookies();
            // 判断当前页面是否为激活页面
            if ((cookieOfPt.getValueFromCookies("to_flag") == 1) || !cookieOfPt.isActive()) {
                // 不是激活页面
                if (cookieOfPt.getValueFromCookies("to_flag") == 1 || (+recentTime - +cookieOfPt.getValueFromCookies("sact") > +SILENTTIMES)) {
                    // 如果访次已经结束
                    revisitPrc("pn");
                    return false;
                } else if (cookieOfPt.isNewVisit(visitID, recentTime)) {
                    // 已经换了一个访次
                    revisitPrc("pv");
                    return;
                } else {
                    // 还在当前访次，且还没有结束，则激活该页面
                    activeFlag = true;
                    tmpStayTime = DEFAULTSTAYTIMES; // 由于是刚激活的页面，则计为默认时间
                }
            } else {
                // 当前为激活页面，则直接更新sact，pact，并计算停留时间
                tmpStayTime = recentTime - pageActionTime - (hbCount * HBTIMES);
                if (tmpStayTime < 0 || tmpStayTime > HBTIMES * 1.5) {
                    tmpStayTime = HBTIMES;
                }
            }
            // 更新当前页面
            pageList = cookieOfPt.plPrc(pageID);
            // 更新当前页面及网站的最近操作时间，及点击操作时间
            siteActionTime = recentTime;
            pageActionTime = recentTime; // 本页最近操作时间
            clickActionTime = recentTime;
            pvNum = cookieOfPt.getValueFromCookies("pvn");
            // 重置心跳事件
            if (heatmapFlag) {
                // 如果开启了热图功能
                clearInterval(window["_pt_hb_interval"]);
                window["_pt_hb_interval"] = setInterval(function() {
                    heartBeatPrc();
                }, HBTIMES);
                hbCount = 0;
            }
            // 更新cookies
            cookieOfPt.writeCookies();
            // 阅读线
            var tmpYMax = objBrowserInfo.getYMax();
            rotationFlag = ((win.orientation == undefined || win.orientation == 0) ? 1 : -1)
            if ((rotationFlag == 1) && (tmpYMax > yMaxP)) {
                yMaxP = tmpYMax;
            } else if ((rotationFlag != 1) && (tmpYMax > yMaxM)) {
                yMaxM = tmpYMax;
            }

            var ocData = new BaseStruct(sid,uid,visitID,pageID,pvEventID);
            var id = sid + "." + uid + "." + visitID + "." + pageID + "." + pvEventID;
            var ocstat = +(mouseCoo.x + iframeValue[0]) * rotationFlag + "." + (mouseCoo.y + iframeValue[1]) * rotationFlag 
                + "." + objBrowserInfo.getViewWidth() + "." + objBrowserInfo.getViewHeight()
                + "." + nodeId + ".0"
                + "." + ((rotationFlag == 1) ? objBrowserInfo.getScrollY() : ((objBrowserInfo.getScrollY() + 1) * rotationFlag))
                + "." + ((rotationFlag == 1) ? yMaxP : yMaxM * -1)
                + "." + tmpStayTime
                + "." + (srcElementAbsLeft + iframeValue[0]) + "." + (srcElementAbsTop + iframeValue[1]);
            var ptif = terminalType + '';

            var customEventObj = buildCustomEventObj(customEventContainer);

            var tmpMsg='';
            if(customEventObj){//合并的te包
                tmpMsg = "?id="+id;
                if(customEventObj.stat){//旧版事件
                    tmpMsg+=("&stat="+customEventObj.stat);
                    ocData.addPropery("stat",customEventObj.stat);
                }
                if(customEventObj.eid) {//新版事件
                    tmpMsg+=("&eid="+customEventObj.eid);
                    ocData.addPropery("eid",customEventObj.eid);
                }
                if(heatmapFlag){//带点击的te包
                    tmpMsg+=("&ocstat="+ocstat);
                    ocData.addPropery("ocstat",ocstat);
                }
                pvNum = +pvNum + 1;
                ocData.addPropery("pvn",pvNum);
                ocData.addPropery("ptif",ptif);
                tmpMsg+=("&pvn=" + pvNum);
                tmpMsg+=("&ptif="+ptif);
                if(!objPt.sendPost(teURL,ocData.getJSONRet())){
                    objPt.sendMsgByScript(teURL + tmpMsg);
                }

            }else if(heatmapFlag){
                ocData = new BaseStruct(sid,uid,visitID,pageID,pvEventID);
                ocData.addPropery("stat",ocstat);
                ocData.addPropery("ptif",ptif);

                tmpMsg = "?id="+id+"&stat="+ocstat+"&ptif="+ptif;
                // 清空元素坐标
                srcElementAbsLeft = 0;
                srcElementAbsTop = 0;
                iframeValue = [0, 0, ""];
                // 发送oc包
                if(!objPt.sendPost(ocURL,ocData.getJSONRet())){
                    // 发送oc包
                    objPt.sendMsgByScript(ocURL + tmpMsg);
                }
            }
        }
		
		
		(function () {
		    // 执行用户在加载采集脚本之前定义的反常的setCustomVarV2自定义变量
		    for (var i = 0, len = CustomVarCache.length; i < len; i++) {
		        window[gParam].push('setCustomVarV2', CustomVarCache[i]);
		    }

		    // 执行用户设置的上报用户信息的请求
		    for (var i = 0, len = UserCache.length; i < len; i++) {
		        window[gParam].push('setUser', UserCache[i]);
		    }

		    for (var i = 0, len = ECCache.length; i < len; i++) {
		        window[gParam].push('setEC', ECCache[i]);
		    }
		})()
		
		
		
        var timer;
        var locked=false;
        addEvent(doc, "click", function (objEvent_) {
            // IE的event是全局变量，但w3c标准里需要由触发事件的对象来调用event
            objEvent_ = objEvent_ || win.event;

            // 取得点击的相对坐标
            mouseCoo = objBrowserInfo.getMouseRC1(objEvent_);
            // 超出页面内容范围，不计统计
            if(objBrowserInfo.getPageHeight()>0){
                if (mouseCoo.x <= 0 || mouseCoo.y <= 0 || mouseCoo.x > +objBrowserInfo.getPageWidth() || mouseCoo.y > +objBrowserInfo.getPageHeight())
                    return;
            }
            // 获取触发事件的dom元素对象
            srcElement = objBrowserInfo.getSrcElement(objEvent_);
            if(!locked){
                clickPrc();  
            }
                          
        });
        addEvent(doc, "touchend", function(objEvent_){
            var tmpStayTime = 0;// 定义页面停留时间
            // 如果是拖动的话，不做点击处理
            if (touchmoveFlag) {
                touchmoveFlag = false;
                return;
            }
            // 不合法的坐标，则不处理
            if (mouseCoo.x <= 0 || mouseCoo.y <= 0)
                return;
            // 超出页面内容范围，不计统计
            if ((mouseCoo.x == 0 && mouseCoo.y == 0) || (mouseCoo.x < 0 || mouseCoo.x > objBrowserInfo.getPageWidth() || mouseCoo.y > objBrowserInfo.getPageHeight()))
                return;

            clickPrc();
            locked=true;
            timer&&clearTimeout(timer);
            timer=setTimeout(function(){
                locked=false;
            },500);
        });
        /*********************滚动事件设置开始*********************************/
        // 初始化当前时间，当前滚动条位置以及当前滚动记录串
        var timeB = visitTime, timeN, tmpTime = 0;
        addEvent(win, "scroll", function(objEvent_){
            function isScrolling() {
                var scrolling =true;
                //滚动到头和尾的时候不发送包（禅道TASK 241）

                if(doc.body.clientHeight==0){
                    scrolling= false;
                } else if(objBrowserInfo.getScrollY()<=1){//有的浏览器在顶部的时候此值为1
                    //滚到顶部
                    scrolling= false;
                }else if(objBrowserInfo.getScrollY()+objBrowserInfo.getBrowserHeight()+1>=objBrowserInfo.getPageHeight()){
                    //滚到底部
                    scrolling= false;
                }
                return scrolling;
            }
            // 先判断滚动事件的合法性
            var recentTime = new Date().getTime();
            // 取得当前时间
            timeN = recentTime;
            // 取得停留时间段
            tmpTime = timeN - timeB;
            // 停留时间不到规定时间不计, 但需要保存当前位置和当前时间
            if (tmpTime < +SCROLLINTERVAL) {
                // 保存当前时间
                timeB = timeN;
                return;
            }
            var tmpStayTime = "";
            // 重新读取cookies，因为可能被其他的页面更新
            cookieOfPt.readCookies();
            // 判断当前页面是否为激活页面
            if ((cookieOfPt.getValueFromCookies("to_flag") == 1) || !cookieOfPt.isActive()) {
                // 不是激活页面
                if (cookieOfPt.getValueFromCookies("to_flag") == 1 || (+recentTime - +cookieOfPt.getValueFromCookies("sact") > +SILENTTIMES)) {
                    //if (cookieOfPt.getValueFromCookies("to_flag") == 1) {
                    // 如果访次已经结束
                    revisitPrc("pn");
                    return;
                } else if (cookieOfPt.isNewVisit(visitID, recentTime)) {
                    // 已经换了一个访次
                    revisitPrc("pv");
                    return;
                } else {
                    // 还在当前访次，且还没有结束，则激活该页面
                    activeFlag = true;
                    tmpStayTime = DEFAULTSTAYTIMES; // 由于是刚激活的页面，则计为默认时间
                }
            } else {
                // 当前为激活页面，则直接更新sact，pact，并计算停留时间
                tmpStayTime = recentTime - pageActionTime - (hbCount * HBTIMES);
                if (tmpStayTime < 0 || tmpStayTime > HBTIMES * 1.5) {
                    tmpStayTime = HBTIMES;
                }
            }
            // 更新当前页面
            pageList = cookieOfPt.plPrc(pageID);
            // 更新当前页面及网站的最近操作时间
            siteActionTime = recentTime;
            pageActionTime = recentTime; // 本页最近操作时间
            pvNum = cookieOfPt.getValueFromCookies("pvn");
            // 重置心跳事件
            if (heatmapFlag) {
                clearInterval(window["_pt_hb_interval"]);
                window["_pt_hb_interval"] = setInterval(function() {
                    heartBeatPrc();
                }, HBTIMES);
                hbCount = 0;
            }
            // 更新cookies
            cookieOfPt.writeCookies();
            // 阅读线
            var tmpYMax = objBrowserInfo.getYMax();
            rotationFlag = ((win.orientation == undefined || win.orientation == 0) ? 1 : -1)
            if ((rotationFlag == 1) && (tmpYMax > yMaxP)) {
                yMaxP = tmpYMax;
            } else if ((rotationFlag != 1) && (tmpYMax > yMaxM)) {
                yMaxM = tmpYMax;
            }
            if(isScrolling()){
                // 发送报文
                if (heatmapFlag) {
                    var osData = new BaseStruct(sid,uid,visitID,pageID,pvEventID);
                    osData.addPropery("stat",((rotationFlag == 1) ? objBrowserInfo.getScrollY() : ((objBrowserInfo.getScrollY() + 1) * rotationFlag)) +
                    "." + ((rotationFlag == 1) ? yMaxP : yMaxM * -1) +
                    "." + (objBrowserInfo.getViewHeight() > 1500 ? 1500 : objBrowserInfo.getViewHeight()) + "." + tmpStayTime);

                    osData.addPropery("ptif",terminalType + '');
                    //objBrowserInfo.getViewHeight()值大于1500时，取1500（sid=4255b04a的客户，部分os包中，vh值大于6000，FB-246）
                    if(!objPt.sendPost(osURL,osData.getJSONRet())){
                        var tmp = "?id=" + sid + "." + uid + "." + visitID + "." + pageID + "." + pvEventID +
                        "&stat=" + ((rotationFlag == 1) ? objBrowserInfo.getScrollY() : ((objBrowserInfo.getScrollY() + 1) * rotationFlag)) +
                        "." + ((rotationFlag == 1) ? yMaxP : yMaxM * -1) +
                        "." + (objBrowserInfo.getViewHeight() > 1500 ? 1500 : objBrowserInfo.getViewHeight()) + "." + tmpStayTime +
                        "&ptif=" + terminalType;
                        // 如果开启了热图功能
                        objPt.sendMsg(osURL + tmp);
                    }
                }
            }
            // 保存当前时间
            timeB = timeN;
        });
        /*********************心跳事件设置开始**********************/
        //跨域页面超时后，重置a标签链接，删除私有字段，恢复为原页面的链接
        function resetLinkUrl() {
            var links = doc.getElementsByTagName("a");
            var pt_str = "", pt_tmpHref, tmpUrl;
            for (var l=0; l<links.length; l++) {
                pt_tmpHref = links[l].getAttribute("href");
                if(pt_tmpHref){
                    pt_str = pt_tmpHref.match(/[\#|\?|\&]_pt_link=[^#|^&]*/);
                    if (pt_str) {
                        pt_tmpHref = pt_tmpHref.split(pt_str);
                        tmpUrl = pt_tmpHref[0] + (pt_tmpHref[1] ? pt_tmpHref[1] : "");
                        links[l].setAttribute("href",tmpUrl);
                    }
                }
            }
        }
        window["_pt_hb_interval"] = setInterval(function() {
            heartBeatPrc();
        }, HBTIMES);
        // 发送心跳包
        function heartBeatPrc() {
            // 重新读取cookies，因为可能被其他的页面更新
            cookieOfPt.readCookies();
            // 如果当前页面为非激活页面，则不做任何操作
            if (!cookieOfPt.isActive()) {
                activeFlag = false;
                return;
            }
            var recentTime = new Date().getTime();
            // 判断当前页面是否超时，如果静默时间超过一定时间，则判断该访问结束，并将最后五分钟去掉
            if (recentTime - pageActionTime > (SILENTTIMES + +HBTIMES)) {
                // 超时
                if (multiDomainFlag) {	//http://jira.ptmind.com/browse/FB-601|增加sid=4feafb6a的跨域处理[zhaopengjun 2015-03-26]
                    resetLinkUrl();
                }
                clearInterval(window["_pt_hb_interval"]);
                toFlag = 1;
                activeFlag = false;
                // 更新cookies
                cookieOfPt.writeCookies();
                if ((hbCount + 5) * +HBTIMES < SILENTTIMES) {
                    // 如果hbCount没有被执行过，也就是heartBeatPrc没有被执行，但是仍然超时的话
                    return;
                }
            }
            hbCount++;// 心跳包计数自增
            // 阅读线
            var tmpYMax = objBrowserInfo.getYMax();
            rotationFlag = ((win.orientation == undefined || win.orientation == 0) ? 1 : -1)
            if ((rotationFlag == 1) && (tmpYMax > yMaxP)) {
                yMaxP = tmpYMax;
            } else if ((rotationFlag != 1) && (tmpYMax > yMaxM)) {
                yMaxM = tmpYMax;
            }
            var hbData = new BaseStruct(sid,uid,visitID,pageID,pvEventID);
            hbData.addPropery("stat",((rotationFlag == 1) ? objBrowserInfo.getScrollY() : ((objBrowserInfo.getScrollY() + 1) * rotationFlag)) +
            "." + ((rotationFlag == 1) ? yMaxP : (yMaxM * -1)) +
            "." + objBrowserInfo.getViewHeight() + "." + ((toFlag == 1) ? (-1 * SILENTTIMES + 1) : HBTIMES));
            hbData.addPropery("ptif",terminalType + '');
            if(!objPt.sendPost(hbURL,hbData.getJSONRet())){
                // 发送报文
                var tmp = "?id=" + sid + "." + uid + "." + visitID + "." + pageID + "." + pvEventID
                    + "&stat=" + ((rotationFlag == 1) ? objBrowserInfo.getScrollY() : ((objBrowserInfo.getScrollY() + 1) * rotationFlag))
                    + "." + ((rotationFlag == 1) ? yMaxP : (yMaxM * -1))
                    + "." + objBrowserInfo.getViewHeight() + "." + ((toFlag == 1) ? (-1 * SILENTTIMES + 1) : HBTIMES)
                    + "&ptif=" + terminalType;
                objPt.sendMsg(hbURL+tmp);
            }
        }
        /********************滚动事件(计停留时长)设置结束**************************/
        return false;
    }

    function getABTestString(pure) {
        var tmpABTestStr = "";
        if(optFlag){
            switch (optType){
                case 'GoogleOptimize'://用户开启 GoogleOptimize AB测试，发包增加以下字段
                    if(window.gaData && window.gaData.expId && window.gaData.expVar){
                        tmpABTestStr += gaData.expId+'|p|'+'|p|'+gaData.expVar+'|p|'+'|p|'+optType;
                    }
                    break;
                case 'OptimizelyX':
                    // 存在optimizely，且其包含get方法
                    if(typeof(window["optimizely"]) === "object" && typeof window["optimizely"]["get"] === "function"){
                        // 获取状态
                        var expState = window["optimizely"].get("state");
                        if(expState) {
                            // 获取所有活跃实验的ID数组
                            var activeExpIds = expState.getActiveExperimentIds();
                            for(var d = 0; d < activeExpIds.length; d++) {
                                var expId = activeExpIds[d], // 实验ID
                                    expName = expState.getExperimentStates({"isActive":true})[expId]["experimentName"] || "",  // 实验名称
                                    expVariation = expState.getVariationMap()[expId],
                                    expVid = expVariation["id"],// 版本ID
                                    expVname = expVariation["name"] || "";// 版本名称

                                tmpABTestStr += (d == 0) ? "" : "|o|";
                                tmpABTestStr += expId + "|p|" + expName.substr(0,100) + "|p|" + expVid+"|p|" + expVname.substr(0,100);
                                tmpABTestStr += "|p|" + optType;
                            }
                        }
                    }
                    break;
                case 'Optimizely'://用户开启 optimizely AB测试，发包增加以下字段
                default: // 默认为"Optimizely"
                    if(typeof(optimizely) == "object"){
                        var tpidAry = optimizely["activeExperiments"];
                        if (tpidAry && tpidAry.length > 0) {
                            for (var d=0; d<tpidAry.length; d++) {
                                tmpABTestStr += d == 0 ? "" : "|o|";
                                tmpABTestStr += tpidAry[d]+"|p|"+optimizely["data"]["experiments"][tpidAry[d]].name.substr(0,100)+"|p|"+optimizely["variationIdsMap"][tpidAry[d]][0]+"|p|"+optimizely["variationNamesMap"][tpidAry[d]].substr(0,100);
                                tmpABTestStr += "|p|"+optType;
                            }
                        }
                    }
            }
        }
        if(pure) return  tmpABTestStr ?  objCommon.encode(tmpABTestStr, false):'';
        return tmpABTestStr ? "&op=" + objCommon.encode(tmpABTestStr, false) : '';
    }

    //跨域操作时，修改a标签的链接
    function whandler() {
        var links = doc.getElementsByTagName("a");
        var tmpHref = "";
        if (crossDomainLink == "allManual") {
            for (var x = 0; x < links.length; x++) {
                tmpHref = links[x].getAttribute('href');
                if (tmpHref && links[x].getAttribute("onclick") && links[x].getAttribute("onclick").indexOf("pt_domain") > -1) {
                    //全手动模式：满足条件1、包含onclick属性且值中有pt_domain字段；
                    var lowerCaseHref = tmpHref.toLowerCase();
                    for (var y = 0; y < domainSet.length; y++) {
                        if (lowerCaseHref.indexOf(domainSet[y]) > -1 && (tmpHref.indexOf(loc.hostname) < 0 || tmpHref.indexOf(loc.hostname) > lowerCaseHref.indexOf(domainSet[y]))) {
                            // 如果当前的href包含在跨域域名集内，并且不包含当前主机名或当前主机名在跨域域名的后面[zhaopengjun 2015-03-26]
                            links[x].setAttribute('href',createLinkUrl(tmpHref));
                            break;
                        }
                    }
                }
            }
        } else if (crossDomainLink == "halfManual") {
            for (var x = 0; x < links.length; x++) {
                tmpHref = links[x].getAttribute('href');
                if (tmpHref && tmpHref.match(/^https?:\/\//) && tmpHref.length < 900) {
                    //半手动模式：满足条件1、href值以http开头；2、href值长度小于900。
                    var lowerCaseHref = tmpHref.toLowerCase();
                    for (var y = 0; y < domainSet.length; y++) {
                        if (lowerCaseHref.indexOf(domainSet[y]) > -1 && (tmpHref.indexOf(loc.hostname) < 0 || tmpHref.indexOf(loc.hostname) > lowerCaseHref.indexOf(domainSet[y]))) {
                            // 如果当前的href包含在跨域域名集内，并且不包含当前主机名或当前主机名在跨域域名的后面[zhaopengjun 2015-03-26]
                            links[x].setAttribute('href',createLinkUrl(tmpHref));
                            break;
                        }
                    }
                }
            }
        }
    }
    // 跨域访问创建新的URL地址
    function createLinkUrl(targetUrl) {
        var n = targetUrl.split("#");
        cookieOfPt.readCookies();
        if (cookieOfPt.cookiesValue) {
            var linkTag = cookieOfPt.getValueFromCookies("uid") + "."
                + cookieOfPt.getValueFromCookies("nid") + "."
                + cookieOfPt.getValueFromCookies("vid") + "."
                + cookieOfPt.getValueFromCookies("sact") + "."
                + cookieOfPt.getValueFromCookies("vn") + "."
                + cookieOfPt.getValueFromCookies("pvn") + "."
                //+ cookieOfPt.getValueFromCookies("vr").replace(/\./g, "*_*");
                + (  (win.localStorage && (typeof(win.localStorage.removeItem)=="function") && win.localStorage.getItem(profileID)) ? win.localStorage.getItem(profileID).replace(/\./g, "*_*").replace(/\?/g, "*_wh_*") : "");
            if (n.length == 1) {
                // 后面没有锚点，则直接加上锚点参数
                targetUrl += "#_pt_link=" + linkTag;
            } else if (crossDomainLink == "allManual" || crossDomainLink == "halfManual") {
                // 后面有锚点，则在锚点前加入参数（用?或者&）
                targetUrl = n[0] + ((targetUrl.indexOf("?") == -1) ? "?" : "&") + "_pt_link=" + linkTag + "#" + n[1];
            }
        }
        return targetUrl;
    }
    /*********************模拟重登录处理开始**********************************/
    function revisitPrc(type,sentPage,sentPageID) {
        var pageID_ = sentPageID ? sentPageID : pageID;
        var page_ = sentPage ? sentPage: page;
        var recent = new Date(), recentTime = recent.getTime();//定义的recentTimeDate变量没有用到，所以给删除掉了
        if (type != "vpv") {
            if (recentTime - pageActionTime < 10000) {
                return;
            }
        }
        // 重新读取cookies
        cookieOfPt.readCookies();
        // 需要重置一些值
        yMax = objBrowserInfo.getYMax();
        toFlag = 0;
        activeFlag = 1;
        // uid,page,pageID都可以重用，pageList重置
        pageAccessTime = recentTime; // 页面初访时间
        siteActionTime = recentTime; // 登录网站最近操作时间（包括此次的加载代码）
        pageActionTime = recentTime; // 本页最近操作时间
        if (type == "pn") {
            // 作为一个新访次
            isNV = "1";
            visitNum = cookieOfPt.getValueFromCookies("vn");
            isNID = cookieOfPt.getIsNID();
            pageList = "";
            visitID = objCommon.createID(uid + page_ + siteActionTime + "v"); // 访次事件ID
            visitNum = +visitNum + 1; //
            pvNum = 1;
        } else {
            // 作为已经开始的访次的新pv
            pageList = cookieOfPt.getValueFromCookies("pl");
            visitID = cookieOfPt.getValueFromCookies("vid");
            pvNum = cookieOfPt.getValueFromCookies("pvn");
            pvNum = pvNum ? (+pvNum + 1) : 1;
        }
        pvEventID = objCommon.createID(uid + visitID + page_ + pageAccessTime + "v"); // 页面访问ID
        pageList = cookieOfPt.plPrc(pageID); // 登录当前页面，不停止原有的激活状态
        // 更新cookies
        cookieOfPt.writeCookies();
        //======================cookies处理结束==========================================
        var pnvData = new BaseStruct(sid,uid,visitID,pageID_,pvEventID);
        pnvData.addPropery("stat",((type == "pn") ? ((+visitNum == 0) ? 1 : +visitNum) : pvNum) + "." + ((rotationFlag == 1) ? objBrowserInfo.getScrollY() : ((objBrowserInfo.getScrollY() + 1) * rotationFlag)) +
        "." + yMax * rotationFlag + "." + objBrowserInfo.getViewHeight() +
        "." + 0 +
        "." + 0 +
        ((type == "pn") ? "" : ("." + visitNum)));

        pnvData.addPropery("ref","");
        type == "pn" && pnvData.addPropery("vref",objCommon.encode(visitRef, false));
        pnvData.addPropery("p",objCommon.encode(page_.replace(/&/g, "*&*"), false));
        pnvData.addPropery("tl",title);
        adParamStr && pnvData.addPropery("cad",adParamStr);
        pnvData.addPropery("ptif",terminalType + objBrowserInfo.getSysInfo());
        getABTestString(true) && pnvData.addPropery("op",getABTestString(true));

        //生成URL传参串
        // 网站ID+用户ID+页面+访次ID+页面访问ID
        ptq = "?id=" + sid + "." + uid + "." + visitID + "." + pageID_ + "." + pvEventID
            + "&stat=" + ((type == "pn") ? ((+visitNum == 0) ? 1 : +visitNum) : pvNum) + "." + ((rotationFlag == 1) ? objBrowserInfo.getScrollY() : ((objBrowserInfo.getScrollY() + 1) * rotationFlag))
            + "." + yMax * rotationFlag + "." + objBrowserInfo.getViewHeight()
            + "." + 0
            + "." + 0
            + ((type == "pn") ? "" : ("." + visitNum))
            + "&ref="
            + ((type == "pn") ? "" : ("&vref=" + objCommon.encode(visitRef, false)))
            + "&p=" + objCommon.encode(page_.replace(/&/g, "*&*"), false) + "&tl=" + title
            + (adParamStr ? ("&cad=" + adParamStr) : "")
            + "&ptif=" + terminalType;
        ptq += objBrowserInfo.getSysInfo();
        ptq +=getABTestString();
        for(var i=0;i<customVarList.length;i++){
            if(customVarList[i][2]=="cookie"){
                var cookieOfCustomVar = objHttpCookies.getValue(customVarList[i][1]);
                if(cookieOfCustomVar){
                    ptq += "&"+customVarList[i][0]+"="+objCommon.encode(cookieOfCustomVar,false);
                    pnvData.addPropery(customVarList[i][0],objCommon.encode(cookieOfCustomVar, false));
                }
            }else{
                ptq += "&"+customVarList[i][0]+"="+objCommon.encode(customVarList[i][1],false);
            }
        }

        if(PageViewVar) {
            ptq += '&pvid=' + encodeURIComponent(PageViewVar);
            pnvData.addPropery("pvid",encodeURIComponent(PageViewVar));
        }
        if(!objPt.sendPost(type=="pn"?pnURL:pvURL,pnvData.getJSONRet())){
            objPt.sendMsg(((type == "pn") ? pnURL : pvURL) + ptq);
        }
        //}
        toFlag = 0;
        if (multiDomainFlag && type != "vpv") {	//http://jira.ptmind.com/browse/FB-601|增加sid=4feafb6a的跨域处理[zhaopengjun 2015-03-26]
            whandler();
        }
    }
    /*********************模拟重登录处理结束**********************************/
    /****************************************************************************************************************************************************************************/
    function definePrc(ary) {
        //try {
        if (ary.length > 0) {
            for (var i = 0, len = ary.length; i < len; i++) {
                if (ary[i] && typeof ary[i] === 'object') {
                    var pre = ary[i - 1];
                    if (pre) {
                        switch (pre) {
                            case "setUser":
                                UserCache.push(ary[i]);
                                break;
                            case "setPageViewVar":
                                PageViewVar = ary[i].data ? JSON.stringify(ary[i].data) : '';
                                break;
                            case "setEC":
                                ECCache.push(ary[i]);
                                break;
                            case "setCustomVarV2":
                                CustomVarCache.push(ary[i]);
                                break;
                        }
                        ary[i] = null;
                        continue;
                    }
                }
				
                var tmpIndex = ary[i].indexOf(",");
                //2016.3.25凌晨3点多发现一个莫名recordsource，放到了ary里，得先注释掉下面的判断
                //if (tmpIndex < 0){
                //console.log("ptmind_debug:  "+"function definePrc tmpIndex<0");
                //return false;
                //}
                if (!execPrc(ary[i].slice(0, tmpIndex), ary[i].slice(tmpIndex + 1))) {	
                    return false;
				}
            }
        }
        return true;
        //} catch (ex) {
        //    return false;
        //}
    }
    function execPrc(functionStr, paraStr) {
        if (!paraStr){        // 如果参数为空则报错退出
            //console.log("ptmind_debug:  "+"Parameter is empty");
            return false;
        }
        switch (functionStr) {
            case "setOuterIframeEnabled":
                enableOutIframe = paraStr == "1";
                break;
            case "setEngageEnabled":
                enableEngage = paraStr == "1";
                break;
            case "setServer":
                serverNum = paraStr ? +paraStr : 0;

                //重新生成发送地址
                toURL = (sid == '6c75a350') ? (protocol + 'rtcollect.ptengine.jp') : (protocol + serverList[serverNum]), //针对乐天证券sid迁移至rtcollect.ptengine.jp [2014-08-05] http://jira.ptmind.com/browse/FB-116
                pnURL = toURL + "/pn", // 处理页面新访问的URL
                pvURL = toURL + "/pv", // 处理页面非新访问的URL
                ocURL = toURL + "/oc", // 处理点击事件的URL
                osURL = toURL + "/os", // 处理滚动事件的URL
                hbURL = toURL + "/hb", // 处理心跳事件的URL
                teURL = toURL + "/te"; // 处理用户自定义事件
                break;
            // 设定广告参数
            case "setAdParam":
                company = "cellant";
                paraStr = paraStr.replace(/^\|*/, "").replace(/\|*$/, "");
                adParamAry = paraStr ? paraStr.split("|") : "";
                break;
            //设置广告参数（上面哪个不是通用的广告参数，而是特殊对应）
            case "setCamParam":
                camParamAry = paraStr.split(",");
                break;
            // 设定URL虚拟参数
            case "setURL":
                urlMark = paraStr;
                break;
            // 设定是否忽略广告(utm)参数
            case "setIgnoreCampaign":
                ignoreCampaign = paraStr.toLowerCase() == "true";
                break;
            // 设定虚拟url
            case "setVPV":
                //vUrl = initPage + "#" + paraStr.toLowerCase().split(",")[0];
                //if (paraStr.toLowerCase().split(",").length > 1 && paraStr.toLowerCase().split(",")[1] == "replace") {
                vUrl = paraStr.toLowerCase().split(",")[0];
                //}
                break;
            // 设定虚拟url
            case "setVPT":
                vTitle = paraStr;
                break;
            // 设定账户名
            case "setAccount":
                sid = paraStr.toLowerCase();
                break;
            // 设定账户名
            case "setSID":
                sid = paraStr.toLowerCase();
                break;
            //是否是测试网站
            case "isTestWeb":
                if(paraStr == "true" && sid!=""){
                    testSID[sid] = true;
                }
                break;
            // 设定域设置
            case "useHttpCookie":
                useHttpCookie = paraStr.toLowerCase()=="false"? false : true;
                break;
            case "setDomain":
                return (function() {
                    domainName = "";

                    var temp = paraStr.split(',');
                    multiDomainFlag = (temp.length > 1);
                    //http://jira.ptmind.com/browse/FB-629|对域名进行排序，使domainName值按长度排序，避免abc.com和abc.com.cn的错误[zhaopengjun 2015-04-07]
                    temp.sort(function (a, b) {
                    	return a.replace(/^https?:\/\//, "").length > b.replace(/^https?:\/\//, "").length ? 1 : -1
                    });
                    for (var i = 0; i < temp.length; i++) {
                    	domainSet.push(temp[i].replace(/^https?:\/\//, ""));
                    	if (temp[i].match(/https?:\/\//) && temp[i].match(/https?:\/\//)[0] != location.protocol + "//") {
                    		continue;
                    	} // 设定的域名只兼容某一种协议
                    	if (location.hostname.indexOf(temp[i].replace(/^https?:\/\//, "")) > -1) {
                    		domainName = temp[i].replace(/^https?:\/\//, "");
                    	}
                    }
                    if (paraStr == "default" || location.href.slice(0, 4) != "http") { // 兼容原ptengine的代码
                    	domainName = location.href.toLowerCase().split("://")[1].split("?")[0].split("/")[0];
                    	domainSet.push(domainName);
                    }
                    return true;
                })();
                break;
            case "setAutoEvent":
                if(paraStr.split(",").length==2){
                    autoEventList[paraStr.split(",")[0]] = paraStr.split(",")[1];
                }
                break;
            case "setEventReport":
                PT_trackEvent = paraStr=="true";
                break;
            case "setAutoFetchMatch":
                setAutoFetchMatch(paraStr)
                break;
            default:
                break;
        }
        return true;
    }

    function setAutoFetchMatch(paraStr){
        var params = paraStr.split(',');
        var schema = params[0],//模式 URL ,COOKIE 等
        subSchema = params[1],//子模式 根据模式类型比如queryString，hash,path等 确定是否存在，为空则直接占位即可
        // type=params[2],//schema 值的类型 普通字符串，正则表达式等
        name=params[2], //值
        ret = null;
        setTimeout(function(){
            if(schema){
                switch(schema){
                    case 'URL':
                        if(subSchema){
                            ret = getQueryString(name,subSchema);
                        }
                    break;
                    //TODO:后期会增加其它schema
                }
            }
    
            if(ret) {
                try{
                    if(!sessionStorage.getItem(paraStr)){
                        sessionStorage.setItem(paraStr,'1');
                        _pt_sp_2.push('setUser',{
                            accountid:ret
                        });
                    }
                }catch(ex){}
            }
        },0)

        
    }
    function getQueryString(name,fromWhere) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
        var input = loc.search.substr(1);
        var ret = null;
        //从query 中获取
        ret = input.match(reg);
        if (ret != null) {
            return decodeURIComponent(ret[2]);
        }
        //从path、hash 中获取
        reg = new RegExp("(^|/)" + name + "/([^/]*)(/|$)", "i");
        var props = ['pathname', 'hash'];
        for (var i = 0, j = props.length; i < j; i++) {
            input = loc[props[i]].substr(1);
            ret = input.match(reg);
            if (ret != null) {
                return decodeURIComponent(ret[2]);
            }
        }

        return null;
    }
    
    /*
     * 下面列了三种存储方式userData，LocalStorageState，httpCookie三种存储策略
     * 上层调用地方可以在三种之间可以随意替换策略，而无需任何其他修改
     */
    function Ie6to8State(httpCookieState){
        var userData = null;
        this.init = function(){
            if(!userData){
                try{
                    userData = doc.createElement('input');
                    userData.type = "hidden";
                    userData.addBehavior ("#default#userData");
                    doc.body.appendChild(userData);
                }catch(e){return false;}
            };
            return true;
        }
        this.isEnabled = function() {return true;}
        this.clearOtherCookie=function(){
            var tmpCookie = new HttpCookieState();
            if(tmpCookie.getValue(COOKIESNAME)){
                tmpCookie.setValue(COOKIESNAME,"",{expires: ""});
                tmpCookie.setValue(CLICKCOOKIESNAME,"",{expires: ""});
            }
        }
        this.setValue = function(name, value, options) {
            if( name == SESSIONCOOKIESNAME ){httpCookieState.setValue(name, value, options);return;}
            try{
                if(this.init()){
                    var o = userData;
                    o.load(name);
                    if(value) o.setAttribute("code", value);
                    var d = new Date(), e = 30;
                    d.setDate(d.getDate()+e);
                    o.expires = d.toUTCString();
                    o.save(name);
                }
            }catch (ex){}
        }
        this.getValue = function(name) {
            if( name == SESSIONCOOKIESNAME ){return httpCookieState.getValue(name);}
            if(this.init()){
                try{
                    var o = userData;
                    o.load(name);
                    return o.getAttribute("code");
                }catch (ex){return null;}
            }
        }
    }
    function LocalStorageState(){
        this.isEnabled = function() {
            return win.localStorage && (typeof(win.localStorage.removeItem)=="function");
        }
        this.clearOtherCookie=function(){
            var tmpCookie = new HttpCookieState();
            if(tmpCookie.getValue(COOKIESNAME)){
                tmpCookie.setValue(COOKIESNAME,"",{expires: ""});
                tmpCookie.setValue(CLICKCOOKIESNAME,"",{expires: ""});
            }
        }
        this.getValue = function(name){
            return win.sessionStorage.getItem(name) || win.localStorage.getItem(name);
        }
        this.setValue = function(name, value, options) {
            if(options.expires ==""){
                win.sessionStorage.setItem(name,value);
                win.localStorage.removeItem(name);
            }
            else{win.localStorage.setItem(name,value);}
        }
    }
    function HttpCookieState(){
        this.isEnabled = function() { return na.cookieEnabled}
        this.clearOtherCookie=function(){}
        this.getValue = function(name) {
            var cookieValue = "";
            if (!this.isEnabled()) {
                hasHttpCookies = false;
            }
            if (doc.cookie && doc.cookie != '') {
                var cookies = doc.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = objCommon.trim(cookies[i]);
                    if (cookie.substring(0, name.length + 1) == (name + '=')) {
                        if ((name != COOKIESNAME) || ((name == COOKIESNAME) && (cookie.indexOf("pt1pt") < 0) && (cookie.indexOf("pt0pt") < 0) )) {// 不是主cookie，或者如果是主cookie的话，必须满足规则
                            cookieValue = cookie.substring(name.length + 1);
                            break;
                        }
                    }
                }
            }return cookieValue;
        }
        this.setValue = function(name, value, options) {
            if (!this.isEnabled()) {
                hasHttpCookies = false;
                return;
            }
            var expires = '';
            if (options.expires && (typeof options.expires == 'number' || options.expires.toUTCString)) {
                var date;
                if (typeof options.expires == 'number') {
                    date = new Date();
                    date.setTime(date.getTime() + (options.expires * 24 * 60 * 60 * 1000));
                }
                else {date = options.expires;}
                expires = '; expires=' + date.toUTCString();
            }
            //var domain = options.domain ? '; domain=' + (options.domain) : '';
            //var secure = options.secure ? '; secure' : '';
            //var path = options.path ? '; path=' + (options.path) : '';
            //doc.cookie = [name, '=', value, expires, path, domain, secure].join('');
            doc.cookie = name+'='+value+expires+'; path=/; domain='+domainName;
        }
    };
    // cookies操作模块
    function CLSCookies() {
        var isGiveup = false;
        //策略模式，配置不同的存储策略
        this.localDataType = "";
        if(!useHttpCookie && na.userAgent.toLowerCase().match(/msie\s([2-8]+?\.[\d]+)/ig)) {//userData
            this.localDataType = new Ie6to8State(new HttpCookieState());
        }else if(!useHttpCookie && win.localStorage && win.sessionStorage && typeof(win.localStorage.removeItem)=="function" && typeof(win.sessionStorage.removeItem)=="function"){//用localStorage
            var k="pt_test";
            //写入两个storage值
            win.sessionStorage.setItem(k+"sk",k+"sv");
            win.localStorage.setItem(k+"lk",k+"lv");
            if(win.sessionStorage.getItem(k+"sk")==k+"sv" && win.localStorage.getItem(k+"lk")==k+"lv"){
                //只有可以读取刚才存取的值的，才会改为使用storage方式作为存储
                this.localDataType = new LocalStorageState();
            }else{
                var isGiveup = true;
                //this.localDataType = new HttpCookieState();
            }
            //销毁刚才生成的storage值
            win.sessionStorage.removeItem(k+"sk");
            win.localStorage.removeItem(k+"lk");
        }else if(!useHttpCookie){
            var isGiveup = true;
        }else{
            this.localDataType = new HttpCookieState();
        }
        if(isGiveup){
            this.clearOtherCookie = function(){}
            this.isEnabled = function() { return false;}
            this.setValue = function(name, value, options) {}
            this.getValue = function(name) {return "";}
        }else{
            this.clearOtherCookie = function(){
                this.localDataType.clearOtherCookie();
            }
            this.isEnabled = function() {
                return this.localDataType.isEnabled();
            }
            this.setValue = function(name, value, options) {
                this.localDataType.setValue(name, value, options);
            }
            this.getValue = function(name) {
                return this.localDataType.getValue(name);
            }
        }
    }

    /**
     * 访客信息采集模块
     * @constructor
     */
    function CLSBrowserInfo() {
        this.getSysInfo = function(){
            var sysInfo = []; // UID字符组
            //当宽度大于高度的时候，
            if(this.getTerminalType() == 1 || this.getTerminalType() == 4) {
                //对于手机和平板，数值小的就是宽度，数值大的就是高度。永远统计竖屏状态
                sysInfo.push("." + [this.getViewWidth(),this.getScreenHeight()].sort()[0]);// 屏幕宽度
                sysInfo.push("." + [this.getViewWidth(),this.getScreenHeight()].sort()[1]);// 屏幕高度
            }else{
                sysInfo.push("." + this.getScreenWidth());// 屏幕宽度
                sysInfo.push("." + this.getScreenHeight());// 屏幕高度
            }
            sysInfo.push("." + (win.screen.colorDepth||0));        // 屏幕色深，取得屏幕信息（width*length*color）
            sysInfo.push("." + this.getTimezone().replace(/\./g, "_"));  // 时区, 将小数点替换成_是为了不合信息串中的小数点冲突
            sysInfo.push("." + (na.platform||"").replace(/\./g, "_").toLowerCase());                     // 取得系统平台
            sysInfo.push("." + (na.language||na.browserLanguage||"").replace(/\./g, "_").toLowerCase()); // 取得浏览器语言
            sysInfo.push("." + (doc.characterSet || doc.charset ||"").replace(/\./g, "_").toLowerCase());// 取得浏览器字符集
            /*合并成URL传参时用的信息串*/
            return sysInfo.join("");//paraStr
        }
        this.getUidStr = function(){
            try {
                var uidStr = [this.getSysInfo()]; // UID字符组
                // 取得UA
                uidStr.push("&ua=" + objCommon.encode((na.userAgent || ""), false));
                // 浏览器宽度
                uidStr.push("&bw=" + (doc.documentElement.clientWidth || doc.body.clientWidth || 0));
                // 浏览器高度
                uidStr.push("&bh=" + objBrowserInfo.getBrowserHeight());
                // 通用插件信息
                uidStr.push("&pi=" + objBrowserInfo.getPlugins());
                // 当次访问时间
                uidStr.push("&ts=" + visitTimeDate);
                var str = uidStr.join("");
                if (!str) {     // 判断uid是否为空，如果为空，通过时间和随机数重新创建uid
                    str = (new Date()).getTime() + "" + Math.random();
                }
                return str;
            } catch (ex) {
                return (new Date()).getTime() + "" + Math.random();
            }
        }
        // 取得title
        this.getTitle = function() {
            try {
                var tmpTitle = (doc.getElementsByTagName("title")[0] && doc.getElementsByTagName("title")[0].innerHTML) || doc.title;
                tmpTitle = objCommon.trim(tmpTitle.split("#")[0]);
                // 设置虚拟标题
                if(vTitle){
                    tmpTitle = vTitle;
                }
                return objCommon.encode(tmpTitle, false);
            } catch (ex) {
                return "";
            }
        }
        // 判断ref的类型
        this.getRefType = function(ref) {
            if (!ref) {
                return 0;
            } else {
                var tmpHost = ref.split("?")[0].toLowerCase();
                for (var i = 0; i < domainSet.length; i++) {
                    var hrefProcl = tmpHost.split("://")[0];
                    if (!domainSet[i].match(/^https?:\/\/.*/) && tmpHost.indexOf(domainSet[i]) > -1) {
                        // 设定的域名兼容两种协议且域名合法
                        return 0;
                    } else {
                        // 设定的域名只支持一种协议
                        var domainProcl = domainSet[i].split("://")[0];
                        if (hrefProcl == domainProcl && tmpHost.indexOf(domainSet[i].split("://")[1]) > -1) {
                            // 协议相同，则再进行域名的包含验证，域名合法时
                            return 0;
                        }
                    }
                }
                return 1;
            }
        }
        // 取得流量来源
        // 返回 {"flag":0, "referrer":""}; 0:直接来源或者站内 | 1:外链
        this.getRef = function() {
            try {
                var tmpRef = {
                    "flag": 0,
                    "referrer": ""
                };
                //zpj:FB-148 CV流程监测问题的特殊对应
                var tmpReferrer = doc.referrer;
                if (tmpReferrer || (funnelPage && funnelRef)) {
                    if (funnelPage) {
                        tmpReferrer = funnelRef ? funnelRef : "*"+tmpReferrer+"*";
                    }
                    var tempRefArray = tmpReferrer.match(/^(\S+:\/\/)?([^\/|\?|\#]+)(\S*)/);
                    tmpRef["referrer"] = tempRefArray[1].toLowerCase()+tempRefArray[2].toLowerCase()+tempRefArray[3];
                    if (tmpRef["referrer"]) {
                        tmpRef["referrer"] = tmpRef["referrer"].split("#")[0].replace(/(^\s*)/g, "").replace(/(\s*$)/g, "");
                        if (tmpRef["referrer"].indexOf("?_randomTest") > -1) {
                            // 删除测试后缀
                            tmpRef["referrer"] = tmpRef["referrer"].split("?_randomTest")[0];
                        }
                        // 删除最后的/号，或者以//开始的字符串
                        if(sid!="7f21ceb9"  && sid!="2f120b77"){
                            tmpRef["referrer"] = tmpRef["referrer"].replace(/\/*$/, "");
                        }
  
                        var tmpHost = tmpRef["referrer"].split("?")[0].toLowerCase();
                        // 判断是ref是否在域名范围内
                        for (var i = 0; i < domainSet.length; i++) {
                            var hrefProcl = tmpHost.split("://")[0];
                            if (!domainSet[i].match(/^https?:\/\/.*/) && tmpHost.indexOf(domainSet[i]) > -1) {
                                // 设定的域名兼容两种协议且域名合法
                                //tmpRef["referrer"] = "";
                                return tmpRef;
                            } else {
                                // 设定的域名只支持一种协议
                                var domainProcl = domainSet[i].split("://")[0];
                                if (hrefProcl == domainProcl && tmpHost.indexOf(domainSet[i].split("://")[1]) > -1) {
                                    // 协议相同，则再进行域名的包含验证，域名合法时
                                    //tmpRef["referrer"] = "";
                                    return tmpRef;
                                }
                            }
                        }
                        // 如果没有直接返回结果，说明这是个外部来源，则要创建新的访次
                        if (!funnelPage) {
                            tmpRef["flag"] = 1;
                        }
                    }
                }
                // 直接输入来源不影响当前的访次
                return tmpRef;
            } catch (ex) {
                return tmpRef;
            }
        }
        // 获得插件信息
        this.getPlugins = function() {
            var tmp = "";
            var np = na.plugins;
            if (np.length != 0) {
                var plist = new Array();
                for (var i = 0; i < np.length; i++) {
                    plist[i] = np[i].name + ";" + np[i].description + ";" + np[i].filename + ";";
                    for (var n = 0; n < np[i].length; n++) {
                        plist[i] += "(" + np[i][n].description + ";" + np[i][n].type + ";" + np[i][n].suffixes + ")";
                    }
                    plist[i] += ".";
                }
                tmp = plist.sort().join("");
            }
            return tmp;
        }
        //设置URL合并
        this.setURLMerger = function(urlStr) {
            var allPageInfo = window['allPageInfo']||[];
            /*将window['allPageInfo']替换成一个二维数组，替换完成后，每一个域名三个参数的顺序依次是1、去除锚点。2、去除www。3、去除默认网址。4、默认网址文件名称。5、去除URL末尾斜杠
             例如
             var allPageInfo = [
             ["whr.com",true,false,false,'index.html',false]
             ];
             */
            //用域名长度排序一下
            /*allPageInfo = allPageInfo.sort(function(a,b){	//注释掉：主域合并后，这段排序已经不需要了——zpj_2014.12.11
             return a[0].length<b[0].length;
             });*/

            function isTrueMatch(url, domainName) {	//判断当前URL和客户设置的域名是否匹配
                var protocol=domainName.match(/^https?:\/\//);
                return protocol ? (url.indexOf(protocol[0]) == 0 && url.indexOf(domainName.substring(protocol[0].length)) > -1) : (url.indexOf(domainName) > -1);
            }
            var tmp = urlStr;
            for(var i=0;i<allPageInfo.length;i++){
                if(isTrueMatch(urlStr, allPageInfo[i][0])){
                    //去锚点
                    if(allPageInfo[i][1]){
                        tmp = tmp.replace(/\#[^#|\$|\?]*/g,"");
                        //tmp = tmp.replace(/#[^#\$\?\/]*$/g,"");//设置URL合并的锚点正则修改，暂时没更新线上
                    }
                    if(allPageInfo[i][2]){
                        tmp = tmp.replace(/^(http:\/\/|https:\/\/)?www./,"$1");
                    }
                    if(allPageInfo[i][3]){
                        tmp = tmp.replace(new RegExp("([^\#|\$|\?]*)"+allPageInfo[i][4]+"(\S*)"),"$1$2");
                    }
                    URLTrimFlag = (URLTrimFlag == "tmpUrlAPI") ? "tmpUrlAPI" : (allPageInfo[i][5] == false) ? false : true;
                    break;
                }
            }
            return tmp;
        }
        //取得当前路径
        this.getPage = function() {    //作为一个get开头的函数，居然里面有赋值操作(给title赋值)。必须找机会分离
            var i, tmpArray = [], tmpValue = "";
            var tmp = (loc.protocol+"//"+loc.host).toLowerCase()+loc["pathname"]+loc["search"]+loc["hash"];
            
            if(!tmp){return "";}

            // 去除由于"多域名处理"携带着#_pt_link=或?/&_pt_link=参数
            if (domainSet.length>1) {
                var reg1 = new RegExp(/(\?|\&|\#)_pt_link=([^\&|\#]*)(\&|\#)?/);
                if(tmp.match(reg1)){
                    multiLinkTag = tmp.match(reg1)[2];
                    if(tmp.match(reg1)[3]=="&"){
                        tmp = tmp.replace(reg1,"$1");
                    }else{
                        tmp = tmp.replace(reg1,"$3");
                    }
                }
            }
            // 删除测试后缀
            tmp =tmp.replace(/\?_randomTest=\S*/,"")//    true                ?     tmp.replace(/\?_randomTest=\S*/,"")     :tmp;

            // 设置虚拟URL
            if(vUrl){
                tmp = vUrl;
            }

            tmp = this.setURLMerger(tmp);	//URL合并，修改传入的参数，原参数为loc.href，改为tmp[zhaopengjun 2015-04-28]

            /*
             * 针对company的特殊对应
             */
            switch (company) {
                case "cellant":
                    if (adParamAry) {
                        // 去除尾部的#
                        tmp = tmp.split("#")[0];
                        // 有广告参数时
                        var headChar = "";
                        for (i = 0; i < adParamAry.length; i++) {
                            headChar = "";
                            if (tmp.indexOf("?" + adParamAry[i] + "=") > -1) {
                                headChar = "?";
                            } else if (tmp.indexOf("&" + adParamAry[i] + "=") > -1) {
                                headChar = "&";
                            }
                            if (headChar) {
                                adParamFlag = true;
                                if (adParamStr)
                                    adParamStr += ",";
                                tmpArray = tmp.split(headChar + adParamAry[i] + "=");
                                tmpValue = tmpArray[1] ? tmpArray[1].split("&")[0] : "";
                                adParamStr += adParamAry[i] + ":" + tmpValue;
                                tmp = tmpArray[0] + headChar + tmpArray[1].slice(tmpValue.length + 1);
                            }
                        }
                        // 删除最后的?号和&号
                        tmp = tmp.replace(/\?*$/, "").replace(/\&*$/, "");
                    }
                    break;
                case "oisix":
                case "oisix_hk":
                case "oisix_gochimaru":
                    var paramAry = [];
                    if (company == "oisix") {
                        paramAry = ["utm_referrer", "utm_source", "utm_medium", "utm_term", "utm_content", "utm_campaign", "sessionid", "urlserverid", "SESSIONISNEW", "k", "tk", "KAKUNINJIKAN", "screenmode", "OVRAW", "OVKEY", "OVMTC", "OVADID", "OVKWID", "OVCAMPGID", "OVADGRPID", "SESSIONISNEW", "jid", "KENSAKUMOZIFLG", "KENSAKUMOZIJOUKEN", "searchValue", "param", "faqSearchKeyword", "startNum", "maxDisplayNum", "detail", "mi2", "roadid", "cart", "ref", "utm_expid"];
                    } else if (company == "oisix_hk") {
                        paramAry = ["lcs_id", "tsuka_conv", "offset", "a", "x", "y", "mi2"];
                    } else if (company == "oisix_gochimaru") {
                        paramAry = ["vos", "utm_referrer", "utm_source", "utm_medium", "utm_term", "utm_content", "utm_campaign", "sessionid", "urlserverid", "SESSIONISNEW", "k", "tk", "KAKUNINJIKAN", "screenmode", "OVRAW", "OVKEY", "OVMTC", "OVADID", "OVKWID", "OVCAMPGID", "OVADGRPID", "SESSIONISNEW", "jid", "KENSAKUMOZIFLG", "KENSAKUMOZIJOUKEN", "searchValue", "param", "faqSearchKeyword", "startNum", "maxDisplayNum", "detail", "mi2", "roadid", "cart", "ref", "utm_expid"];
                    }
                    var headChar = "";
                    for (i = 0; i < paramAry.length; i++) {
                        headChar = "";
                        if (tmp.indexOf("?" + paramAry[i] + "=") > -1) {
                            headChar = "?";
                        } else if (tmp.indexOf("&" + paramAry[i] + "=") > -1) {
                            headChar = "&";
                        }
                        if (headChar) {
                            tmpArray = tmp.split(headChar + paramAry[i] + "=");
                            tmpValue = tmpArray[1] ? tmpArray[1].split("&")[0] : "";
                            tmp = tmpArray[0] + headChar + tmpArray[1].slice(tmpValue.length + 1);
                        }
                    }
                    tmp = tmp.replace(/\?*$/, "").replace(/\&*$/, "");//删除最后的?号和&号
                    break;
               
            }

            // 是否通过外部API:setURL设置锚点
            if (urlMark) {
                tmp += "#" + urlMark;
            }
            // 删除最后的/号，或者以//开始的字符串
            if(sid!="7f21ceb9" && sid!="2934b1d1" && sid!="2161b761" && sid!="2f120b77" && URLTrimFlag != "tmpUrlAPI" && URLTrimFlag){
                tmp = tmp.replace(/\/*$/, "");
            }
            if(sid=="67a379c7"){
                tmp = tmp.replace(/\/([\?|#])/,"$1");
            } else if (sid=="6c75a350" && URLTrimFlag){	//http://jira.ptmind.com/browse/FB-499 ,特殊对应乐天证券，所有url末尾加斜杠
                if (tmp.indexOf("#") == -1 && tmp.indexOf("?") == -1) {
                    tmp = tmp.substr(-1) != "/" ? (tmp + "/") : tmp;
                }
            }
            //tmp = tmp.replace(/\/([\?|#])/,"$1");
            return tmp;
        }
        // 根据系统平台类型判断是否为PC
        this.isPCByPlat = function() {
            var platForm = na.platform.toLowerCase();
            if (platForm.indexOf("win") > -1){return true;}
            var listIn = ["mac68k","macppc","macintosh","macintel"];
            for(var i=0;i<listIn.length;i++){
                if(platForm==listIn[i]){return true;}
            }
            return false;
        }
        this.isPCByOSList = function(uaArg) {
            var pcOS = ["AIX", "Amiga", "BeOS", "DragonFly", "FreeBSD", "GNU", "Haiku", "HP-UX", "IRIX", "Joli", "Java", "Macintosh", "Minix", "MorphOS", "NetBSD", "OpenBSD", "PClinuxOS", "QNX x86pc", "SunOS", "Ubuntu", "Mint", "Red Hat", "Slackware", "SUSE", "PCLinuxOS", "Debian", "Fedora", "CentOS", "Vine", "Arch Linux", "Gentoo", "Kanotix", "Mandriva"];
            for (var i = 0; i < pcOS.length; i++) {
                if (uaArg.indexOf(pcOS[i]) > -1) {return true;}
            }
            return false;
        }
        this.isMobileByOSList = function(uaArg) {
            var mobilephoneOS = ["Android", "AROS", "Bada", "BlackBerry", "Chromium", "CrOS", "Danger Hiptop", "Inferno", "iPhone", "iPad", "iPod", "Nintendo DS", "Nintendo Wii", "Palm OS", "PLAYSTATION", "Syllable", "SymbOS", "Symbian", "Tizen", "webOS", "WebTV", "Windows CE", "Windows Mobile", "Windows Phone", "Xbox"];
            for (var i = 0; i < mobilephoneOS.length; i++) {
                if (uaArg.indexOf(mobilephoneOS[i]) > -1) {return true;}
            }
            return false;
        }
        // 取得终端类型  0:不可识别 1:手机 2:PC 3:PC模拟的手机 4:平板
        // 1、通过platform及PC OS列表来判断是否是pc
        this.getTerminalType = function() {
            try {
                var ua = na.userAgent;
                if (!ua) {
                    // 如果ua不存在，直接返回0
                    return 0;
                }
                if (this.isPCByPlat() || this.isPCByOSList(ua)) {
                    // 判断为PC
                    if (this.isMobileByOSList(ua)) {
                        // 如果在移动终端列表里的话，则判断为模拟器
                        return 3;
                    } else {
                        if (ua.match(/.*MSIE.*Windows NT 6\.2;.*Touch\).*/)) {
                            // 专门针对window surface的UA判断
                            return 4;
                        }
                        // 否则为真正的pc
                        return 2;
                    }
                } else {
                    // 为移动终端
                    if (ua.indexOf("iPad") > -1 || Math.min(objBrowserInfo.getScreenWidth(),win.screen.height) >= 1000) {
                        // 如果是apple的平板,或者横竖分辨率最小的值大于等于1000，则判定为平板
                        return 4;
                    } else {
                        // 真正的手机
                        return 1;
                    }
                }
            } catch (ex) {
                return 0;
            }
        }
        // 取得分辨率宽度
        this.getScreenWidth = function() {
            try {
                var tmp = win.screen.width;
                return tmp ? isNaN(parseInt(tmp,10)) ? 0 : parseInt(tmp,10) : 0;
            } catch (ex) {
                return 0;
            }
        }
        // 取得分辨率高度
        this.getScreenHeight = function() {
            try {
                var tmp = win.screen.height;
                if((this.getTerminalType() == 1 && tmp > 2000)||(this.getTerminalType() == 4 && tmp > 3000)){
                    tmp = this.getViewHeight();
                }
                return tmp ? isNaN(parseInt(tmp,10)) ? 0 : parseInt(tmp,10) : 0;
            } catch (ex) {
                return 0;
            }
        }
        // 取得浏览器高度
        this.getBrowserHeight = function() {
            try {
                //var tmp = win.innerHeight ? win.innerHeight : doc.body.clientHeight;
                // var tmp = doc.documentElement.clientHeight ? doc.documentElement.clientHeight : doc.body.clientHeight;
                var tmp = win.innerHeight || doc.documentElement.clientHeight || doc.body.clientHeight;
                var quirksModeSid=['79574faf','42a5e638'];
                //FB-1480:该站点没有doctype,导致高度的计算有问题
                if(quirksModeSid.join(',').indexOf(sid)>-1){
                    tmp = win.innerHeight || doc.body.clientHeight|| doc.documentElement.clientHeight ;
                }
                return tmp ? isNaN(parseInt(tmp,10)) ? 0 : parseInt(tmp,10) : 0;
            } catch (ex) {
                return 0;
            }
        }
        // 取得滚动条的位置
        this.getScrollY = function() {
            var y = 0;
            try {
                y = doc.documentElement.scrollTop || win.pageYOffset;
                y = isNaN(y) ? 0 : y;
            } catch (ex) {
                y = 0;
            }
            return parseInt(y,10);
        }
        // 取得yMax的位置
        this.getYMax = function() {
            var value = +(this.getScrollY()) + +(this.getBrowserHeight());
            value = isNaN(value) ? 0 : parseInt(value, 10);
            return value;
        }
        // 取得滚动条的位置
        this.getScrollX = function() {
            var x = doc.documentElement.scrollLeft || win.pageXOffset;
            x = isNaN(x) ? 0 : x;
            return parseInt(x,10);
        }
        // 取得时区
        this.getTimezone = function() {
            try {
                var tmp = (new Date).getTimezoneOffset();
                return (tmp || tmp == 0) ? ("GMT" + (tmp <= 0 ? "+" : "") + (tmp / 60 * -1)) : "";
            } catch (ex) {
                return "";
            }
        }
        // 取得点击的来源tag
        this.getSrcElement = function(e) {
            var src = e.target || win.event.srcElement;
            return src;
        }
        //获取元素的绝对坐标
        this.getOffset = function(e){
            var offset ={ top: 0, left: 0 };
            //使用最新的计算方法（和jquery的一致）
            if( typeof e.getBoundingClientRect !== typeof undefined){
                var docElem = doc.documentElement;
                var docOffset = e.getBoundingClientRect();
                offset= {
                    top: docOffset.top  + ( win.pageYOffset || docElem.scrollTop )  - ( docElem.clientTop  || 0 ),
                    left: docOffset.left + ( win.pageXOffset || docElem.scrollLeft ) - ( docElem.clientLeft || 0 )
                };
            }else{//兼容旧版浏览器（不支持getBoundingClientRect 的浏览器）
                offset.top+=e.offsetTop;
                offset.left+=e.offsetLeft;
                if(e.offsetParent){
                    var parentOffset =  this.getOffset(e.offsetParent);
                    offset.top+=parentOffset.top;
                    offset.left+=parentOffset.left;
                }
                if(offset.top < 0){
                    offset.top = 0
                }
                if(offset.left < 0){
                    offset.left = 0
                }
                offset.top = isNaN(offset.top ) ? 0 : parseInt(offset.top ,10);
                offset.left = isNaN(offset.left ) ? 0 : parseInt(offset.left ,10);
            }
            offset.top = Math.round(offset.top);
            offset.left = Math.round(offset.left);
            return offset;
        }
        // 获取相对于页面内容的点击坐标
        this.getMouseRC = function(objEvent_) {
            var tmp = {x: 0,y: 0};
            try {
                tmp.x = objEvent_.touches[0].pageX ? objEvent_.touches[0].pageX : objEvent_.clientX;
                tmp.y = objEvent_.touches[0].pageY ? objEvent_.touches[0].pageY : objEvent_.clientY;
                switch (sid) {
                    case "7ba4a69b":
                        if (objEvent_.touches[0].clientY <= 110)
                            tmp.y = objEvent_.touches[0].clientY;
                        break;
                }
                if (!tmp.x)
                    tmp.x = 0;
                if (!tmp.y)
                    tmp.y = 0;
            } catch (ex) {
            }
            tmp.x = isNaN(tmp.x) ? 0 : parseInt(tmp.x,10);
            tmp.y = isNaN(tmp.y) ? 0 : parseInt(tmp.y,10);
            return tmp;
        }
        // 获取相对于页面内容的点击坐标
        this.getMouseRC1 = function(objEvent_) {
            var xValue = parseInt(+objEvent_.clientX + +this.getScrollX(),10);
            var yValue = parseInt(+objEvent_.clientY + +this.getScrollY(),10);
            xValue = isNaN(xValue) ? 0 : xValue;
            yValue = isNaN(yValue) ? 0 : yValue;
            return {
                x: xValue,
                y: yValue
            };
        }
        //取得页面内容实际宽度
        this.getPageWidth = function() {
            var value = parseInt(doc.body.scrollWidth,10);
            value = isNaN(value) ? 0 : value;
            return value;
        }
        // 取得页面内容实际高度
        this.getPageHeight = function() {
            var value = parseInt(doc.body.scrollHeight,10);
            value = isNaN(value) ? 0 : value;
            return value;
        }
        //取得页面可视宽度
        this.getViewWidth = function() {
            var value = self.innerWidth || doc.body.clientWidth;
            value = isNaN(value) ? 0 : parseInt(value,10);
            return value;
        }
        // 取得页面可视高度
        this.getViewHeight = function() {
            try {
                var value = self.innerHeight || doc.body.clientHeight;
                value = isNaN(value) ? 0 : parseInt(value,10);
                return value;
            } catch (ex) {
                return 0;
            }
        }
        // 获取初始缩放值
        this.getInitialScale = function() {
            try {
                var viewportContent = doc.getElementsByName("viewport")[0].content;
                if (viewportContent) {
                    return viewportContent.match("initial-scale=\\d.\\d+").toString().split("=")[1];
                } else {
                    return 1;
                }
            } catch (ex) {
                return 1;
            }
        }
		
		var browerType = this.browerType = function() {
			var ua = na.userAgent;
			var isIE = window.ActiveXObject != undefined && ua.indexOf("MSIE") != -1;
			var isFirefox = ua.indexOf("Firefox") != -1;
			var isOpera = window.opr != undefined;
			var isChrome = ua.indexOf("Chrome") && window.chrome;
			var isSafari = ua.indexOf("Safari") != -1 && ua.indexOf("Version") != -1;
			if (isIE) {
				return "IE";
			} else if (isFirefox) {
				return "Firefox";
			} else if (isOpera) {
				return "Opera";
			} else if (isChrome) {
				return "Chrome";
			} else if (isSafari) {
				return "Safari";
			} else {
				return "Unkown";
			}
		}();
		
		this.urlLengthLimit = function() {
			// 各浏览器对url长度的限制
			var browserUrlLimitDict = {
				IE: 2083,
				Firefox: 65536,
				Chrome: 8182,
				Safari: 80000,
				Opera: 190000,
				Unkown: 2083
			};
			
			return browserUrlLimitDict[browerType];
		}()
    }
    // Pt专用类模块
    function CLSPt() {
        // 判断功能是否开放
        this.valFunction = function(type, arg) {
            var tmp = "";
            try {
                switch (type) {
                    case "heatmap":
                        if (arg == -1) {
                            // 如果热图的值是-1，则对所有页面开放热图功能
                            return true;
                        } else if (!arg) {
                            // 如果热图页面为空，则关闭所有页面的热图功能
                            return false;
                        } else {
                            // 删除最后的/
                            var href = objBrowserInfo.setURLMerger(loc.href).replace(/\/*$/, "");
                            // FB-968
                            var minHref = href.split("?")[0].replace(/\/*$/, "") == href ? (href.split("#")[0].replace(/\/*$/, "") == href ? null : href.split("#")[0].replace(/\/*$/, "")) : href.split("?")[0].replace(/\/*$/, "");
                            for (var i = 0; i < arg.length; i++) {
                                tmp = arg[i];
                                // 如果匹配页面最后有/，则删除/
                                if (tmp) {
                                    tmp = objBrowserInfo.setURLMerger(tmp).replace(/\/*$/, "");
                                    tmp = tmp.split("?")[0].replace(/\/*$/, "") == tmp ? (tmp.split("#")[0].replace(/\/*$/, "") == tmp ? tmp : tmp.split("#")[0].replace(/\/*$/, "")) : tmp.split("?")[0].replace(/\/*$/, "");
                                }
                                if (href == tmp || minHref == tmp) {
                                    // 如果当前页面在开启热图功能的范围内
                                    return true;
                                }
                            }
                            return false;
                        }
                        break;
                    default:
                        break;
                }
            } catch (ex) {
            }
        }
        // 发送报文 如果times参数有值，则延时发送，如果没有则直接发送
        this.sendMsgByScript = function() {
			
			function scriptRequest(targetURL) {
				var url = targetURL + "&v=" + version + "&ts=" + (new Date()).getTime();
				
				if(url.length > objBrowserInfo.urlLengthLimit) {
					if(typeof console != 'undefined') {
						console.warn("The requested URL's length can't large than " + objBrowserInfo.urlLengthLimit);
					}
					return;
				}
				
				var script = doc.createElement('script');
				script.setAttribute('src', url);
				doc.getElementsByTagName('head')[0].appendChild(script);
			}
			
			return function(targetURL) {

				if (pvNum > 99) {
					return;
				}
				if (sid == "53942d99") {	//http://jira.ptmind.com/browse/FB-458 ,http地址替换为https[zhaopengjun 2015-03-25]
					targetURL = targetURL.replace(/^http:/,"https:");
				}
				//传统的跨域请求 开始
				scriptRequest(targetURL);
				//传统的跨域请求 结束

				if (testSID[sid]) {
					targetURL = targetURL.replace(sid,testSID[sid]).replace(/testcollect.ptengine.jp/, "collect.ptengine.jp");
					//传统的跨域请求 开始
					scriptRequest(targetURL);
				}			
			}
        }();
		
		
        // 发送报文 如果times参数有值，则延时发送，如果没有则直接发送
        this.sendMsg = function(targetURL) {
            if (pvNum > 99) {
                return;
            }
            if (sid == "53942d99") {	//http://jira.ptmind.com/browse/FB-458 ,http地址替换为https[zhaopengjun 2015-03-25]
                targetURL = targetURL.replace(/^http:/,"https:");
            }

			var url = targetURL + "&v=" + version + "&ts=" + (new Date()).getTime();
			
			if(url.length > objBrowserInfo.urlLengthLimit) {
				if(typeof console != 'undefined') {
					console.warn("The requested URL's length can't large than " + objBrowserInfo.urlLengthLimit);
				}
				return;
			}
			
            var tempImg = new Image();
            tempImg.src = url;
            if (testSID[sid]) {
                (new Image()).src = targetURL.replace(sid,testSID[sid]).replace(/testcollect.ptengine.jp/, "collect.ptengine.jp") + "&v="+version+"&ts=" + (new Date()).getTime();
            }
        }

        this.createCORSRequest = function (method, url) {
            var xhr = new win.XMLHttpRequest();
            if ("withCredentials" in xhr) {

                // "withCredentials"属性是XMLHTTPRequest2中独有的
                xhr.open(method, url, true);

            } else if (typeof XDomainRequest != "undefined") {
                // 检测是否XDomainRequest可用ie 8.9 中 使用XDomainRequest
                xhr = new win.XDomainRequest();
                xhr.open(method, url);

            } else {

                // 看起来CORS根本不被支持
                xhr = null;

            }
            return xhr;
        }
        this.sendPost = function (url, body) {
            var url = url ;
            var req = this.createCORSRequest('POST', url);
            if (req && body) {
                req.send(encodeURIComponent(body));
                return true;
            } else {
                return false;
            }
        }
        // css路径转化
        this.getCssPath = function(dom) {
            var domNodeName = dom.nodeName.toLowerCase();
            if (domNodeName == "body" || domNodeName == "html") {
                return "body";
            }
            else {
                var parentNode = dom.parentNode;
                //存在id时,用id标示元素
				if (dom.getAttribute("id")) {
					return this.getCssPath(parentNode) + '>' + "#" + dom.getAttribute("id");
				}
                //表单元素如果存在name 则用nodeName 和name来标示元素
                else if (domNodeName == "input" || domNodeName == "select" || domNodeName == "textarea" || domNodeName == "button") {
                    if (dom.getAttribute("name")) {
                        //return this.getCssPath(parentNode) + ">" + domNodeName + ":input[name='" + dom.getAttribute("name") + "']";
						
						var formNodes = parentNode.querySelectorAll(domNodeName + "[name='" + dom.getAttribute("name")+ "']");
						if(formNodes.length > 1) {	// 如果超过多个如radio, checkbox,加上eq(index)
							for(var i = 0; i < formNodes.length; i ++) {
								if(formNodes[i] == dom) {
									return this.getCssPath(parentNode) + ">" + domNodeName + ":input[name='" + dom.getAttribute("name") + "']:eq(" + i + ")";
								}
							}
						} else if(formNodes.length == 1) {
							return this.getCssPath(parentNode) + ">" + domNodeName + ":input[name='" + dom.getAttribute("name") + "']";
						}
                    }
                }

                //元素不存在id,表单元素也没有name时,用其在其父级元素中相同nodeName元素的index来标示元素
                var allChilds=[];
                for(var i=0;i<parentNode.children.length;i++){//获取父级元素下相同nodeName的所有元素
                    var child = parentNode.children[i];
                    if(child.nodeName && child.nodeName.toLowerCase() ==domNodeName) {
                        allChilds.push(child);
                    }
                }
                for (var i = 0; i < allChilds.length; i++) {
                    if (allChilds[i] == dom) {//找到元素在其父级元素下相同nodeName元素的index
                        return this.getCssPath(parentNode) + ">" + domNodeName + ":eq(" + i + ")";
                    }
                }
            }

        }
        // 旧版css路径转化,用来判断旧版事件
        this.getCssPathOld = function(dom) {
            var domNodeName = dom.nodeName.toLowerCase();
            if (domNodeName == "body" || domNodeName == "html") {
                return "body";
            }
            else if (dom.getAttribute("id")) {
                return "#" + dom.getAttribute("id");
            }
            else {
                var parentNode = dom.parentNode;
                var emptyDomCount = 0;
                ///如果爷爷节点和父节点类型相同，爷爷当父节点。网上倒
                while (domNodeName == parentNode.nodeName.toLowerCase()) {
                    if (parentNode.getAttribute("id")) {//如果本身有id就不往上倒了
                        break;
                    }
                    parentNode = parentNode.parentNode;
                }
                var allChilds = parentNode.getElementsByTagName(domNodeName);
                //如果父节点只有一个同类型的子节点，接着往上倒
                while (allChilds.length == 1) {
                    if (parentNode.getAttribute("id") || parentNode.nodeName.toLowerCase() == "body") {//如果本身有id就不往上倒了
                        break;
                    }
                    parentNode = parentNode.parentNode;
                    allChilds = parentNode.getElementsByTagName(domNodeName);
                }
                for (var i = 0; i < allChilds.length; i++) {
                    if (allChilds[i] == dom) {
                        if (domNodeName == "input" || domNodeName == "select" || domNodeName == "textarea" || domNodeName == "button") {
                            if (dom.getAttribute("name")) {
                                //return this.getCssPathOld(parentNode) + " " + domNodeName + ":input[name='" + dom.getAttribute("name") + "']";
								
								var formNodes = parentNode.querySelectorAll(domNodeName + "[name='" + dom.getAttribute("name")+ "']");
								if(formNodes.length > 1) {	// 如果超过多个如radio, checkbox,加上eq(index)
									for(var i = 0; i < formNodes.length; i ++) {
										if(formNodes[i] == dom) {
											return this.getCssPathOld(parentNode) + ">" + domNodeName + ":input[name='" + dom.getAttribute("name") + "']:eq(" + i + ")";
										}
									}
								} else if(formNodes.length == 1) {
									return this.getCssPathOld(parentNode) + ">" + domNodeName + ":input[name='" + dom.getAttribute("name") + "']";
								}
                            }
                        }
                        return this.getCssPathOld(parentNode) + " " + domNodeName + ":eq(" + (i - emptyDomCount) + ")";
                        break;
                    }
                }
            }
        }
        // 找到是A的父节点
        this.parentA =function(dom){
            while(dom.nodeName.toLowerCase()!="body") {
                if(dom.nodeName.toLowerCase()=="a"){
                    return dom;
                }
                else{
                    dom = dom.parentNode;
                }
            }
            return false;
        }
    }
    function CookieOfPt() {
        this.cookiesValue="";
        this.syncSharedStorage = function(){
            var cookieNum = Math.floor(pageList.length / 3800);
            var objNeedSync = {
                uid:uid,
                nid:isNID,
                vid:visitID,
                vn:visitNum,
                pvn:pvNum,
                to_flag:toFlag,
                pl:pageList
            }
            if(cookieNum > 0){
                objNeedSync['cn'] = cookieNum
            }
            console.log('sync write to localstorage start');
            messageClient && messageClient.set(keyForITP(),objNeedSync,function(res){
                console.log('write done!');
            })
        };
        this.writeCookies = function(){
            if (hasHttpCookies) {
                this.cookiesValue = this.createCookiesValue();
                objHttpCookies.setValue(COOKIESNAME, this.cookiesValue, {
                    expires: expiresDay
                });
                isSafariAndAppliedITP() && this.syncSharedStorage();
            }
            this.readCookies();
        }
        this.readCookies = function(){
            if (hasHttpCookies) {
                this.cookiesValue = objHttpCookies.getValue(COOKIESNAME);
            }
        }
        // 判断是否是刷新的页面
        this.getIsRefresh = function(visitTime) {
            if ((this.cookiesValue.indexOf(pageID) > -1) && !objCommon.timeCompare_M(this.getValueFromCookies("sact"), visitTime, REFRESHTIMES)) {
                // 如果页面相同并且当前时间距离上次活动时间不到指定时间的话，则判断为刷新
                return 1;
            } else {
                return 0;
            }
        }
        // 判断该访次的属性：0为非新访次，1为新访次
        this.getIsNV = function(visitTime) {
            if (sessionCookieFlag == 0 && !funnelPage) {
                // http cookies启用，并且sessionCookie不存在，则判断为新访次
                return 1;
            }
            if (objCommon.timeCompare_M(this.getValueFromCookies("sact"), visitTime, NVTIMES) && !funnelPage) {
                // 如果当前时间距离上次活动时间超过指定时间的话，则判断为新访次
                return 1;
            }
            if (this.getValueFromCookies("to_flag") == 1 && !funnelPage) {
                // 上一次访次因为静默超时被关闭了，则判断为新访次
                return 1;
            }

            return 0;
        }
        // 判断新旧访者
        this.getIsNID = function() {
            // 取得当前NID值
            var tmp = this.getValueFromCookies("nid");
            if (tmp == "1") {
                tmp = 0;
            }
            return tmp;
        }
        // 判断当前页面是否激活
        this.isActive = function() {
            return this.getValueFromCookies("pl") == pageID + "*pt*" + pageAccessTime;
        }
        // 判断当前页面是否激活
        this.isNewVisit = function(oldVID, recentTime) {
            return (this.getValueFromCookies("vid") != oldVID) && (+recentTime >= +this.getValueFromCookies("sact"));
        }
        // 创建cookie
        this.createCookiesValue = function() {
            var cookieNum = Math.floor(pageList.length / 3800);
            var value = "uid=" + uid
                + "&nid=" + isNID
                + "&vid=" + visitID
                + "&vn=" + visitNum
                + "&pvn=" + pvNum
                + "&sact=" + siteActionTime
                + "&to_flag=" + toFlag
                + ((+cookieNum > 0) ? ("&cn=" + cookieNum) : "")
                + "&pl=" + pageList;

            return value;
        }
        // 确认cookie的完整性
        this.checkCookiesValue = function() {
            var cookieTag = ["uid","nid","vid","vn","sact","to_flag","pl"];
            for(var i=0;i<cookieTag.length;i++){
                if(this.cookiesValue.indexOf(cookieTag[i])<0){return false;}
            }
            return true;
        }
        // 根据参数名，从cookies里取得参数值
        this.getValueFromCookies = function(arg) {
            try {
                if (arg == "pl") {
                    return (this.cookiesValue.indexOf(arg) != -1) ? this.cookiesValue.split(arg + "=")[1] : "";
                } else {
                    var str =  (this.cookiesValue.indexOf(arg) != -1) ? this.cookiesValue.split(arg + "=")[1].split("&")[0] : "";
                    if (arg == "pvn") {
                        str = isNaN(str) ? 0 : str;
                    }
                    return str;
                }
            } catch (ex) {
                return "";
            }
        }
        // 记录当前激活页面
        this.plPrc = function(page_id) {
            var page_now = page_id + "*pt*" + pageAccessTime;
            return page_now;
        }
    }
    // 通用模块
    function CLSCommon() {
        this.addLoadEvent = function(iframe,func) {
            var oldonload = iframe.onload;//得到上一个onload事件的函数
            if (typeof iframe.onload != 'function') {//判断类型是否为'function',注意typeof返回的是字符串
                iframe.onload = func;
            } else {
                iframe.onload = function(){
                    oldonload();//调用之前覆盖的onload事件的函数---->由于我对js了解不多,这里我暂时理解为通过覆盖onload事件的函数来实现加载多个函数
                    func();//调用当前事件函数
                }
            }
        }
        // 判断行为：大于某个时间长度
        this.timeCompare_M = function(prevTime, visitTime, times) {
            return +visitTime - +prevTime > +times;
        }
        // URI加密 如果f为true,用encodeURI, false的话用encodeURIComponent 如果不支持前两者,用escape
        this.encode = function(i, f) {
            return encodeURIComponent instanceof Function ? (f ? encodeURI(i) : encodeURIComponent(i)) : escape(i)
        }
        // URI解密
        this.decode = function(i, f) {
            var tmp = "";
            i = i.split("+").join(" ");
            if (decodeURIComponent instanceof Function)
                try {
                    tmp = f ? decodeURI(i) : decodeURIComponent(i)
                } catch (ex) {
                    tmp = unescape(i)
                }
            else
                tmp = unescape(i);
            return tmp;
        }
        // 判断是否为空
        this.isNull = function(i) {
            return undefined == i || "null" == i || -1 == i || "" == i;
        }
        // 前后去空白
        this.trim = function(value) {
            return value.replace(/(^\s*)/g, "").replace(/(\s*$)/g, "");
        }
        // 将二进制字符串进行BASE64编码
        //1、Url进行md5，得到一个128位的二进制串A
        //2、对A进行base64编码得到24个字符长的B
        //3、删除字符B最后的二个"="，得到22个字符长度的C
        this.base64encodeForBin = function(binStr) {
            var base64EncodeChars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-/";
            var out = "", i = 0;
            while (i < binStr.length / 6 - 1) {
                out += base64EncodeChars.charAt(parseInt(binStr.slice(i * 6, (i + 1) * 6), 2).toString(10));
                i++;
            }
            var tail = binStr.slice(i * 6, (i + 1) * 6)
            if (tail) {
                var len = tail.length;
                for (i = 0; i < (6 - len); i++) {
                    tail += "0";
                }
                out += base64EncodeChars.charAt(parseInt(tail, 2).toString(10));
            }
            //return out.replace(/\//g, "-");
            return out;
        }
        // 将十六进制的字符串转成二进制的字符串
        this.Hex2Bin = function(hex) {
            var bin = "", tmp = "", len = 0, tmpLength = hex.length;
            for (var i = 0; i < tmpLength; i++) {
                tmp = parseInt(hex.charAt(i), 16).toString(2);
                len = tmp.length;
                for (var j = 0; j < (4 - len); j++) {
                    tmp = "0" + tmp;
                }
                bin += tmp;
            }
            return bin;
        }
        // 输入Pt特有的ID串
        this.createID = function(message) {
            return this.base64encodeForBin(this.Hex2Bin(this.MD5(message)));
        }
        //md5模块-开始
        this.MD5 = function(sMessage) {
            var type = 32;//md5长度，这个值只被这一个函数使用，所以没必要放在外层作用域里面
            var jsMD5_Typ = type;
            function RotateLeft(lValue, iShiftBits) {
                return (lValue << iShiftBits) | (lValue >>> (32 - iShiftBits));
            }
            function AddUnsigned(lX, lY) {
                var lX4, lY4, lX8, lY8, lResult;
                lX8 = (lX & 0x80000000);
                lY8 = (lY & 0x80000000);
                lX4 = (lX & 0x40000000);
                lY4 = (lY & 0x40000000);
                lResult = (lX & 0x3FFFFFFF) + (lY & 0x3FFFFFFF);
                if (lX4 & lY4)
                    return (lResult ^ 0x80000000 ^ lX8 ^ lY8);
                if (lX4 | lY4) {
                    if (lResult & 0x40000000)
                        return (lResult ^ 0xC0000000 ^ lX8 ^ lY8);
                    else
                        return (lResult ^ 0x40000000 ^ lX8 ^ lY8);
                } else
                    return (lResult ^ lX8 ^ lY8);
            }
            function F(x, y, z) {return (x & y) | ((~x) & z);}
            function G(x, y, z) {return (x & z) | (y & (~z));}
            function H(x, y, z) {return (x ^ y ^ z);}
            function I(x, y, z) {return (y ^ (x | (~z)));}
            function FF(a, b, c, d, x, s, ac) {
                a = AddUnsigned(a, AddUnsigned(AddUnsigned(F(b, c, d), x), ac));
                return AddUnsigned(RotateLeft(a, s), b);
            }
            function GG(a, b, c, d, x, s, ac) {
                a = AddUnsigned(a, AddUnsigned(AddUnsigned(G(b, c, d), x), ac));
                return AddUnsigned(RotateLeft(a, s), b);
            }
            function HH(a, b, c, d, x, s, ac) {
                a = AddUnsigned(a, AddUnsigned(AddUnsigned(H(b, c, d), x), ac));
                return AddUnsigned(RotateLeft(a, s), b);
            }
            function II(a, b, c, d, x, s, ac) {
                a = AddUnsigned(a, AddUnsigned(AddUnsigned(I(b, c, d), x), ac));
                return AddUnsigned(RotateLeft(a, s), b);
            }
            function ConvertToWordArray(sMessage) {
                var lWordCount;
                var lMessageLength = sMessage.length;
                var lNumberOfWords_temp1 = lMessageLength + 8;
                var lNumberOfWords_temp2 = (lNumberOfWords_temp1 - (lNumberOfWords_temp1 % 64)) / 64;
                var lNumberOfWords = (lNumberOfWords_temp2 + 1) * 16;
                var lWordArray = Array(lNumberOfWords - 1);
                var lBytePosition = 0;
                var lByteCount = 0;
                while (lByteCount < lMessageLength) {
                    lWordCount = (lByteCount - (lByteCount % 4)) / 4;
                    lBytePosition = (lByteCount % 4) * 8;
                    lWordArray[lWordCount] = (lWordArray[lWordCount] | (sMessage.charCodeAt(lByteCount) << lBytePosition));
                    lByteCount++;
                }
                lWordCount = (lByteCount - (lByteCount % 4)) / 4;
                lBytePosition = (lByteCount % 4) * 8;
                lWordArray[lWordCount] = lWordArray[lWordCount] | (0x80 << lBytePosition);
                lWordArray[lNumberOfWords - 2] = lMessageLength << 3;
                lWordArray[lNumberOfWords - 1] = lMessageLength >>> 29;

                return lWordArray;
            }
            function WordToHex(lValue) {
                var WordToHexValue = "", WordToHexValue_temp = "", lByte, lCount;
                for (lCount = 0; lCount <= 3; lCount++) {
                    lByte = (lValue >>> (lCount * 8)) & 255;
                    WordToHexValue_temp = "0" + lByte.toString(16);
                    WordToHexValue = WordToHexValue + WordToHexValue_temp.substr(WordToHexValue_temp.length - 2, 2);
                }
                return WordToHexValue;
            }
            var x = Array();
            var k, AA, BB, CC, DD, a, b, c, d
            var S11 = 7, S12 = 12, S13 = 17, S14 = 22;
            var S21 = 5, S22 = 9, S23 = 14, S24 = 20;
            var S31 = 4, S32 = 11, S33 = 16, S34 = 23;
            var S41 = 6, S42 = 10, S43 = 15, S44 = 21;
            // Steps 1 and 2. Append padding bits and length and convert to words
            x = ConvertToWordArray(sMessage);
            // Step 3. Initialise
            a = 0x67452301;
            b = 0xEFCDAB89;
            c = 0x98BADCFE;
            d = 0x10325476;
            // Step 4. Process the message in 16-word blocks
            for (k = 0; k < x.length; k += 16) {
                AA = a;
                BB = b;
                CC = c;
                DD = d;
                a = FF(a, b, c, d, x[k + 0], S11, 0xD76AA478);
                d = FF(d, a, b, c, x[k + 1], S12, 0xE8C7B756);
                c = FF(c, d, a, b, x[k + 2], S13, 0x242070DB);
                b = FF(b, c, d, a, x[k + 3], S14, 0xC1BDCEEE);
                a = FF(a, b, c, d, x[k + 4], S11, 0xF57C0FAF);
                d = FF(d, a, b, c, x[k + 5], S12, 0x4787C62A);
                c = FF(c, d, a, b, x[k + 6], S13, 0xA8304613);
                b = FF(b, c, d, a, x[k + 7], S14, 0xFD469501);
                a = FF(a, b, c, d, x[k + 8], S11, 0x698098D8);
                d = FF(d, a, b, c, x[k + 9], S12, 0x8B44F7AF);
                c = FF(c, d, a, b, x[k + 10], S13, 0xFFFF5BB1);
                b = FF(b, c, d, a, x[k + 11], S14, 0x895CD7BE);
                a = FF(a, b, c, d, x[k + 12], S11, 0x6B901122);
                d = FF(d, a, b, c, x[k + 13], S12, 0xFD987193);
                c = FF(c, d, a, b, x[k + 14], S13, 0xA679438E);
                b = FF(b, c, d, a, x[k + 15], S14, 0x49B40821);
                a = GG(a, b, c, d, x[k + 1], S21, 0xF61E2562);
                d = GG(d, a, b, c, x[k + 6], S22, 0xC040B340);
                c = GG(c, d, a, b, x[k + 11], S23, 0x265E5A51);
                b = GG(b, c, d, a, x[k + 0], S24, 0xE9B6C7AA);
                a = GG(a, b, c, d, x[k + 5], S21, 0xD62F105D);
                d = GG(d, a, b, c, x[k + 10], S22, 0x2441453);
                c = GG(c, d, a, b, x[k + 15], S23, 0xD8A1E681);
                b = GG(b, c, d, a, x[k + 4], S24, 0xE7D3FBC8);
                a = GG(a, b, c, d, x[k + 9], S21, 0x21E1CDE6);
                d = GG(d, a, b, c, x[k + 14], S22, 0xC33707D6);
                c = GG(c, d, a, b, x[k + 3], S23, 0xF4D50D87);
                b = GG(b, c, d, a, x[k + 8], S24, 0x455A14ED);
                a = GG(a, b, c, d, x[k + 13], S21, 0xA9E3E905);
                d = GG(d, a, b, c, x[k + 2], S22, 0xFCEFA3F8);
                c = GG(c, d, a, b, x[k + 7], S23, 0x676F02D9);
                b = GG(b, c, d, a, x[k + 12], S24, 0x8D2A4C8A);
                a = HH(a, b, c, d, x[k + 5], S31, 0xFFFA3942);
                d = HH(d, a, b, c, x[k + 8], S32, 0x8771F681);
                c = HH(c, d, a, b, x[k + 11], S33, 0x6D9D6122);
                b = HH(b, c, d, a, x[k + 14], S34, 0xFDE5380C);
                a = HH(a, b, c, d, x[k + 1], S31, 0xA4BEEA44);
                d = HH(d, a, b, c, x[k + 4], S32, 0x4BDECFA9);
                c = HH(c, d, a, b, x[k + 7], S33, 0xF6BB4B60);
                b = HH(b, c, d, a, x[k + 10], S34, 0xBEBFBC70);
                a = HH(a, b, c, d, x[k + 13], S31, 0x289B7EC6);
                d = HH(d, a, b, c, x[k + 0], S32, 0xEAA127FA);
                c = HH(c, d, a, b, x[k + 3], S33, 0xD4EF3085);
                b = HH(b, c, d, a, x[k + 6], S34, 0x4881D05);
                a = HH(a, b, c, d, x[k + 9], S31, 0xD9D4D039);
                d = HH(d, a, b, c, x[k + 12], S32, 0xE6DB99E5);
                c = HH(c, d, a, b, x[k + 15], S33, 0x1FA27CF8);
                b = HH(b, c, d, a, x[k + 2], S34, 0xC4AC5665);
                a = II(a, b, c, d, x[k + 0], S41, 0xF4292244);
                d = II(d, a, b, c, x[k + 7], S42, 0x432AFF97);
                c = II(c, d, a, b, x[k + 14], S43, 0xAB9423A7);
                b = II(b, c, d, a, x[k + 5], S44, 0xFC93A039);
                a = II(a, b, c, d, x[k + 12], S41, 0x655B59C3);
                d = II(d, a, b, c, x[k + 3], S42, 0x8F0CCC92);
                c = II(c, d, a, b, x[k + 10], S43, 0xFFEFF47D);
                b = II(b, c, d, a, x[k + 1], S44, 0x85845DD1);
                a = II(a, b, c, d, x[k + 8], S41, 0x6FA87E4F);
                d = II(d, a, b, c, x[k + 15], S42, 0xFE2CE6E0);
                c = II(c, d, a, b, x[k + 6], S43, 0xA3014314);
                b = II(b, c, d, a, x[k + 13], S44, 0x4E0811A1);
                a = II(a, b, c, d, x[k + 4], S41, 0xF7537E82);
                d = II(d, a, b, c, x[k + 11], S42, 0xBD3AF235);
                c = II(c, d, a, b, x[k + 2], S43, 0x2AD7D2BB);
                b = II(b, c, d, a, x[k + 9], S44, 0xEB86D391);
                a = AddUnsigned(a, AA);
                b = AddUnsigned(b, BB);
                c = AddUnsigned(c, CC);
                d = AddUnsigned(d, DD);
            }
            var TypNN;
            if (jsMD5_Typ == '16'){TypNN = WordToHex(b) + WordToHex(c);}
            if (jsMD5_Typ == '32'){TypNN = WordToHex(a) + WordToHex(b) + WordToHex(c) + WordToHex(d);}
            return TypNN;
        };
		
		// 按字节长度截取字符串(一个双字节如汉字按两个计算)
		this.substringByByte = function(str, num) {
			var index = 0;
			for(var i = 0, len = str.length; i < len; i ++) {
				/[\x00-\xff]/.test(str[i]) ? index ++ : index += 2;
				if(index == num) {
					return str.substring(0, i + 1);
				}
				if(index > num) {
					return str.substring(0, i);
				}
			}
			return str;
		};
    }

    //新版事件新增方法 开始
    /**
     * 根据选择器与text内容获取对应的元素,返回一个数组
     * @param selector
     * @param text
     * @returns {Array}
     * @private
     */
    function _queryElements( selector, text){

        //对新版事件的选择器进行 decode
        selector = objCommon.decode(selector);

        //获取选择器的元素
        var elementArray;

        try {
            elementArray = doc.querySelectorAll ? doc.querySelectorAll(selector) : _querySelectorAll(selector);
        }catch (e){
            //IE8 虽然支持 querySelectorAll , 但不支持 css3 选择器的语法 , 所以遇到 :nth-child 会报错
            elementArray = _querySelectorAll(selector);
        }

        var elements = [],
            elem;
        //筛选 符合text属性
        if(text === undefined || text === ""){
            //不要求筛选 text ,直接返回整个数组
            elements = elementArray;
        }else{
            for(var i = 0, arrLength = elementArray.length; i < arrLength; i++) {
                elem = elementArray[i];
                objCommon.MD5(elem.text || "") === text ? elements.push(elem) : "";
            }
        }

        return elements;
    }

    /**
     * 兼容 IE8, IE7,IE6下的doc.querySelectorAll 方法
     *
     * !!!此方法只适合 新版事件 生成的选择器!!!
     *
     * body > div:nth-child(1) > a:nth-child(1)
     * #Layer1 > div:nth-child(8) div
     * #container a.themebutton2[a='a']
     * a[a='a']
     *
     * @param selector
     * @param parent 调用时为空, 此字段递归使用
     * @returns {Array}
     * @private
     */
    function _querySelectorAll( selector, parent) {

        var elements = [];   //存放符合的元素

        var hasChild;

        selector = selector || [];
        parent = parent || doc;
        if(typeof selector === "string"){
            //将选择器拆分成数组 例如 "a > b > c"
            selector = selector.split(/\s|>/);
        }

        if(selector.length === 0){
            return [];
        }

        //取出第一个 匹配选择器
        var match = selector.shift();

        while(!match && selector.length > 0){
            //如果取出来的第一个是 个 false 值, 继续下一个查找
            match = selector.shift();
        }

        if(!match){
            return [];
        }

        //是否还有子元素
        hasChild = selector.length !== 0;

        var index = -1,     // 如 : div:nth-child(2), 这里的 index = 2
            hasNthChild = match.match(/:nth-child\(\d\)/);   // 是否含有 :nth-child

        //如果含有  :nth-child, 获取下标
        if(hasNthChild){
            var nthChild = hasNthChild[0],
                matchTagName = match.match(/[^:]*/g)[0];

            //获取 nth-child(\d) 中的 \d
            index = +nthChild.match(/\d/)[0];

            // :nth-children(index) 中的 index,是从1开始的
            var child = parent.children[index - 1];

            //如果 child 是空 或者 Child 与选择器的 nodeName 不匹配
            if(!child || child.nodeName.toLowerCase() !== matchTagName){
                return [];
            }

            //如果还有子元素选择器, 继续回调
            if(hasChild){
                return _querySelectorAll(selector, child);
            }else{
                elements.push(child);
                return elements;
            }

        }else{

            var arrTemp,    //缓存数组迭代元素
                elemArr = [],   //缓存元素数组
                i,len,      //外层循环
                j,inLen, elem;    //内层循环

            //这里的 match 函数操作后 返回的是一个数组
            var tag = match.match(/[^#\.:\[]*/),     //nodeName
                id = match.match(/#[^.:\[]*/),          //id
                classes = match.match(/\.[^#:\[]*/),    //class
                data = match.match(/\[[^#:\.]*/);       //属性

            tag && (tag = tag[0]);
            id && (id = id[0]);
            classes && (classes = classes[0]);
            data && (data = data[0]);

            if(id){
                id = id.replace("#", "");

                elem = doc.getElementById(id);
                elem && elements.push(elem);
            }

            if(tag){

                //如果 ID 不存在
                if(!id){
                    //使用 tag 选择器
                    if(parent.querySelectorAll){
                        elements = parent.querySelectorAll(tag);
                    }else{
                        elements = parent.getElementsByTagName(tag);
                    }
                }
            }

            if(classes){

                //如果 id 并且 tag 都不存在
                if(!id && !tag){
                    /** id 与 tag 不存在, 使用 class 选择元素 */
                    if(parent.querySelectorAll){
                        elements = parent.querySelectorAll(classes);
                    }else if(parent.getElementsByClassName){
                        //classes.replace(/\./g, " ") = ".a.b.c" => "a b c";
                        elements = parent.getElementsByClassName(classes.replace(/\./g, " "));
                    }else{
                        //IE7 下不支持 doc.getElementsByClassName, 先获取 parent 下面所有的
                        elements = parent.getElementsByTagName("*");
                    }
                }

            }

            if(data){

                if(!id && !tag && !classes){
                    if(parent.querySelectorAll){
                        elements = parent.querySelectorAll(data);
                    }
                }
            }

            var classArr  = classes ? classes.split(/\./) : [], // classArr => ["a", "b"];
                dataArr = data ? data.split(/\[|]/g) : [],      // dataArr =>
                classReg,       //class 的正则
                dataNode,       //属性节点 => ['data-lang','abc'];
                dataValue,      //属性 value => abc, 这个值会处理
                isMatch;   //class 是否匹配
            //筛选元素
            for(i = 0, len = elements.length; i < len; i++ ){

                arrTemp = elements[i];

                //tag 是否符合
                if(tag && arrTemp.nodeName.toLowerCase() !== tag){
                    continue;
                }

                isMatch = !0;

                //class 是否符合
                if(classes){
                    var className =" " + arrTemp.className + " ";   //两头添加空格, 便于正则去匹配

                    for(j = 0, inLen = classArr.length; j < inLen; j++){
                        if(!classArr[j]){
                            continue;
                        }

                        //生成正则
                        classReg = new RegExp("\\s" + classArr[j] + "\\s");

                        if(!classReg.test(className)){
                            isMatch = !1;
                            break;
                        }
                    }

                    //跳过这次 elements 循环
                    if(!isMatch){
                        continue;
                    }
                }

                //判断 data 是否符合
                if(data){

                    for(j = 0, inLen = dataArr.length; j < inLen; j++){
                        if(!dataArr[j]){
                            continue;
                        }

                        dataNode = dataArr[j].split("=");

                        //去除两头的单引号
                        dataNode[1] = dataNode[1].replace(/^'|'$/g, "");

                        dataValue = arrTemp.getAttribute(dataNode[0]);

                        //将内容中的单引号作替换
                        dataValue && (dataValue = dataValue.replace(/'/g, "\\'"));

                        if(dataValue !== dataNode[1]){
                            isMatch = !1;
                            break;
                        }
                    }

                    if(!isMatch){
                        continue;
                    }
                }

                //所有条件都符合
                elemArr.push(arrTemp);
            }

            elements = elemArr;

            if(hasChild){
                return _querySelectorAll(selector, elements[0]);
            }else{
                return elements;
            }
        }
    }

    //新版事件新增方法 结束
})();
